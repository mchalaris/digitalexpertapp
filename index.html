/** =========================
 *  CONFIG
 * ========================== */

// üëâ ŒíŒ¨ŒªŒµ ŒµŒ¥œé œÑŒø ID œÑŒøœÖ Œ≤Œ±œÉŒπŒ∫Œøœç œÜŒ±Œ∫Œ≠ŒªŒøœÖ œÉœÑŒø Google Drive
const ROOT_FOLDER_ID = '1Um5SQjqP7jTWK1xhaS8s5CNxEFtqYEXZ';

// üëâ ŒíŒ¨ŒªŒµ ŒµŒ¥œé œÑŒø ID œÑŒøœÖ Spreadsheet œÄŒøœÖ Œ∏Œ± Œ∫œÅŒ±œÑŒ¨ ŒüŒõŒë œÑŒ± logs & œÑŒøœÖœÇ œÑŒµœáŒΩŒπŒ∫ŒøœçœÇ
// Œ†œÅŒ≠œÄŒµŒπ ŒΩŒ± Œ≠œáŒµŒπ 2 œÜœçŒªŒªŒ±: UPLOAD_LOG Œ∫Œ±Œπ TECHS (œÑŒø TECHS Œ∏Œ± Œ¥Œ∑ŒºŒπŒøœÖœÅŒ≥Œ∑Œ∏ŒµŒØ Œ±ŒΩ Œ¥ŒµŒΩ œÖœÄŒ¨œÅœáŒµŒπ)
const LOG_SHEET_ID   = '1zJBNP8tlSDuvCcIipjyrg5cBAuNMHmFTkPCdnLw5ePk';
const LOG_SHEET_NAME = 'UPLOAD_LOG';
const TECHS_SHEET_NAME = 'TECHS';

const CFG = {
  ENABLE_LOGS: true,      // Œ≤Œ¨ŒªŒµ false Œ±ŒΩ Œ¥ŒµŒΩ Œ∏Œ≠ŒªŒµŒπœÇ logs
  IDEM_TTL_DAYS: 7,       // Œ∑ŒºŒ≠œÅŒµœÇ Œ¥ŒπŒ±œÑŒÆœÅŒ∑œÉŒ∑œÇ idempotency keys
  DEST_SUBFOLDERS: true   // Œ±œÄŒøŒ∏ŒÆŒ∫ŒµœÖœÉŒ∑ œÉŒµ œÖœÄŒøœÜŒ¨Œ∫ŒµŒªŒø Œ±ŒΩŒ¨ destination
};


/** =========================
 *  DRIVE HELPERS
 * ========================== */
function getRootFolder_() {
  try { return DriveApp.getFolderById(ROOT_FOLDER_ID); }
  catch (e) { return DriveApp; }
}
function getFolderByNameInParent_(parent, name) {
  const it = parent.getFoldersByName(name);
  return it.hasNext() ? it.next() : null;
}
function ensureSubpath_(parent, subpath) {
  const parts = String(subpath||'').split('/').filter(Boolean);
  let cur = parent;
  for (const p of parts) {
    let f = getFolderByNameInParent_(cur, p);
    if (!f) f = cur.createFolder(p);
    cur = f;
  }
  return cur;
}
function findSrFolder_(root, sr) {
  const it = root.getFoldersByName(sr);
  return it.hasNext() ? it.next() : null;
}
function ensureSrFolderBases_(root, sr) {
  let folder = findSrFolder_(root, sr);
  if (!folder) folder = root.createFolder(sr);
  
  // ŒàŒªŒµŒ≥œáŒøœÇ Œ±ŒΩ œÖœÄŒ¨œÅœáŒµŒπ ŒÆŒ¥Œ∑ Œø œÜŒ¨Œ∫ŒµŒªŒøœÇ œÄœÅŒπŒΩ Œ¥Œ∑ŒºŒπŒøœÖœÅŒ≥ŒÆœÉŒµŒπœÇ
  const subfolders = ['Œ£ŒßŒïŒîŒôŒë', 'PHOTOS', 'ŒúŒïŒ§Œ°ŒóŒ£ŒïŒôŒ£', 'PHOTOS/BEP'];
  subfolders.forEach(sub => {
    const parts = sub.split('/');
    let current = folder;
    for (const part of parts) {
      const existing = getFolderByNameInParent_(current, part);
      if (!existing) {
        current = current.createFolder(part);
      } else {
        current = existing;
      }
    }
  });
  
  return folder;
}


/** =========================
 *  JSON OUT
 * ========================== */
function jsonOut_(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}


/** =========================
 *  MIME / GEO
 * ========================== */
function guessMime_(filename) {
  const n = String(filename||'').toLowerCase();
  if (n.endsWith('.jpg') || n.endsWith('.jpeg')) return 'image/jpeg';
  if (n.endsWith('.png')) return 'image/png';
  if (n.endsWith('.heic')) return 'image/heic';
  if (n.endsWith('.webp')) return 'image/webp';
  if (n.endsWith('.pdf')) return 'application/pdf';
  if (n.endsWith('.txt')) return 'text/plain';
  return 'application/octet-stream';
}
function geoToString_(geo) {
  if (!geo) return '';
  const lat = geo.lat != null ? Number(geo.lat).toFixed(6) : '';
  const lng = geo.lng != null ? Number(geo.lng).toFixed(6) : '';
  const acc = geo.accuracy != null ? Number(geo.accuracy).toFixed(0) : '';
  return [lat, lng, acc].filter(Boolean).join(',');
}


/** =========================
 *  IDEMPOTENCY (dedupe)
 * ========================== */
function markSeen_(idem) {
  if (!idem) return;
  const store = PropertiesService.getScriptProperties();
  store.setProperty('idem::'+idem, String(Date.now()));
  cleanupIdem_(store);
}
function wasSeen_(idem) {
  if (!idem) return false;
  const store = PropertiesService.getScriptProperties();
  return !!store.getProperty('idem::'+idem);
}
function cleanupIdem_(store) {
  try {
    const props = store.getProperties();
    const ttl = CFG.IDEM_TTL_DAYS * 24 * 60 * 60 * 1000;
    const now = Date.now();
    let c=0;
    for (var k in props) {
      if (k.indexOf('idem::')===0) {
        const t = Number(props[k]||0);
        if (!isNaN(t) && now - t > ttl) {
          store.deleteProperty(k);
          c++;
          if (c>100) break;
        }
      }
    }
  } catch (_){}
}


/** =========================
 *  LOGGING (1 œÜœçŒªŒªŒø, 1 Œ±œÅœáŒµŒØŒø)
 * ========================== */
function getLogSheet_() {
  const ss = SpreadsheetApp.openById(LOG_SHEET_ID);
  let sh = ss.getSheetByName(LOG_SHEET_NAME);
  if (!sh) {
    const target = LOG_SHEET_NAME.trim().toUpperCase();
    const found = ss.getSheets().find(s => s.getName().trim().toUpperCase() === target);
    sh = found || ss.insertSheet(LOG_SHEET_NAME);
  }
  ensureLogHeader_(sh);
  return sh;
}
function ensureLogHeader_(sh) {
  const header = ['TS','SR','TECH','FILENAME','SIZE','MIME','STEP_ID','DEST','GEO','IDEM','PATH'];
  if (sh.getLastRow() === 0) { sh.appendRow(header); return; }
  const existing = sh.getRange(1, 1, 1, header.length).getValues()[0];
  if (existing.join('|') !== header.join('|')) {
    sh.insertRowBefore(1);
    sh.getRange(1, 1, 1, header.length).setValues([header]);
  }
}
function logUpload_(row) {
  try {
    const sh = getLogSheet_();
    sh.appendRow([
      row.ts, row.srName, row.techName, row.fileName, row.size, row.mime,
      row.stepId, row.destinations, row.geo, row.idem, row.path||''
    ]);
  } catch (err) {
    Logger.log('logUpload_ error: ' + err);
  }
}


/** =========================
 *  TECHS (dropdown Œ±œÄœå Sheet)
 * ========================== */
function getTechs_(roleOpt) {
  const ss = SpreadsheetApp.openById(LOG_SHEET_ID);
  let sh = ss.getSheetByName(TECHS_SHEET_NAME);
  if (!sh) {
    sh = ss.insertSheet(TECHS_SHEET_NAME);
    sh.appendRow(['NAME','ROLE','ACTIVE']);
  }
  const rows = sh.getDataRange().getValues();
  const out = [];
  const wanted = roleOpt ? String(roleOpt).trim().toUpperCase() : null;
  for (let i=1; i<rows.length; i++) {
    const name = String(rows[i][0]||'').trim();
    const role = String(rows[i][1]||'').trim();
    const active = String(rows[i][2]||'').trim();
    if (!name) continue;
    const isActive = active === '' || active.toUpperCase() === 'TRUE' || active === '1';
    if (!isActive) continue;
    if (wanted && role.toUpperCase() !== wanted) continue;
    out.push({ name, role });
  }
  out.sort((a,b)=> a.name.localeCompare(b.name, 'el'));
  return out;
}


/** =========================
 *  Drive metadata helpers
 * ========================== */
function setDescriptionSafe_(fileObj, techName, geo, stepId, role) {
  try {
    const parts = [];
    if (techName) parts.push('TECH: '+techName);
    if (role) parts.push('ROLE: '+role);
    if (geo) parts.push('GEO: '+geoToString_(geo));
    if (stepId) parts.push('STEP: '+stepId);
    if (parts.length) fileObj.setDescription(parts.join(' | '));
  } catch (_){}
}

// Advanced Google Services ‚Üí Drive API (ON) + Cloud Console Drive API enabled
function setAppPropsSafe_(fileId, props) {
  try {
    Drive.Files.update({ appProperties: props }, fileId);
  } catch (_){}
}


/** =========================
 *  GET API
 * ========================== */
function doGet(e) {
  const action = (e && e.parameter && e.parameter.action) || 'ping';
  try {
    if (action === 'ping') {
      return ContentService.createTextOutput('OK');
    }

    if (action === 'search') { // ŒëŒΩŒ±Œ∂ŒÆœÑŒ∑œÉŒ∑ SR folders ŒºŒ≠œÉŒ± œÉœÑŒø ROOT
      const q = (e.parameter.query || '').toLowerCase();
      const root = getRootFolder_();
      const res = [];
      const it = root.getFolders();
      while (it.hasNext()) {
        const f = it.next();
        const name = f.getName();
        if (!q || name.toLowerCase().indexOf(q) > -1) {
          res.push({ id: f.getId(), name });
        }
      }
      return jsonOut_({ ok: true, results: res });
    }

    if (action === 'listUploaded') {
      const sr = (e.parameter.sr || '').trim();
      if (!sr) return jsonOut_({ ok:false, error:'missing sr' });

      const root = getRootFolder_();
      const srFolder = ensureSrFolderBases_(root, sr);

      const files = [];
      function walk(folder, relPath) {
        const fi = folder.getFiles();
        while (fi.hasNext()) {
          const f = fi.next();
          files.push({
            name: f.getName(),
            id: f.getId(),
            size: f.getSize(),
            path: relPath || '' // relative path Œ±œÄœå œÅŒπŒ∂Œ± SR
          });
        }
        const fo = folder.getFolders();
        while (fo.hasNext()) {
          const sf = fo.next();
          const nextRel = relPath ? (relPath + '/' + sf.getName()) : sf.getName();
          walk(sf, nextRel);
        }
      }
      walk(srFolder, '');

      files.sort((a,b)=>{
        const ap = (a.path||''); const bp=(b.path||'');
        if (ap !== bp) return ap.localeCompare(bp, 'el');
        return a.name.localeCompare(b.name, 'el');
      });

      return jsonOut_({ ok:true, files });
    }

    if (action === 'techs') {
      const role = (e.parameter.role || '').trim();
      const techs = getTechs_(role || null);
      return jsonOut_({ ok:true, techs });
    }

    return jsonOut_({ ok:false, error:'unknown action' });
  } catch (err) {
    return jsonOut_({ ok:false, error: String(err && err.message || err) });
  }
}


/** =========================
 *  POST API
 * ========================== */
function doPost(e) {
  try {
    const raw = e.postData && e.postData.contents ? e.postData.contents : '';
    if (!raw) return jsonOut_({ ok:false, error:'empty body' });

    // --- action: addTech ---
    if (raw.indexOf('"action":"addTech"') > -1) {
      let req;
      try { req = JSON.parse(raw); } catch(_){ return jsonOut_({ok:false,error:'invalid JSON'}); }
      const name = (req.name || '').trim();
      const role = (req.role || '').trim();
      if (!name || !role) return jsonOut_({ok:false,error:'missing name/role'});
      try {
        const ss = SpreadsheetApp.openById(LOG_SHEET_ID);
        let sh = ss.getSheetByName(TECHS_SHEET_NAME);
        if (!sh) { sh = ss.insertSheet(TECHS_SHEET_NAME); sh.appendRow(['NAME','ROLE','ACTIVE']); }
        sh.appendRow([name, role, 'TRUE']);
        return jsonOut_({ok:true, saved:true});
      } catch (err) {
        return jsonOut_({ok:false,error:String(err)});
      }
    }

    // --- action: updateAutopsia (FIXED) ---
if (raw.indexOf('"action":"updateAutopsia"') > -1) {
  let req;
  try { req = JSON.parse(raw); } catch(_){ return jsonOut_({ok:false,error:'invalid JSON'}); }

  const ss = SpreadsheetApp.openById(LOG_SHEET_ID);
  const sheetName = 'AFTOPSIA';
  let sh = ss.getSheetByName(sheetName);
  if (!sh) {
    sh = ss.insertSheet(sheetName);
    sh.appendRow([
      'TS','SR','DIG','DIG_LVL','SMART_READINESS','SMART_POINTS',
      'ROUTE_TYPE','CONST_LVL','BEP_FLOOR','LEVELS','STATUS'
    ]);
  }

  // ŒíœÅŒµœÇ Œ±ŒΩ œÖœÄŒ¨œÅœáŒµŒπ ŒÆŒ¥Œ∑ Œ∑ Œ≥œÅŒ±ŒºŒºŒÆ Œ≥ŒπŒ± Œ±œÖœÑœå œÑŒø SR
  const data = sh.getDataRange().getValues();
  let existingRow = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][1] === req.sr) {
      existingRow = i;
      break;
    }
  }

  const rowData = [
    new Date(),
    (req.sr||'').trim(),
    (req.dig||'').trim(),
    (req.dig_lvl||'').trim(),
    (req.smart_readiness||'').trim(),
    Array.isArray(req.smart_points)? req.smart_points.join(',') : String(req.smart_points||''),
    (req.route_type||'').trim(),
    (req.const_lvl||'').trim(),
    (req.bep_floor||'').trim(),
    (req.levels||'').trim(),
    (req.status||'').trim()
  ];

  if (existingRow > -1) {
    // Update existing row
    sh.getRange(existingRow + 1, 1, 1, rowData.length).setValues([rowData]);
  } else {
    // ŒùŒ≠Œ± ŒµŒ≥Œ≥œÅŒ±œÜŒÆ
    sh.appendRow(rowData);
  }
  
  return jsonOut_({ok:true, saved:true});
}

    // --- default: upload payload ---
    let data;
    try { data = JSON.parse(raw); }
    catch (_e) { return jsonOut_({ ok:false, error:'invalid JSON' }); }

    const srName = (data.srName || '').trim();
    if (!srName) return jsonOut_({ ok:false, error:'Missing srName' });

    const files = Array.isArray(data.files) ? data.files : [];
    if (!files.length) return jsonOut_({ ok:false, error:'No files' });

    const techName = (data.techName || '').trim();
    const role = (data.role || '').trim();
    const geo = data.geo && typeof data.geo === 'object' ? data.geo : null;

    const root = getRootFolder_();
    const srFolder = ensureSrFolderBases_(root, srName);

    const outFiles = [];

    for (let i=0; i<files.length; i++) {
      const f = files[i] || {};
      const name = (f.filename || ('file_'+Date.now())).trim();
      const mime = (f.mimeType || guessMime_(name) || 'application/octet-stream');
      const b64  = (f.contentBase64 || '').trim();
      if (!name || !b64) continue;

      // Idempotency (digest + filename)
      let idem = (f.idem || '').trim();
      if (!idem) {
        const bytes = Utilities.base64Decode(b64);
        const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, bytes);
        idem = Utilities.base64EncodeWebSafe(digest).replace(/=+$/,'') + '::' + name;
      }
      if (wasSeen_(idem)) {
        outFiles.push({ name, idempotent:true });
        continue;
      }

      const dests = Array.isArray(f.destinations) && f.destinations.length ? f.destinations : ['PHOTOS'];
      const stepId = (f.stepId || '').trim();

      const createdIn = [];
      for (const dpRaw of dests) {
        const dp = String(dpRaw).trim().replace(/^\/+|\/+$/g,''); // sanitize
        const parent = dp ? ensureSubpath_(srFolder, dp) : srFolder;
        const blob = Utilities.newBlob(Utilities.base64Decode(b64), mime, name);
        const nf = parent.createFile(blob);

        // Œ†ŒµœÅŒπŒ≥œÅŒ±œÜŒÆ Œ≥ŒπŒ± ŒΩŒ± œÜŒ±ŒØŒΩŒµœÑŒ±Œπ Œ¨ŒºŒµœÉŒ± œÉœÑŒø Drive
        setDescriptionSafe_(nf, techName, geo, stepId, role);
        // appProperties (Œ±ŒΩ Œ≠œáŒµŒπ ŒµŒΩŒµœÅŒ≥ŒøœÄŒøŒπŒ∑Œ∏ŒµŒØ Advanced Drive API)
        setAppPropsSafe_(nf.getId(), { techName, role, geo: geoToString_(geo), stepId, srName });

        const relPath = dp ? dp : '';
        createdIn.push({ folder: dp || '', id:nf.getId(), path: relPath });

        if (CFG.ENABLE_LOGS) {
          logUpload_({
            ts: new Date(),
            srName, techName,
            fileName: name,
            size: Utilities.base64Decode(b64).length,
            mime, stepId,
            destinations: dp,
            geo: geoToString_(geo),
            idem,
            path: relPath
          });
        }
      }

      markSeen_(idem);
      outFiles.push({ name, createdIn });
    }

    return jsonOut_({ ok:true, uploaded: outFiles });

  } catch (err) {
    return jsonOut_({ ok:false, error: String(err && err.message || err) });
  }
}

<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGITAL EXPERT â€” PHOTOS (Mobile)</title>

<!-- Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÏŒ Î³Î¹Î± ZIP -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
:root{
  --bg:#f6f7fb;
  --card:#fff;
  --ink:#0f172a;
  --muted:#6b7280;
  --line:#e5e7eb;
  --pill:#0f172a;
  --pillText:#fff;
  --shadow:0 12px 28px rgba(2,6,23,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial;
}

/* Header */
.app-header{
  position:sticky;top:0;z-index:20;
  backdrop-filter: blur(8px);
  background:rgba(255,255,255,.92);
  border-bottom:1px solid var(--line);
}
.app-header .inner{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;
}
.app-title{font-weight:700;font-size:16px;margin:0}
.app-sub{color:var(--muted);font-size:13px}

/* Content */
.container{padding:16px 16px 84px 16px;max-width:980px;margin:0 auto}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px 12px;
  box-shadow: var(--shadow);
  margin-bottom:12px;
}
.card h3{margin:0 0 8px 0;font-size:15px}
.muted{color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row > *{flex:1 1 220px}
input[type="text"], select, button{
  width:100%;border:1px solid var(--line);border-radius:10px;padding:10px 12px;
  background:#fff;font:inherit
}
button.primary{background:#111827;color:#fff;border-color:#111827;cursor:pointer}
button.ghost{background:#fff;color:#111827;border-color:#d1d5db;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}

/* Lists */
.list{display:grid;grid-template-columns:1fr;gap:8px}
.item{
  border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;display:flex;gap:12px;align-items:center;justify-content:space-between
}
.item .meta{min-width:0}
.item .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item .sub{font-size:12px;color:var(--muted)}

/* Bottom nav */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:30;
  background:rgba(255,255,255,.92);backdrop-filter:blur(8px);
  border-top:1px solid var(--line)
}
.bottom-nav .inner{
  display:grid;grid-template-columns:repeat(5,1fr);gap:2px;padding:6px
}
.bottom-nav button{
  appearance:none;border:1px solid var(--line);border-radius:12px;padding:8px 4px;
  background:#fff;font-size:12px
}
.bottom-nav button.active{background:#0f172a;color:#fff;border-color:#0f172a}

/* Hide/Show sections */
.section{display:none}
.section.active{display:block}

/* Preview thumbs */
.thumb{
  width:56px;height:56px;border:1px solid var(--line);border-radius:8px;object-fit:cover
}
.badge{display:inline-block;background:#0f172a;color:#fff;border-radius:999px;padding:2px 8px;font-size:11px}

/* Tools footer help */
.help{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header class="app-header">
  <div class="inner">
    <div>
      <h1 class="app-title">DIGITAL EXPERT â€” PHOTOS</h1>
      <div class="app-sub">Mobile UI â€” Î£Ï…Î»Î»Î¿Î³Î® & Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Î¡ÏŒÎ»Î¿Ï‚ -->
  <section id="sec-role" class="section active">
    <div class="card">
      <h3>Î¡ÏŒÎ»Î¿Ï‚ & Î•Ï€Î¹Î»Î¿Î³Î­Ï‚</h3>
      <div class="row">
        <select id="roleSelect">
          <option value="">â€” Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏÏŒÎ»Î¿ â€”</option>
          <option value="ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£">ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£</option>
          <option value="Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“ÎŸÎ£">Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“ÎŸÎ£</option>
          <option value="Î‘Î¥Î¤ÎŸÎ¨Î™Î‘">Î‘Î¥Î¤ÎŸÎ¨Î™Î‘</option>
        </select>
        <input id="techName" type="text" placeholder="ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿ Ï„ÎµÏ‡Î½Î¹ÎºÎ¿Ï" />
      </div>
      <div class="row">
        <input id="srSearch" type="text" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· SR (Ï€.Ï‡. 2-123â€¦ Î® 378514)" />
        <button id="btnSearchSr" class="primary">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· SR</button>
      </div>
      <div id="srResults" class="list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Î”Î¿Î¼Î® -->
  <section id="sec-struct" class="section">
    <div class="card">
      <h3>Î”Î¿Î¼Î® Î¦Î±ÎºÎ­Î»Î¿Ï… SR</h3>
      <div id="structInfo" class="muted">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ SR Î³Î¹Î± Î½Î± Ï€Î±ÏÎ¿Ï…ÏƒÎ¹Î±ÏƒÏ„ÎµÎ¯ Î· Î´Î¿Î¼Î® (PHOTOS / Î£Î§Î•Î”Î™Î‘ / ÎœÎ•Î¤Î¡Î—Î£Î•Î™Î£).</div>
    </div>
  </section>

  <!-- Î£Ï…Î»Î»Î¿Î³Î® -->
  <section id="sec-gallery" class="section">
    <div class="card">
      <h3>Î£Ï…Î»Î»Î¿Î³Î® Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¹ÏÎ½</h3>
      <div class="row">
        <input id="stepName" type="text" placeholder="Î’Î®Î¼Î± (Ï€.Ï‡. BEP_BEFORE01)" />
        <input id="fileInput" type="file" accept="image/*" multiple capture="environment" />
      </div>
      <div id="pendingList" class="list" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <button id="btnUpload" class="primary">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± ÏƒÏ„Î¿ Drive</button>
        <button id="btnClearPending" class="ghost">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î»Î¯ÏƒÏ„Î±Ï‚</button>
      </div>
    </div>
  </section>

  <!-- Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ -->
  <section id="sec-sync" class="section">
    <div class="card">
      <h3>Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ & Preview</h3>
      <div id="syncInfo" class="muted">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ SR & Ï€Î±Ï„Î®ÏƒÏ„Îµ Â«Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚Â» Î±Ï€ÏŒ ÎºÎ¬Ï„Ï‰ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¹ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· ÏƒÏ„Î¿ Drive.</div>
      <div class="row" style="margin-top:8px">
        <button id="btnRefreshSync" class="primary">Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</button>
        <button id="btnOpenSrFolder" class="ghost" disabled>Î†Î½Î¿Î¹Î³Î¼Î± Ï†Î±ÎºÎ­Î»Î¿Ï… SR (Drive)</button>
      </div>
      <div id="uploadedIndex" class="list" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Î•ÏÎ³Î±Î»ÎµÎ¯Î± -->
  <section id="sec-tools" class="section">
    <div class="card">
      <h3>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</h3>
      <div class="row">
        <button id="btnDownloadZip" class="primary">ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÎŸÎ›Î•Î£ Ï„Î¹Ï‚ Ï„Î¿Ï€Î¹ÎºÎ­Ï‚ Ï†ÏÏ„Î¿ (ZIP)</button>
        <button id="btnShowQueue" class="ghost">Î•ÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„ÎµÏ‚ (Queue)</button>
      </div>
      <div id="queueHost" class="list" style="margin-top:10px"></div>
      <div class="help" style="margin-top:8px">
        Î”ÎµÎ½ ÎºÎ±Ï„ÎµÎ²Î¬Î¶Î¿Ï…Î¼Îµ Ï„Î¯Ï€Î¿Ï„Î± Î±Ï€ÏŒ Ï„Î¿ Drive. Î¤Î¿ ZIP Ï†Ï„Î¹Î¬Ï‡Î½ÎµÏ„Î±Î¹ Î±Ï€ÏŒ ÎŸ,Î¤Î™ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï€Î¹ÎºÎ¬ (pending/ok/error cache).
      </div>
    </div>
  </section>
</main>

<!-- ÎšÎ¬Ï„Ï‰ Î¼Ï€Î¬ÏÎ± -->
<nav class="bottom-nav">
  <div class="inner">
    <button data-target="sec-role" class="active">Î¡ÏŒÎ»Î¿Ï‚</button>
    <button data-target="sec-struct">Î”Î¿Î¼Î®</button>
    <button data-target="sec-gallery">Î£Ï…Î»Î»Î¿Î³Î®</button>
    <button data-target="sec-sync">Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</button>
    <button data-target="sec-tools">Î•ÏÎ³Î±Î»ÎµÎ¯Î±</button>
  </div>
</nav>

<script>
/** =========================
 * CONFIG
 * ========================== */
// ğŸ‘‰ Î’Î¬Î»Îµ ÎµÎ´Ï Ï„Î¿ WebApp URL Ï„Î¿Ï… Apps Script ÏƒÎ¿Ï… (doGet/doPost)
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbx_pJ-CByq6aFZ2d9v12OglYA51FSI8gTPSRtFIPQgMxJOgJvWNcxJanllsT9wO1tZN/exec'; // Ï€.Ï‡. https://script.google.com/macros/s/AKfyc.../exec

// Î•Î»Î±Ï†ÏÏ state (Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î´Î¿Ï…Î»ÎµÎ¹Î¬, Î¿Ï…ÏÎ¬, ÎºÎ»Ï€)
const state = {
  role: '',
  techName: '',
  job: { srFolderId:'', srFolderName:'' },
  pending: [],  // {filename, file, stepId}
};

// Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÏŒ: Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· SR/Î¡ÏŒÎ»Î¿Ï…/Î¤ÎµÏ‡Î½Î¹ÎºÎ¿Ï
function loadPrefs(){
  try{
    const s = JSON.parse(localStorage.getItem('prefs')||'{}');
    if(s.role) document.getElementById('roleSelect').value = s.role;
    if(s.techName) document.getElementById('techName').value = s.techName;
    if(s.srFolderName) state.job.srFolderName = s.srFolderName;
    if(s.srFolderId) state.job.srFolderId = s.srFolderId;
    reflectSrIntoUI();
  }catch(_){}
}
function savePrefs(){
  const role = document.getElementById('roleSelect').value||'';
  const techName = document.getElementById('techName').value||'';
  const prefs = {
    role, techName,
    srFolderId: state.job.srFolderId||'',
    srFolderName: state.job.srFolderName||'',
  };
  localStorage.setItem('prefs', JSON.stringify(prefs));
}

/** =========================
 * BOTTOM NAV
 * ========================== */
function bindBottomNav(){
  const wrap = document.querySelector('.bottom-nav');
  const btns = Array.from(wrap.querySelectorAll('button'));
  const sections = Array.from(document.querySelectorAll('.section'));
  function setActive(btn){
    btns.forEach(b=>b.classList.toggle('active', b===btn));
    const id = btn.getAttribute('data-target');
    sections.forEach(s=>s.classList.toggle('active', s.id===id));
  }
  function clickOrFallback(name, ids){
    for(const id of ids){
      const el = document.getElementById(id) || document.querySelector('.'+id) || document.querySelector(id);
      if(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); return true; }
    }
    return false;
  }
  btns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      setActive(btn);
      const id = btn.getAttribute('data-target');
      if(id==='sec-struct'){
        const ok = clickOrFallback('Î”Î¿Î¼Î®',['structInfo']);
        if(!ok) console.warn('BottomNav: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ Î³Î¹Î± Î”Î¿Î¼Î®.');
      }
    });
  });
}

/** =========================
 * SR Search
 * ========================== */
async function searchSr(){
  const q = (document.getElementById('srSearch').value||'').trim();
  const host = document.getElementById('srResults');
  host.innerHTML = '';
  const url = WEBAPP_URL + '?action=search&query=' + encodeURIComponent(q) + '&t=' + Date.now();
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(!json.ok){ host.innerHTML = '<div class="muted">Î£Ï†Î¬Î»Î¼Î± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚.</div>'; return; }
    if(!json.results || !json.results.length){
      host.innerHTML = '<div class="muted">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ SR.</div>'; return;
    }
    json.results.sort((a,b)=> a.name.localeCompare(b.name,'el'));
    json.results.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="meta">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="sub">${it.id}</div>
        </div>
        <div class="actions">
          <button class="primary">Î•Ï€Î¹Î»Î¿Î³Î®</button>
        </div>
      `;
      div.querySelector('button').addEventListener('click', ()=>{
        state.job.srFolderId = it.id;
        state.job.srFolderName = it.name;
        savePrefs();
        reflectSrIntoUI();
      });
      host.appendChild(div);
    });
  }catch(e){
    host.innerHTML = '<div class="muted">Î£Ï†Î¬Î»Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï….</div>';
  }
}
function reflectSrIntoUI(){
  const s = state.job.srFolderName ? `Î•Î½ÎµÏÎ³ÏŒ SR: <span class="badge">${escapeHtml(state.job.srFolderName)}</span>` : 'ÎšÎ±Î½Î­Î½Î± ÎµÎ½ÎµÏÎ³ÏŒ SR';
  document.getElementById('structInfo').innerHTML = s;
  document.getElementById('syncInfo').innerHTML = s;
  document.getElementById('btnOpenSrFolder').disabled = !state.job.srFolderId;
  if(state.job.srFolderId){
    document.getElementById('btnOpenSrFolder').onclick = ()=>{
      window.open('https://drive.google.com/drive/folders/'+encodeURIComponent(state.job.srFolderId),'_blank');
    };
  }
}

/** =========================
 * Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ (Drive Index + Preview)
 * ========================== */
function refreshUploadedIndex(){
  if(!state.job || !state.job.srFolderName){ 
    document.getElementById('uploadedIndex').innerHTML = '<div class="muted">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ SR.</div>';
    return Promise.resolve(); 
  }
  const url = WEBAPP_URL + '?action=listUploaded&sr=' + encodeURIComponent(state.job.srFolderName) + '&t=' + Date.now();
  return fetch(url)
    .then(res=>res.json())
    .then(json=>{
      if(json && json.ok){
        const items = json.items || json.files || [];
        buildUploadedIndex(items);
      }else{
        document.getElementById('uploadedIndex').innerHTML = '<div class="muted">Î£Ï†Î¬Î»Î¼Î± ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼Î¿Ï.</div>';
      }
    }).catch(()=>{
      document.getElementById('uploadedIndex').innerHTML = '<div class="muted">Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î¹ÎºÏ„ÏÎ¿Ï….</div>';
    });
}
function buildUploadedIndex(items){
  const host = document.getElementById('uploadedIndex');
  host.innerHTML = '';
  if(!items || !items.length){
    const srName = state.job.srFolderName || '';
    host.innerHTML = '<div class="muted">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± "'+escapeHtml(srName)+'".</div>';
    return;
  }
  // Î±Ï€Î»ÏŒ sort ÎºÎ±Ï„Î¬ ÏŒÎ½Î¿Î¼Î±
  items.sort((a,b)=>(a.name||'').localeCompare(b.name||'','el'));
  items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'item';
    const openUrl = it.id ? ('https://drive.google.com/file/d/'+encodeURIComponent(it.id)+'/view') : '#';
    div.innerHTML = `
      <div class="meta">
        <div class="name">${escapeHtml(it.name||'')}</div>
        <div class="sub">${it.size ? humanSize(it.size) : ''}</div>
      </div>
      <div class="actions">
        <a href="${openUrl}" target="_blank"><button class="ghost">Î†Î½Î¿Î¹Î³Î¼Î±</button></a>
      </div>
    `;
    host.appendChild(div);
  });
}

/** =========================
 * Î£Ï…Î»Î»Î¿Î³Î® (Ï„Î¿Ï€Î¹ÎºÎ® Î¿Ï…ÏÎ¬) & Upload
 * ========================== */
function renderPending(){
  const host = document.getElementById('pendingList');
  host.innerHTML = '';
  if(!state.pending.length){
    host.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î±.</div>';
    return;
  }
  state.pending.forEach((p, idx)=>{
    const div = document.createElement('div');
    div.className = 'item';
    const url = p.previewUrl || '';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;min-width:0">
        <img class="thumb" src="${url}" alt="" />
        <div class="meta">
          <div class="name">${escapeHtml(p.filename||'')}</div>
          <div class="sub">${escapeHtml(p.stepId||'')}</div>
        </div>
      </div>
      <div class="actions">
        <button class="ghost" data-remove="${idx}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
      </div>
    `;
    div.querySelector('button[data-remove]').addEventListener('click', ()=>{
      state.pending.splice(idx,1);
      renderPending();
    });
    host.appendChild(div);
  });
}
document.getElementById('fileInput').addEventListener('change', async (ev)=>{
  const step = (document.getElementById('stepName').value||'').trim();
  const files = Array.from(ev.target.files||[]);
  for(const f of files){
    try{
      const b64 = await compressPhotoToJpegB64(f);
      const previewUrl = 'data:image/jpeg;base64,'+b64;
      const filename = buildFilename(f.name, step);
      state.pending.push({ filename, file:f, contentBase64:b64, stepId:step, previewUrl });
    }catch(_){}
  }
  renderPending();
});
function buildFilename(original, step){
  const base = (step||'PHOTO') + '_' + tsForName();
  const ext = (original||'').toLowerCase().endsWith('.png') ? '.png' : '.jpg';
  return base + ext;
}
function tsForName(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,'0');
  return d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes())+pad(d.getSeconds());
}

document.getElementById('btnUpload').addEventListener('click', async ()=>{
  const role = document.getElementById('roleSelect').value||'';
  const techName = document.getElementById('techName').value||'';
  if(!state.job.srFolderName){ alert('Î•Ï€Î¯Î»ÎµÎ¾Îµ SR Ï€ÏÏÏ„Î±.'); return; }
  if(!state.pending.length){ alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ Î³Î¹Î± Î±Î½Î­Î²Î±ÏƒÎ¼Î±.'); return; }

  const payload = {
    srName: state.job.srFolderName,
    techName, role,
    files: state.pending.map(p=>({
      filename: p.filename,
      contentBase64: p.contentBase64,
      mimeType: 'image/jpeg',
      stepId: p.stepId || '',
      destinations: ['PHOTOS']
    }))
  };
  try{
    const res = await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify(payload) });
    const json = await res.json();
    if(json && json.ok){
      alert('Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ ('+(json.uploaded||[]).length+' Î±ÏÏ‡ÎµÎ¯Î±).');
      state.pending = [];
      renderPending();
      refreshUploadedIndex();
    }else{
      alert('Î£Ï†Î¬Î»Î¼Î± Î±Î½ÎµÎ²Î¬ÏƒÎ¼Î±Ï„Î¿Ï‚.');
    }
  }catch(e){
    alert('Î£Ï†Î¬Î»Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï… ÏƒÏ„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î±.');
  }
});
document.getElementById('btnClearPending').addEventListener('click', ()=>{
  state.pending = [];
  renderPending();
});

/** =========================
 * Tools: ZIP ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï„Î¿Ï€Î¹ÎºÏÎ½ Ï†Ï‰Ï„Î¿
 * ========================== */
document.getElementById('btnDownloadZip').addEventListener('click', downloadAllLocalAsZip);
document.getElementById('btnShowQueue').addEventListener('click', renderQueueDump);

async function downloadAllLocalAsZip(){
  const collected = await collectAllLocalPhotos();
  if(!collected.length){ alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï„Î¿Ï€Î¹ÎºÎ­Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚.'); return; }

  const zip = new JSZip();
  const todayFolder = (state.job.srFolderName ? (state.job.srFolderName + '_') : '') + new Date().toISOString().slice(0,10);
  const root = zip.folder(todayFolder);

  collected.forEach((f,i)=>{
    const name = f.filename || ('photo_'+String(i+1).padStart(3,'0')+'.jpg');
    try{
      const b64 = (f.contentBase64 || (f.dataUrl||'').split(',')[1] || '').trim();
      if(b64) root.file(name, b64, {base64:true});
    }catch(_){}
  });

  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (todayFolder||'photos') + '.zip';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}

function renderQueueDump(){
  const host = document.getElementById('queueHost');
  host.innerHTML = '';
  const items = debugScanLocalCandidates();
  if(!items.length){
    host.innerHTML = '<div class="muted">ÎšÎ±Î¼Î¯Î± ÎµÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„Î±/Ï„Î¿Ï€Î¹ÎºÎ® ÎµÎ³Î³ÏÎ±Ï†Î®.</div>';
    return;
  }
  items.forEach((it,idx)=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="meta">
        <div class="name">${escapeHtml(it.filename||('item_'+(idx+1)))}</div>
        <div class="sub">Source: ${escapeHtml(it._source||'localStorage')}</div>
      </div>
      <div class="actions">
        ${it.previewUrl?('<img class="thumb" src="'+it.previewUrl+'" />'):''}
      </div>
    `;
    host.appendChild(div);
  });
}

// Î£Ï…Î»Î»Î¿Î³Î® Î±Ï€ÏŒ Î´Î¹Î¬Ï†Î¿ÏÎ± Ï€Î¹Î¸Î±Î½Î¬ Ï„Î¿Ï€Î¹ÎºÎ¬ ÎºÎ»ÎµÎ¹Î´Î¹Î¬ â€” robust
async function collectAllLocalPhotos(){
  const out = [];
  // 1) ÎŒ,Ï„Î¹ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î¿ state.pending (Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±)
  (state.pending||[]).forEach(p=>{
    out.push({ filename:p.filename, contentBase64:p.contentBase64, previewUrl:p.previewUrl, _source:'pending' });
  });

  // 2) Î£Î¬ÏÏ‰ÏƒÎ· localStorage Î³Î¹Î± Î³Î½Ï‰ÏƒÏ„Î¬ patterns
  const candidates = debugScanLocalCandidates();
  candidates.forEach(c=>{
    if(c.contentBase64 || c.dataUrl){
      out.push(c);
    }
  });

  return out;
}

function debugScanLocalCandidates(){
  const items = [];
  try{
    for(let i=0;i<localStorage.length;i++){
      const key = localStorage.key(i);
      if(!key) continue;
      // Î Î¹Î¸Î±Î½Î¬ keys Î¿Ï…ÏÎ¬Ï‚/ÎµÎ¹ÎºÏŒÎ½Ï‰Î½
      if(/^qe::|^queue|^photos|^pending|^uploads|^images/i.test(key)){
        try{
          const val = JSON.parse(localStorage.getItem(key));
          if(Array.isArray(val)){
            val.forEach(v=>{
              if(v && (v.contentBase64 || v.dataUrl)){
                // normalise
                items.push({
                  filename: v.filename || v.name || '',
                  contentBase64: v.contentBase64 || (v.dataUrl||'').split(',')[1] || '',
                  previewUrl: v.previewUrl || v.dataUrl || '',
                  _source: key
                });
              }
            });
          }else if(val && typeof val==='object' && (val.contentBase64 || val.dataUrl)){
            items.push({
              filename: val.filename || val.name || '',
              contentBase64: val.contentBase64 || (val.dataUrl||'').split(',')[1] || '',
              previewUrl: val.previewUrl || val.dataUrl || '',
              _source: key
            });
          }
        }catch(_){}
      }
    }
  }catch(_){}
  return items;
}

/** =========================
 * Utils
 * ========================== */
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
function humanSize(n){
  n = Number(n||0);
  if(n<1024) return n+' B';
  if(n<1024*1024) return (n/1024).toFixed(1)+' KB';
  if(n<1024*1024*1024) return (n/(1024*1024)).toFixed(1)+' MB';
  return (n/(1024*1024*1024)).toFixed(1)+' GB';
}

// Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· -> base64 (JPEG)
async function compressPhotoToJpegB64(file){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{
      const max=2200;
      const sc=Math.min(1, max/Math.max(img.width,img.height));
      const w=Math.round(img.width*sc), h=Math.round(img.height*sc);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      try{
        const dataUrl=c.toDataURL('image/jpeg', 0.85);
        resolve(dataUrl.split(',')[1]);
      }catch(e){ reject(e); }
    };
    img.onerror=()=>reject(new Error('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚'));
    const r=new FileReader();
    r.onload=()=>{ img.src=r.result; };
    r.onerror=()=>reject(new Error('FileReader error'));
    r.readAsDataURL(file);
  });
}

/** =========================
 * Init bindings
 * ========================== */
document.getElementById('btnSearchSr').addEventListener('click', searchSr);
document.getElementById('roleSelect').addEventListener('change', savePrefs);
document.getElementById('techName').addEventListener('input', savePrefs);
document.getElementById('btnRefreshSync').addEventListener('click', refreshUploadedIndex);

bindBottomNav();
loadPrefs();
renderPending();
</script>
</body>
</html>

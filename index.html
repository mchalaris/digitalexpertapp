<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGITAL EXPERT — PHOTOS (Mobile)</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--shadow:0 12px 28px rgba(2,6,23,.10)}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);box-shadow:var(--shadow);border-radius:16px;padding:16px;margin-bottom:16px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row> *{flex:1 1 220px}
input,select,button{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
button.primary{background:#0f172a;color:#fff;border:none}
small.muted{color:var(--muted)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f172a;color:#fff;font-size:12px}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
#queue .item{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0;background:#fff}
#queue .thumb{width:44px;height:44px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
#queue .meta{flex:1}
#queue .dup{outline:2px solid #ef4444}
footer{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--line);padding:10px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row">
      <div>
        <label>Script URL</label>
        <input id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbx_pJ-CByq6aFZ2d9v12OglYA51FSI8gTPSRtFIPQgMxJOgJvWNcxJanllsT9wO1tZN/exec" />
        <small class="muted">Βάλε εδώ το Web App URL του Apps Script και αποθηκεύεται τοπικά.</small>
      </div>
      <div>
        <label>SR (όνομα φακέλου)</label>
        <input id="srInput" placeholder="π.χ. 2-325803975838" />
      </div>
      <div>
        <label>Ρόλος</label>
        <select id="role">
          <option>ΚΑΤΑΣΚΕΥΑΣΤΗΣ</option>
          <option>ΧΩΜΑΤΟΥΡΓΟΣ</option>
          <option>ΑΥΤΟΨΙΑ</option>
        </select>
      </div>
      <div>
        <label>Τεχνικός</label>
        <select id="tech"></select>
        <small class="muted">Λίστα από το sheet TECHS (ενεργοί).</small>
      </div>
    </div>
    <div class="row">
      <div>
        <button id="searchBtn">Αναζήτηση SR στη ρίζα</button>
      </div>
      <div>
        <button id="listBtn">Συγχρονισμός (ListSync)</button>
      </div>
      <div>
        <button id="addTechBtn">Προσθήκη τεχνικού</button>
      </div>
    </div>
    <div style="margin-top:8px"><span id="status" class="mono small"></span></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Destination</label>
        <select id="dest">
          <option>PHOTOS</option>
          <option>ΣΧΕΔΙΑ</option>
          <option>ΜΕΤΡΗΣΕΙΣ</option>
        </select>
      </div>
      <div>
        <label>STEP ID (προαιρετικό)</label>
        <input id="stepId" placeholder="π.χ. FB(+01), BEP_BMO_BEFORE01" />
      </div>
      <div>
        <label>Αρχεία</label>
        <input id="files" type="file" multiple accept="image/*,.pdf,.txt,.png,.jpg,.jpeg,.webp,.heic" />
      </div>
    </div>
    <div id="queue"></div>
    <div class="row">
      <div><button id="uploadBtn" class="primary">Upload</button></div>
      <div><button id="clearBtn">Καθάρισμα ουράς</button></div>
    </div>
  </div>

  <div class="card">
    <div><strong>Quick help</strong></div>
    <ul>
      <li>Πρώτα βάλε <span class="mono">Script URL</span> (αποθηκεύεται στο browser).</li>
      <li>Διάλεξε <span class="mono">SR</span>, <span class="mono">Ρόλο</span>, <span class="mono">Τεχνικό</span>.</li>
      <li>“Συγχρονισμός” δείχνει τι έχει ήδη ανέβει και κάνει highlight πιθανά διπλότυπα στην ουρά.</li>
    </ul>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div><small class="muted">DIGITAL EXPERT — Mobile Uploader</small></div>
      <div><small class="muted" id="pingInfo"></small></div>
    </div>
  </div>
</footer>

<script>
/** ====== CONFIG (runtime) ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const S = {
  SCRIPT_URL: '',
  srName: '',
  role: '',
  techName: '',
  geo: null,
  queue: []
};

(function boot(){
  const saved = localStorage.getItem('SCRIPT_URL');
  if (saved) { $('#scriptUrl').value = saved; S.SCRIPT_URL = saved; }
  // try ping on load
  ping();
})();

/** ====== Helpers ====== */
async function fetchJSON(url, opt) {
  const r = await fetch(url, opt);
  if (!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
function fileToBase64(file) {
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(String(fr.result).split(',')[1] || '');
    fr.onerror = () => rej(new Error('FileReader error'));
    fr.readAsDataURL(file);
  });
}
function renderQueue() {
  const q = $('#queue');
  q.innerHTML = '';
  for (const it of S.queue) {
    const div = document.createElement('div');
    div.className = 'item' + (it._dup ? ' dup' : '');
    const img = document.createElement('img');
    img.className = 'thumb';
    if (it.file && it.file.type.startsWith('image/')) {
      img.src = URL.createObjectURL(it.file);
    } else {
      img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDQiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjZWVlIi8+PHBhdGggZD0iTTcgN2g5djJoLTlWN3ptMCA0aDEydjJoLTEydi0yem0wIDRoMTB2Mkg3di0yeiIgZmlsbD0iI2JiYiIvPjwvc3ZnPg==';
    }
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<div class="mono">${it.filename}</div>
                      <small class="muted">dest: ${it.dest}${it.stepId?` · step: ${it.stepId}`:''}${it._dup?' · <span class="badge">DUP</span>':''}</small>`;
    const del = document.createElement('button');
    del.textContent = '✕';
    del.style.width = '44px';
    del.onclick = () => { S.queue = S.queue.filter(x=>x!==it); renderQueue(); };
    div.append(img, meta, del);
    q.append(div);
  }
  $('#status').textContent = `Στην ουρά: ${S.queue.length} αρχείο(α).`;
}

function getGeo() {
  return new Promise(resolve=>{
    if (!navigator.geolocation) return resolve(null);
    const opt = { enableHighAccuracy:true, timeout:3000, maximumAge:0 };
    navigator.geolocation.getCurrentPosition(
      p => resolve({ lat:p.coords.latitude, lng:p.coords.longitude, accuracy:p.coords.accuracy }),
      _ => resolve(null),
      opt
    );
  });
}

/** ====== PING ====== */
async function ping() {
  const url = ($('#scriptUrl').value || '').trim();
  if (!url) { $('#pingInfo').textContent = '—'; return; }
  try{
    const r = await fetch(url+'?action=ping');
    const t = await r.text();
    $('#pingInfo').textContent = t==='OK' ? 'Online' : 'No response';
  }catch(e){
    $('#pingInfo').textContent = 'Offline';
  }
}

/** ====== Events / bindings ====== */
$('#scriptUrl').addEventListener('change', ()=>{
  const v = $('#scriptUrl').value.trim();
  S.SCRIPT_URL = v; localStorage.setItem('SCRIPT_URL', v);
  ping();
});
$('#srInput').addEventListener('change', ()=>{ S.srName = $('#srInput').value.trim(); });

$('#role').addEventListener('change', async ()=>{
  S.role = $('#role').value.trim();
  await refreshTechs();
});
$('#tech').addEventListener('change', ()=>{ S.techName = $('#tech').value.trim(); });

$('#files').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  const dest = $('#dest').value.trim();
  const step = $('#stepId').value.trim();
  for (const f of files) {
    S.queue.push({
      file: f,
      filename: f.name,
      mimeType: f.type || 'application/octet-stream',
      dest,
      stepId: step || ''
    });
  }
  renderQueue();
});

$('#clearBtn').addEventListener('click', ()=>{ S.queue = []; renderQueue(); });

$('#addTechBtn').addEventListener('click', async ()=>{
  const name = prompt('Όνομα τεχνικού;');
  if (!name) return;
  const role = $('#role').value.trim() || 'ΚΑΤΑΣΚΕΥΑΣΤΗΣ';
  try{
    const js = await fetchJSON(S.SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'addTech', name, role })
    });
    if (!js.ok) throw new Error(js.error||'unknown');
    alert('OK — Προστέθηκε.');
    await refreshTechs();
  }catch(e){
    alert('Σφάλμα: '+e.message);
  }
});

$('#searchBtn').addEventListener('click', async ()=>{
  if (!S.SCRIPT_URL) return alert('Βάλε Script URL');
  const q = prompt('Αναζήτηση (κενό για όλα):','');
  if (q===null) return;
  try{
    const js = await fetchJSON(`${S.SCRIPT_URL}?action=search&query=${encodeURIComponent(q||'')}`);
    if (!js.ok) throw new Error(js.error||'unknown');
    if (!js.results || !js.results.length) return alert('Δεν βρέθηκαν φάκελοι.');
    const names = js.results.map(x=>x.name);
    const pick = prompt(`Βρέθηκαν ${names.length}:\n\n${names.slice(0,50).join('\n')}\n\nΠληκτρολόγησε ακριβώς το SR για επιλογή:`);
    if (!pick) return;
    $('#srInput').value = pick;
    S.srName = pick;
  }catch(e){
    alert('Σφάλμα: '+e.message);
  }
});

/** ====== LIST / SYNC ====== */
$('#listBtn').addEventListener('click', async ()=>{
  if (!S.SCRIPT_URL) return alert('Βάλε Script URL');
  if (!S.srName)     return alert('Διάλεξε SR');
  try{
    const url = `${S.SCRIPT_URL}?action=listSync&sr=${encodeURIComponent(S.srName)}`;
    const js = await fetchJSON(url);
    if(!js.ok){ alert('Σφάλμα: '+(js.error||'')); return; }
    const files = js.files||[];

    // Bucket -> folder -> stepId -> items
    const map = {};
    for (const f of files) {
      const folder = f.folder || 'PHOTOS';
      const step = (f.stepId||'-').trim() || '-';
      map[folder] = map[folder] || {};
      map[folder][step] = map[folder][step] || [];
      map[folder][step].push(f);
    }

    // Highlight διπλότυπα στην ουρά (με βάση name+folder ή stepId)
    const existingNames = new Set(files.map(f => `${f.folder}::${f.name}`));
    const existingSteps = new Set(files.map(f => (f.stepId||'').trim()).filter(Boolean));
    let dupCount = 0;
    for (const it of S.queue) {
      const key = `${it.dest}::${it.filename}`;
      const isDup = existingNames.has(key) || (it.stepId && existingSteps.has(it.stepId.trim()));
      it._dup = !!isDup;
      if (isDup) dupCount++;
    }
    renderQueue();
    $('#status').textContent = dupCount ? `Βρέθηκαν ${dupCount} πιθανά διπλότυπα στην ουρά` : 'Δεν βρέθηκαν διπλότυπα στην ουρά';

    // Render διάλογο με τα υπάρχοντα
    const html = Object.keys(map).map(folder=>{
      const steps = map[folder];
      const blocks = Object.keys(steps).sort().map(step=>{
        const arr = steps[step];
        const li = arr.map(x=>`<li><span class="mono">${x.name}</span> <span class="small">(${Math.round((x.size||0)/1024)} KB${x.stepId?`, STEP:${x.stepId}`:''}${x.techName?`, ${x.techName}`:''})</span></li>`).join('');
        return `<div style="margin:8px 0"><div><strong>${folder}</strong> — STEP: <span class="mono">${step}</span> <span class="small">(${arr.length})</span></div><ul>${li}</ul></div>`;
      }).join('');
      return blocks || `<div><strong>${folder}</strong>: —</div>`;
    }).join('<hr/>');

    const w = window.open('', '_blank', 'width=520,height=700,scrollbars=yes');
    w.document.write(`<title>Συγχρονισμός — ${S.srName}</title><meta charset="utf-8"><div style="font:14px system-ui;padding:10px">${html || '— Κενό —'}</div>`);
    w.document.close();

  }catch(e){
    alert('HTTP σφάλμα');
  }
});

/** ====== Upload ====== */
$('#uploadBtn').addEventListener('click', async ()=>{
  if (!S.SCRIPT_URL) return alert('Βάλε Script URL');
  if (!S.srName)     return alert('Διάλεξε SR');
  const role = $('#role').value.trim();
  const tech = $('#tech').value.trim();
  if (!tech) return alert('Διάλεξε τεχνικό');

  $('#status').textContent = 'Μετατροπή αρχείων…';
  // γεωγραφικά (best effort)
  if (!S.geo) S.geo = await getGeo();

  // προετοιμασία payload
  const filesPayload = [];
  for (const it of S.queue) {
    const b64 = await fileToBase64(it.file);
    filesPayload.push({
      filename: it.filename,
      mimeType: it.mimeType || 'application/octet-stream',
      contentBase64: b64,
      destinations: [it.dest || 'PHOTOS'],
      stepId: it.stepId || ''
      // idem: αφήνουμε να γεννηθεί από τον server
    });
  }

  const body = {
    srName:  S.srName,
    techName: tech,
    role: role,
    geo: S.geo || null,
    files: filesPayload
  };

  try{
    $('#status').textContent = 'Ανέβασμα…';
    const js = await fetchJSON(S.SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if (!js.ok) throw new Error(js.error||'unknown');
    const uploaded = js.uploaded||[];
    const idemp = uploaded.filter(x=>x.idempotent).length;
    const fresh = uploaded.length - idemp;
    alert(`ΟΚ — Ανεβασμένα: ${fresh}, Παραλείφθηκαν ως διπλότυπα: ${idemp}`);
    S.queue = [];
    renderQueue();
    $('#status').textContent = `Τελευταίο upload: ${new Date().toLocaleString()}`;
  }catch(e){
    alert('Σφάλμα upload: '+e.message);
    $('#status').textContent = 'Σφάλμα upload.';
  }
});

/** ====== Techs ====== */
async function refreshTechs(){
  if (!S.SCRIPT_URL) return;
  const role = $('#role').value.trim();
  try{
    const js = await fetchJSON(`${S.SCRIPT_URL}?action=techs&role=${encodeURIComponent(role)}`);
    if (!js.ok) throw new Error(js.error||'unknown');
    const techSel = $('#tech');
    techSel.innerHTML = '';
    (js.techs||[]).forEach(t=>{
      const o = document.createElement('option');
      o.textContent = t.name;
      o.value = t.name;
      techSel.appendChild(o);
    });
    if (techSel.options.length) {
      techSel.selectedIndex = 0;
      S.techName = techSel.value;
    } else {
      S.techName = '';
    }
  }catch(e){
    // σιωπηλά
  }
}

// αρχικοποιήσεις
S.role = $('#role').value.trim();
S.srName = $('#srInput').value.trim();
refreshTechs();
</script>
</body>
</html>

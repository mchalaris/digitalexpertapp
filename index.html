<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGITAL EXPERT â€” PHOTOS (Mobile)</title>
<link rel="manifest" href="manifest.webmanifest">
<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--shadow:0 12px 28px rgba(2,6,23,.10);--pill:#0f172a;--pillText:#fff}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
.hidden{display:none!important}

/* Header */
.header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.header .in{max-width:960px;margin:0 auto;padding:12px 14px}
.logoWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.appLogo{width:72px;height:72px;border-radius:18px;box-shadow:0 4px 16px rgba(0,0,0,.18);background:#0b1324;display:flex;align-items:center;justify-content:center;overflow:hidden}
.appLogo img{width:100%;height:100%;object-fit:cover;display:block}
.appTitle{font-weight:900;font-size:16px}
.appSub{color:var(--muted);font-size:12px}

/* Tabs */
.tabs{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.tab{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#fff;text-decoration:none;color:inherit;font-weight:900}
.tab.active{background:var(--pill);color:var(--pillText);border-color:var(--pill)}

/* Layout */
.wrap{max-width:960px;margin:0 auto;padding:12px 12px 100px}
.card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px;margin:12px 0}
.title{font-weight:900;display:flex;gap:8px;align-items:center}
.muted{color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid4{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}

/* Inputs */
.input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px}
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#0f172a;padding:12px;border-radius:14px;font-weight:900}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-weight:800;background:#fff}
.badge.on{background:#0f172a;border-color:#0f172a;color:#fff}

/* Pages */
.page{display:none}
.page.active{display:block}

/* Checklist + gallery items */
.item{border:1px solid var(--line);border-radius:12px;padding:10px;margin:6px 0;background:#fff}
.item.photo{border-left:4px solid #0ea5e9}
.item.video{border-left:4px solid #f59e0b}
.item.file{border-left:4px solid #8b5cf6}
.item.uploaded{border-left-color:#10b981}
.item.error{border-left-color:#ef4444}
.thumb{width:84px;height:84px;border-radius:8px;border:1px solid var(--line);object-fit:cover}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* Progress / status */
.progress{height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden}
.progress > span{display:block;height:100%;background:#111;width:0%;transition:width .3s}
.upload-status{padding:10px;border-radius:8px;background:#f0f9ff;margin-top:12px}
.status-row{display:flex;justify-content:space-between;align-items:center}

/* Bottom bar */
.bottomBar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line)}
.bottomBar .in{max-width:960px;margin:0 auto;padding:8px 12px;display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.bottomBar .btn{padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:12px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Error banner */
#fatal{display:none;position:sticky;top:0;z-index:99999;background:#fee2e2;color:#7f1d1d;padding:10px;font:12px system-ui}

/* Autopsy panel styling */
#autopsyPanel{margin-top:10px}
#autopsyPanel .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
#autopsyPanel label{font-weight:700;font-size:12px}
#autopsyPanel select{padding:6px 8px;border:1px solid #ddd;border-radius:8px}
.badge-info{display:inline-block;padding:4px 8px;border-radius:10px;background:#eef;color:#224;font-size:11px}
.badge.toggle{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:12px;cursor:pointer;font-weight:700}
.badge.toggle.active{background:#111;color:#fff;border-color:#111}
</style>
</head>
<body>
<header class="header">
  <div class="in">
    <div class="logoWrap">
      <div class="appLogo"><img src="https://i.imgur.com/4ZQRP5F.png" alt=""></div>
      <div class="appTitle">DIGITAL EXPERT â€” PHOTOS (Mobile)</div>
      <div class="appSub">Î£Ï…Î»Î»Î¿Î³Î®, Î­Î»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ±Î¹ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Ï…Î»Î¹ÎºÎ¿Ï</div>
    </div>
    <div class="tabs">
      <a class="tab active" href="#/sr">SR & Î¡ÏŒÎ»Î¿Ï‚</a>
      <a class="tab" href="#/gallery">Î£Ï…Î»Î»Î¿Î³Î®</a>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- SR -->
  <section id="page-sr" class="page active" data-page="#/sr">
    <div class="card">
      <div class="title">ğŸ·ï¸ SR & Î¡ÏŒÎ»Î¿Ï‚</div>
      <div class="row" style="margin-top:10px">
        <input id="inSR" class="input" placeholder="SRID Ï€.Ï‡. 2-1234567890">
        <input id="inAddress" class="input" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)">
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnSRApply" class="btn">ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
        <button id="btnSrSearch" class="btn">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· SR</button>
        <div id="srInfo" class="muted">â€”</div>
      </div>
      <div id="srMenu" class="row" style="margin-top:6px"></div>

      <div class="row" style="margin-top:10px;gap:6px">
        <button class="badge on" data-role="ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£">ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î±ÏƒÏ„Î®Ï‚</button>
        <button class="badge" data-role="Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“ÎŸÎ£">Î§Ï‰Î¼Î±Ï„Î¿Ï…ÏÎ³ÏŒÏ‚</button>
        <button class="badge" data-role="Î—Î›Î•ÎšÎ¤Î¡ÎŸÎ›ÎŸÎ“ÎŸÎ£">Î—Î»ÎµÎºÏ„ÏÎ¿Î»ÏŒÎ³Î¿Ï‚</button>
        <button class="badge" data-role="Î‘Î¥Î¤ÎŸÎ¨Î™Î‘">Î‘Ï…Ï„Î¿ÏˆÎ¯Î±</button>
      </div>
      <div id="roleInfo" class="muted" style="margin-top:6px">â€”</div>
    </div>

    <div class="card">
      <div class="title">ğŸ“¦ Modules</div>
      <div class="muted">Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¼ÏŒÎ½Î¿ Ï„Î± Î²Î®Î¼Î±Ï„Î± Ï„Î¿Ï… ÎºÎ¬Î¸Îµ module</div>
      <div id="modulesRow" class="grid3" style="margin-top:10px"></div>
      <div id="moduleInfo" class="muted" style="margin-top:6px">â€”</div>
    </div>

    <div class="card">
      <div class="title">âœ… Checklist</div>
      <div class="muted">Î Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Î»Î®ÏˆÎµÎ¹Ï‚ ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ Î²Î®Î¼Î±: .p01, .p02 Îº.Î»Ï€.</div>
      <div id="checklist" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Gallery -->
  <section id="page-gallery" class="page" data-page="#/gallery">
    <div class="card">
      <div class="title">ğŸ–¼ï¸ Î£Ï…Î»Î»Î¿Î³Î® <span id="itemCount" class="badge" style="margin-left:8px">0</span></div>

      <div class="row" style="margin-top:10px; gap:6px; flex-wrap:wrap">
        <button class="badge filter-btn active" data-filter="all">ÎŒÎ»Î±</button>
        <button class="badge filter-btn" data-filter="photo">ğŸ“· Î¦Ï‰Ï„Î¿</button>
        <button class="badge filter-btn" data-filter="video">ğŸ¥ Î’Î¯Î½Ï„ÎµÎ¿</button>
        <button class="badge filter-btn" data-filter="file">ğŸ“„ Î‘ÏÏ‡ÎµÎ¯Î±</button>
        <button class="badge filter-btn" data-filter="pending">â³ Î•ÎºÎºÏÎµÎ¼Î®</button>
        <button class="badge filter-btn" data-filter="uploaded">âœ… Uploaded</button>
        <button class="badge filter-btn" data-filter="error">â›” Error</button>
      </div>

      <div id="gallery" style="margin-top:12px"></div>

      <div id="galleryEmpty" class="muted" style="text-align:center;padding:20px">
        <div style="font-size:48px">ğŸ“¸</div>
        <div style="margin-top:8px">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± Î±ÎºÏŒÎ¼Î±</div>
        <div style="font-size:12px; margin-top:4px">Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± Â«Î¦Ï‰Ï„Î¿Î³ÏÎ¬Ï†Î¹ÏƒÎ·Â» Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚</div>
      </div>

      <div id="uploadStatus" class="upload-status" style="display:none">
        <div class="status-row">
          <span id="statusText">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·.</span>
          <span id="statusPercent" style="font-weight:600">0%</span>
        </div>
        <div class="progress" style="margin-top:6px"><span id="statusProgress"></span></div>
      </div>

      <div class="grid2" style="margin-top:16px; gap:10px">
        <button id="btnUploadAll" class="btn blk"><span>â˜ï¸ Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span id="uploadCount" class="badge" style="margin-left:6px; background:#fff; color:#111">0</span></button>
        <button id="btnClear" class="btn">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>

      <div id="uploadInfo" class="muted" style="margin-top:8px; font-size:12px">â€”</div>
    </div>

    <!-- Sync -->
    <div class="card">
      <div class="title">ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</div>
      <div class="muted">Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î¹ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î±Î½Î­Î²ÎµÎ¹ Î³Î¹Î± Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ SR</div>
      <div class="row" style="margin-top:10px;gap:8px">
        <button id="btnSyncRefresh" class="btn">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
        <div id="syncInfo" class="muted">â€”</div>
      </div>
      <div id="syncList" style="margin-top:10px"></div>
    </div>

    <!-- Tools -->
    <div class="card">
      <div class="title">ğŸ§° Î•ÏÎ³Î±Î»ÎµÎ¯Î±</div>
      <div class="row" style="margin-top:10px;gap:8px">
        <button id="btnDownloadZip" class="btn">ğŸ“¥ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚ (ZIP)</button>
      </div>
      <div class="muted" style="margin-top:6px">ÎšÎ±Ï„ÎµÎ²Î¬Î¶ÎµÎ¹ ÎŸÎ›Î‘ Ï„Î± Ï„Î¿Ï€Î¹ÎºÎ¬ items (pending / uploaded / error), ÏŒÏ€Ï‰Ï‚ ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î· ÏƒÏ…ÏƒÎºÎµÏ…Î®.</div>
    </div>
  </section>
</div>

<!-- Bottom navigation -->
<div class="bottomBar">
  <div class="in">
    <a class="btn" href="#/sr">ğŸ  Î‘ÏÏ‡Î¹ÎºÎ®</a>
    <a class="btn" href="#/gallery">ğŸ–¼ï¸ Î£Ï…Î»Î»Î¿Î³Î®</a>
    <a class="btn" href="#/gallery">ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</a>
    <button id="btnOpenSettings" class="btn">âš™ï¸ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
  </div>
</div>

<!-- Error banner -->
<div id="fatal">âš ï¸ Î£Ï†Î¬Î»Î¼Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚: <span id="fatalMsg"></span></div>

<!-- Modal -->
<div id="modal" class="modal" aria-modal="true" role="dialog" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center">
  <div id="modalPanel" class="panel" style="background:#fff;border-radius:14px;padding:14px;max-width:640px;width:92%">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div style="flex:1">
        <div class="muted">Î’Î®Î¼Î±</div>
        <div id="modalStepLabel" class="title" style="margin-top:2px"></div>
        <div id="modalStepId" class="muted" style="margin-top:2px"></div>
        <div id="modalStepInfo" class="muted" style="margin-top:4px;font-size:11px"></div>
      </div>
      <button id="btnClose" class="btn">âœ•</button>
    </div>

    <div style="height:1px;background:#e5e7eb;margin:10px 0"></div>

    <div class="grid3">
      <input id="fileCam" type="file" accept="image/*" capture="environment" style="display:none">
      <input id="fileVid" type="file" accept="video/*" capture="environment" style="display:none">
      <input id="fileGal" type="file" accept="image/*,video/*,application/pdf,.iolm,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" multiple style="display:none">
      <button class="btn" id="btnAgain">ğŸ“· ÎšÎ¬Î¼ÎµÏÎ±</button>
      <button class="btn" onclick="document.getElementById('fileVid').click()">ğŸ¥ Î’Î¯Î½Ï„ÎµÎ¿</button>
      <button class="btn" onclick="document.getElementById('fileGal').click()">ğŸ“ Î‘Ï€ÏŒ Î±ÏÏ‡ÎµÎ¯Î¿</button>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="btnNext" class="btn">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿</button>
    </div>
  </div>
</div>

<!-- Settings (placeholder) -->
<div id="de-settings-modal" style="position:fixed;inset:0;z-index:10000;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center">
  <div id="de-settings-card">
    <h3>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</h3>
    <div class="row">
      <label>WEBAPP_URL
        <input id="webappUrlInput" class="input" placeholder="https://script.google.com/macros/s/XXXXX/exec">
      </label>
      <label>Î¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚
        <input id="techNameInput" class="input" placeholder="ÎŒÎ½Î¿Î¼Î± Ï„ÎµÏ‡Î½Î¹ÎºÎ¿Ï">
      </label>
    </div>
    <div id="de-settings-actions">
      <button class="save" id="btnSaveSettings">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      <button id="btnCloseSettings">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG (editable) ---------- */
let WEBAPP_URL = localStorage.getItem('WEBAPP_URL') || ''; // Î²Î¬Î»Ï„Î¿ ÎºÎ±Î¹ Î±Ï€ÏŒ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
const IS_LOCAL_ORIGIN = location.protocol==='file:';

/* ---------- STATE ---------- */
const state = {
  job: null,
  items: [], // {type:'photo'|'video'|'file', name, file, thumb:ObjectURL, stepId, status:'pending'|'uploaded'|'error', destinations:[]}
  filter: 'all',
  checklist: [],
  currentIndex: 0,
  greekRole: 'ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£',
  techName: localStorage.getItem('TECH_NAME') || '',
  geo: null
};

/* ---------- UTILS ---------- */
function nowStamp(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}
function humanSize(bytes){
  const b=Number(bytes||0);
  if(b<1024) return b+' B';
  if(b<1024*1024) return (b/1024).toFixed(1)+' KB';
  return (b/1024/1024).toFixed(1)+' MB';
}
function isHeic(file){ return /\.(heic)$/i.test(file.name||''); }

/* ---------- ROLE ---------- */
document.querySelectorAll('[data-role]').forEach(b=>b.onclick=()=>setRole(b.dataset.role));
const roleInfo=document.getElementById('roleInfo');
function setRole(r){ state.greekRole=r; roleInfo.textContent='Î¡ÏŒÎ»Î¿Ï‚: '+r; }

/* ---------- SR ---------- */
const inAddress=document.getElementById('inAddress'), inSR=document.getElementById('inSR'), btnSRApply=document.getElementById('btnSRApply'), srInfo=document.getElementById('srInfo');
btnSRApply.onclick=()=>{
  const v=inSR.value.trim();
  if(!v){ alert('Î”ÏÏƒÎµ SR'); return; }
  state.job={ srFolderName:v, address:inAddress.value.trim()||'' };
  srInfo.textContent='SR: '+v+(state.job.address?' â€” '+state.job.address:'');
  location.hash='#/gallery';
  refreshUploadedIndex();
  refreshSync();
};

/* ---------- NAV ---------- */
function go(hash){ location.hash=hash; }
window.addEventListener('hashchange',syncTabs);
function syncTabs(){
  const h=location.hash||'#/sr';
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.getAttribute('href')===h));
  document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active',p.dataset.page===h));
}
syncTabs();

/* ---------- CHECKLIST (placeholder minimal) ---------- */
const checklistEl=document.getElementById('checklist');
const modulesRow=document.getElementById('modulesRow'), moduleInfo=document.getElementById('moduleInfo');
state.checklist=[
  {id:'AP_BEP_BEFORE', label:'BEP â€” Î ÏÎ¹Î½', type:'photo'},
  {id:'AP_BEP_AFTER',  label:'BEP â€” ÎœÎµÏ„Î¬', type:'photo'},
  {id:'AP_FSS',        label:'FSS', type:'file'},
  {id:'AP_DESC',       label:'Î ÎµÏÎ¹Î³ÏÎ±Ï†Î¹ÎºÏŒ Î’Î¯Î½Ï„ÎµÎ¿', type:'video'}
];
function renderChecklist(){
  checklistEl.innerHTML='';
  state.checklist.forEach((s,i)=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">${s.label}</div>
      <button class="btn">Î†Î½Î¿Î¹Î³Î¼Î±</button>
    </div>`;
    row.querySelector('button').onclick=()=>openModalAt(i);
    checklistEl.appendChild(row);
  });
}
renderChecklist();

/* ---------- MODAL ---------- */
const modal=document.getElementById('modal'), modalPanel=document.getElementById('modalPanel');
const modalStepLabel=document.getElementById('modalStepLabel'), modalStepId=document.getElementById('modalStepId'), modalStepInfo=document.getElementById('modalStepInfo');
const btnClose=document.getElementById('btnClose'), btnNext=document.getElementById('btnNext'), btnAgain=document.getElementById('btnAgain');
const fileCam=document.getElementById('fileCam'), fileGal=document.getElementById('fileGal'), fileVid=document.getElementById('fileVid');

function openModalAt(i){
  state.currentIndex=i; const step=state.checklist[i];
  modalStepLabel.textContent=step?step.label:'-';
  modalStepId.textContent=step?('stepId: '+step.id):'-';
  modalStepInfo.textContent=step?(step.type==='video'?'Î’Î¯Î½Ï„ÎµÎ¿ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®Ï‚ (<=50MB)':(step.type==='file'?'Î‘ÏÏ‡ÎµÎ¯Î¿ FSS (.xls/.xlsx)':'Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Ï„ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·Ï‚')):'-';
  if(step && step.id==='AP_FSS'){ fileGal.setAttribute('accept','application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); }
  else { fileGal.setAttribute('accept','image/*,video/*,application/pdf,.iolm'); }
  document.body.style.overflow='hidden';
  modal.style.display='flex';
}
function closeModal(){ modal.style.display='none'; document.body.style.overflow=''; }
modal.onclick=closeModal; modalPanel.onclick=e=>e.stopPropagation();
btnClose.onclick=closeModal;
btnAgain.onclick=()=>fileCam.click();
btnNext.onclick=()=>{ if(state.currentIndex<state.checklist.length-1){ state.currentIndex++; openModalAt(state.currentIndex);} else closeModal(); };

/* ---------- ADD ITEMS ---------- */
const galleryEl=document.getElementById('gallery'), galleryEmpty=document.getElementById('galleryEmpty');
const itemCount=document.getElementById('itemCount'), uploadCount=document.getElementById('uploadCount');
function validateFile(file,isGeneric){
  if(!file) throw new Error('Î†ÎºÏ…ÏÎ¿ Î±ÏÏ‡ÎµÎ¯Î¿');
  if(!isGeneric && file.type && !/^(image|video)\//.test(file.type) && !/(\.pdf|\.xls|\.xlsx|\.iolm)$/i.test(file.name||''))
    throw new Error('ÎœÎ· Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿: '+(file.type||file.name));
}
function destinationsFor(step){
  const d=['PHOTOS'];
  if(step && step.id && /BEP/i.test(step.id)) d.unshift('BEP');
  return d;
}
function ensureThumb(item){
  if(item.thumb) return;
  try{
    if(item.type==='photo'){ item.thumb=URL.createObjectURL(item.file); }
    else if(item.type==='video'){ item.thumb=''; } // leave empty to avoid heavy work
    else { item.thumb=''; }
  }catch(e){ item.thumb=''; }
}
function addShotFromFile(file){
  validateFile(file,false);
  const step=state.checklist[state.currentIndex];
  const base=(step?step.id:'SHOT')+'_'+nowStamp();
  const name=base+'.jpg';
  const dest=destinationsFor(step);
  const item={type:'photo',name,destinations:dest,stepId:(step?step.id:''),file,status:'pending'};
  state.items.push(item); renderGallery(); uploadInfo.textContent='âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±';
}
function addVideoFromFile(file){
  validateFile(file,false);
  const step=state.checklist[state.currentIndex];
  const base=(step?step.id:'VIDEO')+'_'+nowStamp();
  const name=base+'.mp4';
  const dest=destinationsFor(step);
  const item={type:'video',name,destinations:dest,stepId:(step?step.id:''),file,status:'pending'};
  state.items.push(item); renderGallery(); uploadInfo.textContent='âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î²Î¯Î½Ï„ÎµÎ¿';
}
function addFssFile(file){
  const step=state.checklist[state.currentIndex];
  const name=/xlsx$/i.test(file.name||'')?('FSS_'+nowStamp()+'.xlsx'):('FSS_'+nowStamp()+'.xls');
  const dest=destinationsFor(step); const item={type:'file',name,destinations:dest,stepId:step.id,file,status:'pending'};
  state.items.push(item); renderGallery(); uploadInfo.textContent='âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ FSS';
}

/* Inputs */
fileCam.onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(f){ addShotFromFile(f); } e.target.value=''; };
fileVid.onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(f){ addVideoFromFile(f); } e.target.value=''; };
fileGal.onchange=e=>{
  const files=[...(e.target.files||[])]; if(!files.length) return;
  const step=state.checklist[state.currentIndex];
  for(const f of files){
    const low=(f.name||'').toLowerCase();
    if(step && step.id==='AP_FSS' && /\.(xls|xlsx)$/i.test(low)){ addFssFile(f); continue; }
    if((f.type||'').startsWith('video')){ addVideoFromFile(f); continue; }
    addShotFromFile(f);
  }
  e.target.value='';
};

/* ---------- GALLERY RENDER ---------- */
document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.filter=b.dataset.filter; renderGallery();}));
function renderGallery(){
  const list=state.items.filter(it=>{
    switch(state.filter){
      case 'photo':return it.type==='photo';
      case 'video':return it.type==='video';
      case 'file':return it.type==='file';
      case 'pending':return !it.status||it.status==='pending';
      case 'uploaded':return it.status==='uploaded';
      case 'error':return it.status==='error';
      default:return true;
    }
  });
  galleryEl.innerHTML=''; itemCount.textContent=`${list.length}/${state.items.length}`; uploadCount.textContent=state.items.length;
  if(!list.length){galleryEmpty.style.display='block';return;} galleryEmpty.style.display='none';
  list.forEach(item=>{
    const box=document.createElement('div'); box.className=`item ${item.type} ${item.status||'pending'}`;
    const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between';
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=item.type==='video'?'ğŸ¥ Î’Î¯Î½Ï„ÎµÎ¿':(item.type==='photo'?'ğŸ“· Î¦Ï‰Ï„Î¿':'ğŸ“„ Î‘ÏÏ‡ÎµÎ¯Î¿');
    const st=document.createElement('span'); st.className='badge'; st.textContent=item.status||'pending'; head.append(badge,st);
    const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='10px'; row.style.margin='8px 0';
    const img=document.createElement('img'); img.className='thumb'; if(item.thumb) img.src=item.thumb; else ensureThumb(item);
    const name=document.createElement('div'); name.className='mono'; name.style.flex='1'; name.textContent=item.name;
    const rep=document.createElement('button'); rep.className='btn'; rep.textContent='ğŸ”'; rep.onclick=()=>{ const i=document.createElement('input'); i.type='file'; i.accept=item.type==='photo'?'image/*':(item.type==='video'?'video/*':'application/pdf,.iolm,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); i.onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; try{ validateFile(f,item.type==='file'); item.file=f; item.status='pending'; if(item.thumb) try{URL.revokeObjectURL(item.thumb)} catch(e){ } item.thumb=null; ensureThumb(item); renderGallery(); } catch(err){ alert(err.message); } }; i.click(); };
    row.append(img,name,rep);
    const meta=document.createElement('div'); meta.className='muted'; meta.textContent=[`Î²Î®Î¼Î±: ${item.stepId||'-'}`,`Î¼Î­Î³ÎµÎ¸Î¿Ï‚: ${(item.file.size/1024/1024).toFixed(1)}MB`].join(' â€¢ ');
    const dest=document.createElement('div'); dest.className='muted'; dest.style.fontSize='11px'; dest.textContent='ğŸ“ '+(item.destinations||[]).join(' / ');
    box.append(head,row,meta,dest);
    galleryEl.appendChild(box);
  });
}
renderGallery();

/* ---------- UPLOAD ---------- */
const uploadInfo=document.getElementById('uploadInfo');
const uploadStatus=document.getElementById('uploadStatus'), statusText=document.getElementById('statusText'), statusPercent=document.getElementById('statusPercent'), statusProgress=document.getElementById('statusProgress');
async function robustReadBase64(file){
  const buf = await file.arrayBuffer();
  let binary = ''; const bytes = new Uint8Array(buf); const len = bytes.byteLength;
  for (let i=0;i<len;i++){ binary += String.fromCharCode(bytes[i]); }
  return btoa(binary);
}
async function compressPhotoToJpegB64(file){
  // light touch: we keep it simple here; in previous versions we used canvas/quality
  const buf=await file.arrayBuffer(); let binary=''; const bytes=new Uint8Array(buf); for(let i=0;i<bytes.length;i++){binary+=String.fromCharCode(bytes[i]);}
  return btoa(binary);
}
async function uploadToDrive(srName, items){
  const cand=items.slice(); if(!cand.length) return;
  uploadStatus.style.display='block'; statusText.textContent='Î‘Î½Î­Î²Î±ÏƒÎ¼Î±â€¦';
  let done=0, failed=0; const failedNames=[];
  for(let i=0;i<cand.length;i++){
    const it=cand[i]; try{
      statusPercent.textContent=Math.round((i/cand.length)*100)+'%'; statusProgress.style.width=Math.round((i/cand.length)*100)+'%';
      let b64,mime='application/octet-stream';
      if(it.type==='photo'){ b64=await compressPhotoToJpegB64(it.file); mime='image/jpeg'; }
      else { const ab=await it.file.arrayBuffer(); let bin=''; const bytes=new Uint8Array(ab); for(let j=0;j<bytes.length;j++){ bin+=String.fromCharCode(bytes[j]); } b64=btoa(bin); mime=it.file.type||'application/octet-stream'; }
      const payload={srName,techName:(state.techName||''),role:(state.greekRole||''),geo:(state.geo||null),files:[{filename:it.name,mimeType:mime,contentBase64:b64,destinations:it.destinations||['PHOTOS']}]};
      const res=await fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)});
      const text=await res.text(); let json; try{ json=JSON.parse(text); } catch(e){ throw new Error('ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·'); }
      if(!json.ok) throw new Error(json.error||'ok:false');
      it.status='uploaded'; renderGallery(); done++;
    }catch(e){ it.status='error'; failed++; failedNames.push(it.name); renderGallery(); }
  }
  statusText.textContent='ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ'; statusPercent.textContent='100%'; statusProgress.style.width='100%';
  setTimeout(()=>uploadStatus.style.display='none',1200);
  const msg=`Î‘Î½Î­Î²Î·ÎºÎ±Î½: ${done}`+(failed?` â€” Î‘Ï€Î­Ï„Ï…Ï‡Î±Î½: ${failed}`:''); uploadInfo.textContent=msg; if(failed) alert(msg+'\\n- '+failedNames.join('\\n- '));
}
document.getElementById('btnUploadAll').onclick=()=>{ if(!state.job||!state.job.srFolderName){alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ SR ÎºÎ±Î¹ Ï€Î¬Ï„Î± ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚');go('#/sr');return;} if(!state.items.length){alert('Î— ÏƒÏ…Î»Î»Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î±');return;} uploadToDrive(state.job.srFolderName,state.items); };
document.getElementById('btnClear').onclick=()=>{ if(confirm('ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î»Î¯ÏƒÏ„Î±Ï‚;')){ state.items.forEach(it=>{ if(it.thumb) try{URL.revokeObjectURL(it.thumb)} catch(e){ } }); state.items=[]; renderGallery(); uploadInfo.textContent='â€”'; } };

/* ---------- listUploaded / Sync preview & open ---------- */
var uploadedIndex={ byToken:new Map(), byName:new Set() };
function getStepToken(name){ return String(name||'').toLowerCase().replace(/\.(jpg|jpeg|png|mp4|pdf|xls|xlsx)$/i,'').replace(/\s+/g,'').replace(/\.p\d{2}$/i,''); }
function buildUploadedIndex(items){
  uploadedIndex.byToken = new Map(); uploadedIndex.byName=new Set();
  (items||[]).forEach(it=>{ uploadedIndex.byName.add(String(it.name||'').toLowerCase()); const t=String(it.token||getStepToken(it.name||'')); const arr=uploadedIndex.byToken.get(t)||[]; arr.push(it); uploadedIndex.byToken.set(t,arr); });
}
function refreshUploadedIndex(){
  if(!state.job || !state.job.srFolderName){ return Promise.resolve(); }
  return fetch(WEBAPP_URL+'?action=listUploaded&sr='+encodeURIComponent(state.job.srFolderName)+'&t='+(Date.now()))
    .then(res=>res.json()).then(json=>{ if(json && json.ok){ buildUploadedIndex(json.items||json.files||[]); } });
}

const syncInfo=document.getElementById('syncInfo'), syncList=document.getElementById('syncList');
function refreshSync(){
  if(!state.job || !state.job.srFolderName){ syncInfo.textContent='Î”Î¹Î¬Î»ÎµÎ¾Îµ SR'; syncList.innerHTML=''; return; }
  syncInfo.textContent='Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦'; syncList.innerHTML='';
  fetch(WEBAPP_URL+'?action=listUploaded&sr='+encodeURIComponent(state.job.srFolderName)+'&t='+(Date.now()))
    .then(r=>r.json())
    .then(j=>{
      if(!j || j.ok===false) throw new Error(j && j.error || 'listUploaded failed');
      const items=j.items||j.files||[]; buildUploadedIndex(items);
      // group by token
      const map={}; items.forEach(f=>{ const t=getStepToken(f.name||''); (map[t]=map[t]||[]).push(f); });
      const tokens=Object.keys(map).sort((a,b)=>a.localeCompare(b,'el'));
      syncInfo.textContent='Î£ÏÎ½Î¿Î»Î¿ Î±ÏÏ‡ÎµÎ¯Ï‰Î½: '+items.length+' â€¢ Î’Î®Î¼Î±Ï„Î±: '+tokens.length;
      tokens.forEach(tok=>{
        const arr=map[tok].sort((a,b)=>String(a.name).localeCompare(String(b.name),'el'));
        const box=document.createElement('div'); box.className='item';
        const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
        const t=document.createElement('div'); t.style.fontWeight='900'; t.textContent=tok;
        const c=document.createElement('div'); c.className='badge'; c.textContent=arr.length+' Î±ÏÏ‡ÎµÎ¯Î±';
        head.appendChild(t); head.appendChild(c);
        const ul=document.createElement('div'); ul.className='muted'; ul.style.fontSize='11px'; ul.style.marginTop='6px';
        ul.innerHTML = arr.map(f=>{
          const view = f.id ? ` <a target="_blank" href="https://drive.google.com/file/d/${f.id}/view">Î†Î½Î¿Î¹Î³Î¼Î±</a>` : '';
          return `â€¢ ${f.name} â€” ${humanSize(f.size||0)}${view}`;
        }).join('<br>');
        box.appendChild(head); box.appendChild(ul);
        syncList.appendChild(box);
      });
    })
    .catch(err=>{ syncInfo.textContent='Î£Ï†Î¬Î»Î¼Î±: '+(err && err.message || 'â€”'); });
}
document.getElementById('btnSyncRefresh').onclick=refreshSync;

/* ---------- ZIP: download ALL local (pending/uploaded/error) ---------- */
async function downloadAllAsZip(){
  if(!state.items.length){ alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„Î¿Ï€Î¹ÎºÎ¬ Î±ÏÏ‡ÎµÎ¯Î±'); return; }
  const zip=new JSZip(); const folderName=(state.job && state.job.srFolderName) ? state.job.srFolderName : 'photos';
  const root=zip.folder(folderName);
  let added=0, skipped=0;
  for(const it of state.items){
    try{
      if(!it.file){ skipped++; continue; }
      const buf=await it.file.arrayBuffer();
      root.file(it.name, buf);
      added++;
    }catch(_){ skipped++; }
  }
  const blob=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`${folderName}_${nowStamp()}.zip`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  if(skipped){ alert(`ZIP Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ: ${added} Î±ÏÏ‡ÎµÎ¯Î± â€” ${skipped} Ï‡Ï‰ÏÎ¯Ï‚ blob`); }
}
document.getElementById('btnDownloadZip').onclick=downloadAllAsZip;

/* ---------- Settings ---------- */
document.getElementById('btnOpenSettings').onclick=()=>{ document.getElementById('de-settings-modal').style.display='flex'; document.getElementById('webappUrlInput').value=WEBAPP_URL; document.getElementById('techNameInput').value=state.techName; };
document.getElementById('btnCloseSettings').onclick=()=>{ document.getElementById('de-settings-modal').style.display='none'; };
document.getElementById('btnSaveSettings').onclick=()=>{
  WEBAPP_URL = document.getElementById('webappUrlInput').value.trim();
  state.techName = document.getElementById('techNameInput').value.trim();
  localStorage.setItem('WEBAPP_URL', WEBAPP_URL);
  localStorage.setItem('TECH_NAME', state.techName);
  document.getElementById('de-settings-modal').style.display='none';
};

/* ---------- Service Worker ---------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>

<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGITAL EXPERT â€” PHOTOS</title>

<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
    --brand:#0f172a; --accent:#2563eb; --danger:#e11d48; --ok:#16a34a;
    --shadow:0 12px 28px rgba(2,6,23,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.accent{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn:disabled{opacity:.5;cursor:default}
  .input,select{border:1px solid var(--line);border-radius:10px;padding:8px 10px;min-width:140px;background:#fff}
  h1{font-size:20px;margin:8px 0 16px}
  h2{font-size:16px;margin:8px 0 12px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{flex:1;text-align:center;padding:10px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .tab.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .hidden{display:none!important}

  /* Gallery thumbs */
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  .thumb{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#f3f4f6}
  .thumb img{display:block;width:100%;height:110px;object-fit:cover}
  .thumb .cap{position:absolute;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);color:#fff;font-size:11px;padding:4px 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* Bottom nav */
  .nav{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--line);display:flex;gap:8px;padding:10px}
  .nav button{flex:1}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .sheet{background:#fff;border-radius:16px;max-width:800px;width:100%;max-height:85vh;overflow:auto;padding:16px}
  .modal.show{display:flex}
  .pill{display:inline-block;background:#0f172a;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" style="text-align:center">
    <img src="favicon.png" alt="" style="width:84px;height:84px;border-radius:20px;box-shadow:var(--shadow)">
    <h1>DIGITAL EXPERT â€” PHOTOS</h1>
    <div style="color:var(--muted)">Your Technology Partner</div>
  </div>

  <!-- SR & Î¡ÏŒÎ»Î¿Ï‚ -->
  <div class="card">
    <h2>SR & Î¡ÏŒÎ»Î¿Ï‚</h2>
    <div class="row">
      <input id="inp-sr" class="input" placeholder="SR Ï€.Ï‡. 2-329016..." />
      <select id="sel-role">
        <option value="ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£">ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£</option>
        <option value="Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“ÎŸÎ£">Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“ÎŸÎ£</option>
        <option value="Î‘Î¥Î¤ÎŸÎ¨Î™Î‘">Î‘Î¥Î¤ÎŸÎ¨Î™Î‘</option>
      </select>
      <input id="inp-tech" class="input" placeholder="Î¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚" />
      <button class="btn" id="btn-search-sr">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· SR</button>
    </div>
    <div id="sr-results" style="margin-top:8px;color:var(--muted)"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="home">ğŸ“¸ Î¦Ï‰Ï„Î¿Î³ÏÎ¬Ï†Î¹ÏƒÎ·</div>
    <div class="tab" data-tab="sync">ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</div>
    <div class="tab" data-tab="tools">ğŸ§° Î•ÏÎ³Î±Î»ÎµÎ¯Î±</div>
  </div>

  <!-- HOME: Î‘Ï…Ï„Î¿ÏˆÎ¯Î± -->
  <div class="card panel" id="panel-home">
    <h2>ğŸ“ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î‘Ï…Ï„Î¿ÏˆÎ¯Î±Ï‚</h2>
    <div class="row">
      <label>Î§Ï‰Î¼Î±Ï„Î¿Ï…ÏÎ³Î¹ÎºÏŒ:
        <select id="aft-xoma" class="input">
          <option>NAI</option><option>OXI</option>
        </select>
      </label>
      <label>Î’Î±Î¸Î¼ÏŒÏ‚ Î´Ï…ÏƒÎºÎ¿Î»Î¯Î±Ï‚:
        <select id="aft-vathmos" class="input">
          <option>Î’Î”1</option><option selected>Î’Î”2</option><option>Î’Î”3</option>
        </select>
      </label>
      <label>Smart Readiness:
        <select id="aft-smart" class="input">
          <option>NAI</option><option>OXI</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label class="input"><input type="checkbox" id="sp-mhe"> SP: MHE</label>
      <label class="input"><input type="checkbox" id="sp-fy"> SP: Î¦Î¥</label>
      <label class="input"><input type="checkbox" id="sp-ko"> SP: ÎšÎŸ</label>
      <label class="input"><input type="checkbox" id="sp-ma"> SP: ÎœÎ‘</label>
    </div>
    <div class="row">
      <label>Î¤ÏÏ€Î¿Ï‚ ÎŒÎ´ÎµÏ…ÏƒÎ·Ï‚:
        <select id="aft-odeysi" class="input">
          <option>ÎšÎ¬Î³ÎºÎµÎ»Î¿</option><option>ÎŒÏˆÎ·</option><option>Î•ÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ¬</option>
        </select>
      </label>
      <label>Î’Î‘ ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î±ÏƒÏ„Î¹ÎºÎ¿Ï:
        <select id="aft-bakas" class="input">
          <option>Î’Î”1</option><option>Î’Î”2</option><option selected>Î’Î”3</option>
        </select>
      </label>
      <label>ÎŒÏÎ¿Ï†Î¿Ï‚ BEP:
        <select id="aft-orofos" class="input">
          <option>F+00</option><option>F+01</option><option>F-01</option>
        </select>
      </label>
      <label>Î•Ï€Î¯Ï€ÎµÎ´Î± ÎºÏ„Î¹ÏÎ¯Î¿Ï…:
        <select id="aft-epipeda" class="input">
          <option>2</option><option>3</option><option selected>4</option><option>5</option>
        </select>
      </label>
      <label>Status:
        <select id="aft-status" class="input">
          <option>Î Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘Î¤Î™Î£ÎœÎŸÎ£</option><option selected>ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î—</option><option>Î‘ÎÎ‘Î’ÎŸÎ›Î—</option>
        </select>
      </label>
    </div>
    <div class="row">
      <button class="btn primary" id="btn-aftopsia-send">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Sheet</button>
      <div id="aft-msg" style="align-self:center;color:var(--muted)"></div>
    </div>
  </div>

  <!-- SYNC -->
  <div class="card panel hidden" id="panel-sync">
    <h2>ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ â€” Î ÏÎ¿Î²Î¿Î»Î® Î±ÏÏ‡ÎµÎ¯Ï‰Î½ SR</h2>
    <div class="row">
      <select id="sel-sync-sub" class="input">
        <option value="">(ÎŒÎ»Î± ÏƒÏ„Î¿ SR)</option>
        <option value="PHOTOS/BEP">PHOTOS/BEP</option>
        <option value="PHOTOS/BMO">PHOTOS/BMO</option>
        <option value="PHOTOS/FB">PHOTOS/FB</option>
        <option value="ÎœÎ•Î¤Î¡Î—Î£Î•Î™Î£">ÎœÎ•Î¤Î¡Î—Î£Î•Î™Î£</option>
        <option value="Î£Î§Î•Î”Î™Î‘">Î£Î§Î•Î”Î™Î‘</option>
      </select>
      <button class="btn" id="btn-sync-load">Î¦ÏŒÏÏ„Ï‰ÏƒÎµ</button>
    </div>
    <div id="sync-count" style="margin:8px 0;color:var(--muted)"></div>
    <div class="grid" id="sync-grid"></div>
  </div>

  <!-- TOOLS -->
  <div class="card panel hidden" id="panel-tools">
    <h2>ğŸ§° Î•ÏÎ³Î±Î»ÎµÎ¯Î±</h2>
    <div class="row">
      <button class="btn" id="btn-pending-open">Î•ÎºÎºÏÎµÎ¼Î®</button>
      <button class="btn accent" id="btn-download-all">ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚ (ZIP)</button>
      <button class="btn danger" id="btn-close-all">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>

</div>

<!-- Pending modal -->
<div class="modal" id="modal-pending">
  <div class="sheet">
    <h2>Î•ÎºÎºÏÎµÎ¼Î® Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± Î±Î½Î­Î²Î±ÏƒÎ¼Î±</h2>
    <div id="pending-list" style="margin:10px 0"></div>
    <div class="row">
      <button class="btn" id="btn-pending-retry">Î•Ï€Î±Î½Î±Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±</button>
      <button class="btn" id="btn-pending-clear">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      <button class="btn" id="btn-pending-close">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
</div>

<!-- JSZip & FileSaver Î³Î¹Î± ZIP -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ========= CONFIG (Î²Î¬Î»Îµ Ï„Î¿ web app URL) ========= */
const WEB_APP_URL = '<<Î’Î‘Î›Î•_Î•Î”Î©_Î¤ÎŸ_DEPLOYED_APPS_SCRIPT_URL>>';

/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
const on = (el,ev,fn)=> el && el.addEventListener(ev,fn);
function toast(msg){ alert(msg); }
function val(id){ return $(id).value.trim(); }
function getSR(){ return $('#inp-sr').value.trim(); }
function getRole(){ return $('#sel-role').value.trim(); }
function getTech(){ return $('#inp-tech').value.trim(); }
function sanitizeName(n){ return (n||'').toString().split('/').pop().replace(/[<>:"/\\|?*\x00-\x1F]/g,'_'); }

/* ========= Tabs ========= */
document.querySelectorAll('.tab').forEach(t=>{
  on(t,'click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target = t.getAttribute('data-tab');
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
    $('#panel-'+target).classList.remove('hidden');
  });
});

/* ========= SR search demo (Ï€ÏÎ¿Î²Î¿Î»Î® Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½) ========= */
on($('#btn-search-sr'),'click', async ()=>{
  const q = getSR();
  if (!q) return toast('Î”ÏÏƒÎµ SR Î® ÎºÎµÎ½ÏŒ Î³Î¹Î± ÏŒÎ»Î±.');
  const url = WEB_APP_URL + '?action=search&query=' + encodeURIComponent(q);
  const r = await fetch(url);
  const data = await r.json();
  if (!data.ok) { toast('Î£Ï†Î¬Î»Î¼Î±: '+data.error); return; }
  $('#sr-results').textContent = data.results.length ? 
    ('Î’ÏÎ­Î¸Î·ÎºÎ±Î½ '+data.results.length+' Ï†Î¬ÎºÎµÎ»Î¿Î¹') : 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï†Î¬ÎºÎµÎ»Î¿Î¹';
});

/* ========= Aftopsia send ========= */
on($('#btn-aftopsia-send'),'click', async ()=>{
  const payload = {
    srName: getSR(),
    role: getRole(),
    techName: getTech(),
    xomatourgiko: $('#aft-xoma').value,
    vathmos: $('#aft-vathmos').value,
    smart: $('#aft-smart').value,
    sp_mhe: $('#sp-mhe').checked,
    sp_fy:  $('#sp-fy').checked,
    sp_ko:  $('#sp-ko').checked,
    sp_ma:  $('#sp-ma').checked,
    typosOdeysis: $('#aft-odeysi').value,
    baKatas: $('#aft-bakas').value,
    orofosBep: $('#aft-orofos').value,
    epipeda: $('#aft-epipeda').value,
    status: $('#aft-status').value
  };
  if (!payload.srName) { toast('Î”ÏÏƒÎµ SR.'); return; }
  const res = await fetch(WEB_APP_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'aftopsiaSave', payload })
  }).then(r=>r.json()).catch(()=>({ok:false,error:'network'}));
  $('#aft-msg').textContent = res.ok ? 'âœ… ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® ÏƒÏ„Î¿ Sheet' : ('âŒ '+res.error);
});

/* ========= Sync (preview grid) ========= */
on($('#btn-sync-load'),'click', async ()=>{
  const sr = getSR();
  const sub = $('#sel-sync-sub').value;
  if (!sr) { toast('Î”ÏÏƒÎµ SR.'); return; }
  const url = WEB_APP_URL + '?action=listUploaded&sr='+encodeURIComponent(sr)+'&sub='+encodeURIComponent(sub||'');
  const r = await fetch(url);
  const data = await r.json();
  if (!data.ok) { toast('Î£Ï†Î¬Î»Î¼Î±: '+data.error); return; }

  $('#sync-count').textContent = data.files.length ? ('Î‘ÏÏ‡ÎµÎ¯Î±: '+data.files.length) : 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î±.';
  const grid = $('#sync-grid');
  grid.innerHTML = '';
  data.files.forEach(f=>{
    const div = document.createElement('div');
    div.className = 'thumb';
    const src = f.thumb || f.viewUrl; // thumbnail Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹, Î±Î»Î»Î¹ÏÏ‚ full
    div.innerHTML = `
      <img loading="lazy" src="${src}">
      <div class="cap" title="${sanitizeName(f.name)}">${sanitizeName(f.name)}</div>
    `;
    div.addEventListener('click', ()=> window.open(f.viewUrl, '_blank'));
    grid.appendChild(div);
  });
});

/* ========= Pending modal (demo hooks Î³Î¹Î± UI) ========= */
const modal = $('#modal-pending');
on($('#btn-pending-open'),'click', ()=> { renderPendingList(); modal.classList.add('show'); });
on($('#btn-pending-close'),'click', ()=> modal.classList.remove('show'));

on($('#btn-pending-retry'),'click', ()=>{
  // Î•Î´Ï ÎºÎ±Î»ÎµÎ¯Ï‚ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ¿Ï… uploader Î½Î± Î¾Î±Î½Î±Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÎµÎ¹.
  toast('Î•Ï€Î±Î½Î±Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±: Î¸Î± Î³Î¯Î½ÎµÎ¹ Î±Ï€ÏŒ Ï„Î¿Î½ uploader ÏƒÎ¿Ï….');
});
on($('#btn-pending-clear'),'click', ()=>{
  // ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎ¼Î± local queues (prefix de:queue:)
  const keys = [];
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (k && k.startsWith('de:queue:')) keys.push(k);
  }
  keys.forEach(k=>localStorage.removeItem(k));
  renderPendingList();
  toast('ÎšÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎ±Î½ Î¿Î¹ Ï„Î¿Ï€Î¹ÎºÎ­Ï‚ ÎµÎºÎºÏÎµÎ¼ÏŒÏ„Î·Ï„ÎµÏ‚.');
});

function renderPendingList(){
  const box = $('#pending-list');
  const items = [];
  // Î±Ï€ÏŒ in-memory
  if (Array.isArray(window.DE_UPLOAD_QUEUE)) {
    window.DE_UPLOAD_QUEUE.forEach(x=>items.push(x.filename||x.name||'(Ï‡Ï‰ÏÎ¯Ï‚ ÏŒÎ½Î¿Î¼Î±)'));
  }
  // Î±Ï€ÏŒ localStorage
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (!k || !k.startsWith('de:queue:')) continue;
    const raw = localStorage.getItem(k);
    try{
      const obj = JSON.parse(raw);
      items.push(obj.filename || obj.name || '(Ï‡Ï‰ÏÎ¯Ï‚ ÏŒÎ½Î¿Î¼Î±)');
    }catch(_){}
  }
  if (!items.length) { box.innerHTML = '<div>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î±.</div>'; return; }
  box.innerHTML = '<ul>'+items.map(x=>'<li>'+sanitizeName(x)+'</li>').join('')+'</ul>';
}

/* ========= ZIP Download ÎŸÎ›Î©Î Ï„Ï‰Î½ Ï„Î¿Ï€Î¹ÎºÏÎ½ ========= */
on($('#btn-download-all'),'click', handleZipAll);

async function handleZipAll(){
  const btn = $('#btn-download-all');
  btn.disabled = true;
  try{
    const items = [];

    // 1) In-memory queue
    if (Array.isArray(window.DE_UPLOAD_QUEUE)) {
      for (const it of window.DE_UPLOAD_QUEUE) {
        const picked = await normalizeItemToFile(it);
        if (picked) items.push(picked);
      }
    }
    // 2) localStorage prefix de:queue:
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if (!k || !k.startsWith('de:queue:')) continue;
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      let obj=null; try{ obj = JSON.parse(raw); }catch(_){}
      const picked = await normalizeItemToFile(obj);
      if (picked) items.push(picked);
    }
    // 3) indexedDB DE_APP/queue (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
    try{
      const idbItems = await readAllFromIDB('DE_APP','queue');
      for (const it of idbItems) {
        const picked = await normalizeItemToFile(it);
        if (picked) items.push(picked);
      }
    }catch(_){}

    if (!items.length){ toast('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï„Î¿Ï€Î¹ÎºÎ¬ Î±ÏÏ‡ÎµÎ¯Î± Ï€ÏÎ¿Ï‚ backup.'); return; }

    const zip = new JSZip();
    const folder = zip.folder('photos') || zip;
    let seq=1;
    for (const it of items){
      const name = sanitizeName(it.name) || `photo_${String(seq++).padStart(4,'0')}.${inferExt(it.type)}`;
      folder.file(name, it.blob);
    }
    const blob = await zip.generateAsync({type:'blob'});
    const stamp = new Date().toISOString().replace(/[:.]/g,'-');
    const zipName = `photos_backup_${stamp}.zip`;
    if (window.saveAs) saveAs(blob, zipName);
    else {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = zipName;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
    }
  }catch(err){
    console.error(err); toast('Î£Ï†Î¬Î»Î¼Î± ZIP: '+(err&&err.message||err));
  }finally{
    btn.disabled = false;
  }
}

function inferExt(mime){
  const t=(mime||'').toLowerCase();
  if (t.includes('png')) return 'png';
  if (t.includes('webp')) return 'webp';
  if (t.includes('heic')) return 'heic';
  if (t.includes('pdf')) return 'pdf';
  return 'jpg';
}
function dataUrlToBlob(dataUrl){
  const [head,data] = String(dataUrl).split(',');
  const isB64 = /;base64/i.test(head);
  const mime = (head.match(/data:([^;]+)/)||[,'application/octet-stream'])[1];
  if (isB64){
    const bin = atob(data); const arr=new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new Blob([arr],{type:mime});
  }else{
    const dec = decodeURIComponent(data);
    return new Blob([dec],{type:mime});
  }
}
async function base64ToBlob(b64, mime='application/octet-stream'){
  const resp = await fetch(`data:${mime};base64,`+b64);
  return await resp.blob();
}
async function normalizeItemToFile(it){
  if (!it) return null;
  const name = it.filename || it.name || '';
  const type = it.mimeType || it.type || 'image/jpeg';
  if (it instanceof Blob) return { name, type: it.type||type, blob: it };
  if (it.file instanceof Blob) return { name: it.file.name||name, type: it.file.type||type, blob: it.file };
  if (it.blob instanceof Blob) return { name, type: it.blob.type||type, blob: it.blob };
  if (it.dataUrl && String(it.dataUrl).startsWith('data:')) {
    const b = dataUrlToBlob(it.dataUrl); return { name, type: b.type||type, blob: b };
  }
  const b64 = it.base64 || it.contentBase64;
  if (b64) {
    const b = await base64ToBlob(b64, type); return { name, type: b.type||type, blob: b };
  }
  if (it.file && it.file.base64) {
    const b = await base64ToBlob(it.file.base64, it.file.mimeType||type);
    return { name: it.file.name||name, type: b.type, blob: b };
  }
  return null;
}
function readAllFromIDB(dbName, storeName){
  return new Promise((resolve)=>{
    const op = indexedDB.open(dbName);
    op.onerror = ()=> resolve([]);
    op.onsuccess = ()=>{
      const db = op.result;
      if (!db.objectStoreNames.contains(storeName)) { resolve([]); return; }
      const tx = db.transaction(storeName,'readonly');
      const st = tx.objectStore(storeName);
      const out=[];
      const cur = st.openCursor();
      cur.onsuccess = e=>{
        const c = e.target.result;
        if (c){ out.push(c.value); c.continue(); } else resolve(out);
      };
      cur.onerror = ()=> resolve([]);
    };
    op.onupgradeneeded = ()=> resolve([]);
  });
}

/* ========= Close (UI only) ========= */
on($('#btn-close-all'),'click', ()=> window.history.back());
</script>
</body>
</html>

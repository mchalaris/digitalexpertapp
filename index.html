<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIGITAL EXPERT â€” PHOTOS (Mobile)</title>
<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
<style>
:root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--shadow:0 12px 28px rgba(2,6,23,.10);--pill:#0f172a;--pillText:#fff}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
.hidden{display:none!important}

/* Header */
.header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.header .in{max-width:960px;margin:0 auto;padding:12px 14px}
.logoWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.appLogo{width:72px;height:72px;border-radius:18px;box-shadow:0 4px 16px rgba(0,0,0,.18);background:#0b1324;display:flex;align-items:center;justify-content:center;overflow:hidden}
.appLogo img{width:100%;height:100%;object-fit:cover;display:block}
.appTitle{font-weight:900;font-size:16px}
.appSub{color:var(--muted);font-size:12px}

/* Tabs */
.tabs{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.tab{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#fff;text-decoration:none;color:inherit;font-weight:900}
.tab.active{background:var(--pill);color:var(--pillText);border-color:var(--pill)}

/* Layout */
.wrap{max-width:960px;margin:0 auto;padding:12px 12px 100px}
.card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px;margin:12px 0}
.title{font-weight:900;display:flex;gap:8px;align-items:center}
.muted{color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid4{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}

/* Inputs */
.input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px}
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#0f172a;padding:12px;border-radius:14px;font-weight:900}
.btn.blk{background:#111;color:#fff;border-color:#111}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
.rolegrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.rolebtn{background:#fff;color:#111;border:1px solid #111;padding:18px;border-radius:18px;font-weight:900}
.rolebtn.active{background:#111;color:#fff;border-color:#111}

/* Dropdown */
.dropdown{position:relative}
.menu{position:absolute;left:0;right:0;top:100%;z-index:20;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none;max-height:240px;overflow:auto}
.menu.show{display:block}
.option{padding:8px 10px;border-radius:10px}
.option:hover{background:#f3f4f6}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
.panel{background:#fff;border-radius:18px;box-shadow:var(--shadow);max-width:520px;width:100%;padding:16px}

/* Gallery */
.item{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:8px}
.item.photo{border-left:4px solid #3b82f6}
.item.video{border-left:4px solid #f59e0b}
.item.file{border-left:4px solid #8b5cf6}
.item.uploaded{border-left-color:#10b981}
.item.error{border-left-color:#ef4444}
.thumb{width:84px;height:84px;border-radius:8px;border:1px solid var(--line);object-fit:cover}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* Progress / status */
.progress{height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden}
.progress > span{display:block;height:100%;background:#111;width:0%;transition:width .3s}
.upload-status{padding:10px;border-radius:8px;background:#f0f9ff;margin-top:12px}
.status-row{display:flex;justify-content:space-between;align-items:center}

/* Bottom bar */
.bottomBar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line)}
.bottomBar .in{max-width:960px;margin:0 auto;padding:8px 12px;display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.bottomBar .btn{padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:900;font-size:12px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Error banner */
#fatal{display:none;position:sticky;top:0;z-index:99999;background:#fee2e2;color:#7f1d1d;padding:10px;font:12px system-ui}

/* Autopsy panel styling */
#autopsyPanel{margin-top:10px}
#autopsyPanel .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
#autopsyPanel label{font-weight:700;font-size:12px}
#autopsyPanel select{padding:6px 8px;border:1px solid #ddd;border-radius:8px}
.badge-info{display:inline-block;padding:4px 8px;border-radius:10px;background:#eef;color:#224;font-size:11px}
.badge.toggle{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:12px;cursor:pointer;font-weight:700}
.badge.toggle.active{background:#111;color:#fff;border-color:#111}
</style>

<script>
/* Polyfill: Promise.finally Î³Î¹Î± Ï€Î±Î»Î¹ÏŒÏ„ÎµÏÎ± webviews/browsers */
if (!Promise.prototype.finally) {
  Promise.prototype.finally = function (callback) {
    var P = this.constructor;
    return this.then(
      function (value) { return P.resolve(callback()).then(function(){ return value; }); },
      function (reason){ return P.resolve(callback()).then(function(){ throw reason; }); }
    );
  };
}
</script>

<script src="https://unpkg.com/piexifjs"></script>

<!-- v6.21: JSZip + PWA manifest -->
<link rel="manifest" href="manifest.webmanifest">
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>


<script>
// v6.22 â€” Lazy loader for ffmpeg.wasm
window.__ffmpegLoader = (function(){
  let loading = null;
  return async function ensureFFmpeg(){
    if (window.FFmpeg) return true;
    if (loading) return loading;
    loading = new Promise(async (res, rej)=>{
      try{
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js";
        s.onload = ()=>res(true);
        s.onerror = ()=>rej(new Error('ffmpeg.wasm load error'));
        document.head.appendChild(s);
      }catch(e){ rej(e); }
    });
    return loading;
  };
})();
</script>

</head>

<body>

<!-- Sticky header -->
<div class="header">
  <div class="in">
    <div class="logoWrap">
      <div class="appLogo">
        <img id="logoImg" src="logo.png" alt="Logo"
             onerror="this.remove();document.getElementById('logoFallback').style.display='block'">
        <svg id="logoFallback" viewBox="0 0 120 120" style="display:none;width:100%;height:100%">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0ea5e9"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs>
          <rect rx="18" ry="18" width="120" height="120" fill="#0b1324"/>
          <circle cx="60" cy="60" r="34" fill="url(#g)"/><path d="M60 28 L74 90 L46 90 Z" fill="#0b1324"/>
          <circle cx="60" cy="24" r="6" fill="#22d3ee"/>
        </svg>
      </div>
      <div class="appTitle">DIGITAL EXPERT â€” PHOTOS</div>
      <div class="appSub">Your Technology Partner</div>
    </div>
    <div class="tabs">
      <a href="#/sr" class="tab" data-route="#/sr">ğŸ“ SR & Î¡ÏŒÎ»Î¿Ï‚</a>
      <a href="#/structure" class="tab" data-route="#/structure">ğŸ¢ Î”Î¿Î¼Î® ÎºÏ„Î¹ÏÎ¯Î¿Ï…</a>
      <a href="#/shoot" class="tab" data-route="#/shoot">ğŸ“· Î¦Ï‰Ï„Î¿Î³ÏÎ¬Ï†Î¹ÏƒÎ·</a>
      <a href="#/gallery" class="tab" data-route="#/gallery">ğŸ–¼ï¸ Î£Ï…Î»Î»Î¿Î³Î® & Upload</a>
    
</div>
  </div>
</div>

<div class="wrap">
  <!-- SR -->
  <section id="page-sr" data-page="#/sr">
    <div class="card">
      <div class="title">ğŸ“ SR ÎµÏ€Î¹Î»Î¿Î³Î®</div>
      <div class="muted" style="margin-top:4px">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÏ„Î¿ Drive Î® Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± (ÎºÎµÏ†Î±Î»Î±Î¯Î± Ï‡Ï‰ÏÎ¯Ï‚ Ï„ÏŒÎ½Î¿Ï…Ï‚)</div>
      <div class="row" style="margin-top:10px">
        <div class="dropdown" style="flex:1">
          <input id="srSearch" class="input" placeholder="Î‘ÎÎ‘Î–Î—Î¤Î—Î£Î— (Î”Î™Î•Î¥Î˜Î¥ÎÎ£Î— Î® SR)">
          <div id="srMenu" class="menu"></div>
        </div>
        <button id="btnSrSearch" class="btn">Search</button>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="inAddress" class="input" placeholder="Î”Î™Î•Î¥Î˜Î¥ÎÎ£Î— (Î .Î§. Î¤Î‘Î™ÎÎ‘Î¡ÎŸÎ¥ 41)" style="flex:1">
        <input id="inSR" class="input" placeholder="SR (Î .Î§. 2-3290â€¦)" style="width:180px">
        <button id="btnSRApply" class="btn blk">ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>
      <div id="srInfo" class="muted" style="margin-top:6px">â€”</div>
    </div>

    <div class="card">
      <div class="title">ğŸ‘· Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏÏŒÎ»Î¿</div>
      <div class="rolegrid" style="margin-top:10px">
        <button class="rolebtn" data-role="XM">ğŸ› ï¸ Î§Ï‰Î¼Î±Ï„Î¿Ï…ÏÎ³ÏŒÏ‚</button>
        <button class="rolebtn" data-role="KS">ğŸ“¦ ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î±ÏƒÏ„Î®Ï‚</button>
        <button class="rolebtn" data-role="KL">ğŸ§µ ÎšÎ¿Î»Î»Î·Ï„Î®Ï‚</button>
        <button class="rolebtn" data-role="AP">ğŸ“ Î‘Ï…Ï„Î¿ÏˆÎ¯Î±</button>
      </div>
      <div id="roleInfo" class="muted" style="margin-top:6px">â€”</div>
<div class="row" style="margin-top:10px;gap:8px;align-items:center">
  <label class="muted">Î¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚</label>
  <select id="techSelect" class="input" style="flex:1;max-width:260px" disabled>
    <option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï„ÎµÏ‡Î½Î¹ÎºÏŒ â€”</option>
    <option value="__OTHER__">â€” Î†Î»Î»Î¿Ï‚ (Î³ÏÎ¬ÏˆÎµ ÏŒÎ½Î¿Î¼Î±) â€”</option>
  </select>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
  <input id="techCustom" class="input" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ÏŒÎ½Î¿Î¼Î±" style="flex:1;display:none">
  <button id="techSave" class="btn" style="display:none">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
  <div id="techInfo" class="muted" style="margin-left:auto">â€”</div>
</div>

    </div>
  </section>

  <!-- Structure -->
  <section id="page-structure" data-page="#/structure" class="hidden">
    <div class="card">
      <div class="title">ğŸ¢ Î”Î¿Î¼Î® ÎºÏ„Î¹ÏÎ¯Î¿Ï…</div>
<div class="row" style="margin-top:8px"><span id="bepOnlyBtn" class="badge toggle" title="Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼ÏŒÎ½Î¿ BEP/BMO, BCP, Smart Points">BEP ONLY</span></div>
      <div class="muted">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¿ÏÏŒÏ†Î¿Ï…Ï‚ â€” Î¸Î± Î¶Î·Ï„Î·Î¸Î¿ÏÎ½ FB/ÏŒÏÎ¿Ï†Î¿ ÎºÎ±Î¹ ÎŒÎ´ÎµÏ…ÏƒÎ·/ÏŒÏÎ¿Ï†Î¿</div>
      <div class="grid4" id="floorsGrid" style="margin-top:10px"></div>
      <div id="floorDetails" style="margin-top:10px"></div>
    </div>

    <div class="card" id="smartCard">
      <div class="title">âš¡ Smart Readiness</div>
      <div class="row" style="margin-top:8px">
        <div id="srYes" class="badge">ÎÎ‘Î™</div>
        <div id="srNo" class="badge">ÎŸÎ§Î™</div>
      </div>
      <div id="srModules" class="row" style="margin-top:10px; display:none">
        <label class="badge on"><input type="checkbox" data-sp="MHE" checked> ÎœÎ—Î•</label>
        <label class="badge"><input type="checkbox" data-sp="FY"> Î¦Î¥</label>
        <label class="badge"><input type="checkbox" data-sp="KTH"> ÎšÎ˜</label>
        <label class="badge"><input type="checkbox" data-sp="MA"> ÎœÎ‘</label>
      </div>
      <div id="smartInfo" class="muted" style="margin-top:6px">â€”</div>
    </div>
  </section>

  <!-- Shoot -->
  <section id="page-shoot" data-page="#/shoot" class="hidden">
    <div class="card">
      <div class="title">ğŸ“¦ Modules</div>
      <div class="muted">Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¼ÏŒÎ½Î¿ Ï„Î± Î²Î®Î¼Î±Ï„Î± Ï„Î¿Ï… ÎºÎ¬Î¸Îµ module</div>
      <div id="modulesRow" class="grid3" style="margin-top:10px"></div>
      <div id="moduleInfo" class="muted" style="margin-top:6px">â€”</div>
    </div>

    <div class="card">
      <div class="title">âœ… Checklist</div>
      <div class="muted">Î Î¿Î»Î»Î±Ï€Î»Î­Ï‚ Î»Î®ÏˆÎµÎ¹Ï‚ ÏƒÏ„Î¿ Î¯Î´Î¹Î¿ Î²Î®Î¼Î±: .p01, .p02 Îº.Î»Ï€.</div>
      <div id="checklist" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- Gallery -->
  <section id="page-gallery" data-page="#/gallery" class="hidden">
    <div class="card">
      <div class="title">ğŸ–¼ï¸ Î£Ï…Î»Î»Î¿Î³Î® <span id="itemCount" class="badge" style="margin-left:8px">0</span></div>

      <div class="row" style="margin-top:10px; gap:6px; flex-wrap:wrap">
        <button class="badge filter-btn active" data-filter="all">ÎŒÎ»Î±</button>
        <button class="badge filter-btn" data-filter="photo">ğŸ“· Î¦Ï‰Ï„Î¿</button>
        <button class="badge filter-btn" data-filter="video">ğŸ¥ Î’Î¯Î½Ï„ÎµÎ¿</button>
        <button class="badge filter-btn" data-filter="file">ğŸ“„ Î‘ÏÏ‡ÎµÎ¯Î±</button>
        <button class="badge filter-btn" data-filter="pending">â³ Î•ÎºÎºÏÎµÎ¼Î®</button>
        <button class="badge filter-btn" data-filter="uploaded">âœ… Uploaded</button>
        <button class="badge filter-btn" data-filter="error">â›” Error</button>
      </div>

      <div id="gallery" style="margin-top:12px"></div>

      <div id="galleryEmpty" class="muted" style="text-align:center; padding:20px">
        <div style="font-size:48px">ğŸ“¸</div>
        <div style="margin-top:8px">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± Î±ÎºÏŒÎ¼Î±</div>
        <div style="font-size:12px; margin-top:4px">Î Î®Î³Î±Î¹Î½Îµ ÏƒÏ„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± Â«Î¦Ï‰Ï„Î¿Î³ÏÎ¬Ï†Î¹ÏƒÎ·Â» Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚</div>
      </div>

      <div id="uploadStatus" class="upload-status" style="display:none">
        <div class="status-row">
          <span id="statusText">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± ÏƒÎµ ÎµÎ¾Î­Î»Î¹Î¾Î·...</span>
          <span id="statusPercent" style="font-weight:600">0%</span>
        </div>
        <div class="progress" style="margin-top:6px"><span id="statusProgress"></span></div>
      </div>

      <div class="grid2" style="margin-top:16px; gap:10px">
        <button id="btnUploadAll" class="btn blk"><span>â˜ï¸ Î‘Î½Î­Î²Î±ÏƒÎ¼Î±</span><span id="uploadCount" class="badge" style="margin-left:6px; background:#fff; color:#111">0</span></button>
        <button id="btnClear" class="btn">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
      </div>

      <div id="uploadInfo" class="muted" style="margin-top:8px; font-size:12px">â€”</div>
    </div>
  </section>
</div>


  <!-- Sync -->
  <section id="page-sync" data-page="#/sync" class="hidden">
    <div class="card">
      <div class="title">ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</div>
      <div class="muted">Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î¹ Î­Ï‡ÎµÎ¹ Î®Î´Î· Î±Î½Î­Î²ÎµÎ¹ Î³Î¹Î± Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ SR</div>
      <div class="row" style="margin-top:10px;gap:8px">
        <button id="btnSyncRefresh" class="btn">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</button>
        <div id="syncInfo" class="muted">â€”</div>
      </div>
      <div id="syncList" style="margin-top:10px"></div>
    </div>
  </section>


<!-- Bottom navigation -->
<div class="bottomBar">
  <div class="in">
<a class="btn" href="#/sr">ğŸ  Î‘ÏÏ‡Î¹ÎºÎ®</a>
<a class="btn" href="#/structure">ğŸ¢ Î”Î¿Î¼Î®</a>
<a class="btn" href="#/gallery">ğŸ–¼ï¸ Î£Ï…Î»Î»Î¿Î³Î®</a>
<a class="btn" href="#/sync">ğŸ”„ Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</a>
  </div>
</div>

<!-- Error banner -->
<div id="fatal">âš ï¸ Î£Ï†Î¬Î»Î¼Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚: <span id="fatalMsg"></span></div>

<!-- Modal -->
<div id="modal" class="modal" aria-modal="true" role="dialog">
  <div id="modalPanel" class="panel">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div style="flex:1">
        <div class="muted">Î’Î®Î¼Î±</div>
        <div id="modalStepLabel" class="title" style="margin-top:2px"></div>
        <div id="modalStepId" class="muted" style="margin-top:2px"></div>
        <div id="modalStepInfo" class="muted" style="margin-top:4px;font-size:11px"></div>
      </div>
      <button id="btnClose" class="btn">âœ•</button>
    </div>

    <div style="height:1px;background:#e5e7eb;margin:12px 0"></div>

    <div class="grid2" style="gap:8px">
      <div>
        <div class="muted" style="font-size:11px;margin-bottom:4px">ğŸ“¸ Î†Î¼ÎµÏƒÎ· Î»Î®ÏˆÎ·</div>
        <input id="fileCam" type="file" accept="image/*" capture="environment" style="display:none">
        <label for="fileCam" class="btn blk" style="width:100%;text-align:center;display:block">ÎšÎ¬Î¼ÎµÏÎ±</label>
      </div>

      <div>
        <div class="muted" style="font-size:11px;margin-bottom:4px">ğŸ–¼ï¸ Î‘Ï€ÏŒ Î±ÏÏ‡ÎµÎ¯Î±</div>
        <input id="fileGal" type="file" accept="image/*,video/*,application/pdf,.iolm" multiple style="display:none">
        <label for="fileGal" class="btn" style="width:100%;text-align:center;display:block">Î£Ï…Î»Î»Î¿Î³Î®</label>
      </div>
    </div>

    <input id="fileVid" type="file" accept="video/*" capture="environment" style="display:none">
    <label for="fileVid" id="btnVid" class="btn" style="width:100%;margin-top:8px;display:block;text-align:center">ğŸ¥ Î’Î¯Î½Ï„ÎµÎ¿</label>

    <div class="grid2" style="margin-top:12px;gap:8px">
      <button id="btnAgain" class="btn">ğŸ”„ Î†Î»Î»Î· Î»Î®ÏˆÎ·</button>
      <button id="btnNext" class="btn blk">Î•Ï€ÏŒÎ¼ÎµÎ½Î¿ Î²Î®Î¼Î± â†’</button>
    </div>

    <div id="fileWarning" class="badge" style="display:none;margin-top:10px;background:#fef3c7;border-color:#f59e0b;color:#92400e">âš ï¸ Î ÏÎ¿Ï„Î¹Î¼Î®ÏƒÏ„Îµ Â«Î‘ÏÏ‡ÎµÎ¯Î±Â» Î±Î½Ï„Î¯ Î³Î¹Î± Â«Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚Â» Î³Î¹Î± cloud Î±ÏÏ‡ÎµÎ¯Î±.</div>
  </div>
</div>

<!-- Autopsy panel -->
<div class="card" id="autopsyPanel" style="display:none">
  <div class="title">ğŸ“ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î‘Ï…Ï„Î¿ÏˆÎ¯Î±Ï‚</div>
  
  <div class="row">
    <label>Î§Ï‰Î¼Î±Ï„Î¿Ï…ÏÎ³Î¹ÎºÏŒ:</label>
    <select id="ax_homa"><option>ÎŸÎ§Î™</option><option>ÎÎ‘Î™</option></select>
    <span id="ax_homa_lvl_wrap" style="display:none;margin-left:8px">
      <label>Î’Î±Î¸Î¼ÏŒÏ‚ Î´Ï…ÏƒÎºÎ¿Î»Î¯Î±Ï‚:</label>
      <select id="ax_homa_lvl"><option>Î’Î”1</option><option>Î’Î”2</option><option>Î’Î”3</option><option>Î’Î”4</option><option>Î’Î”5</option></select>
    </span>
  </div>

  <div class="row" style="margin-top:6px">
    <label>Smart Readiness:</label>
    <div id="smartToggle" style="display:flex;gap:8px">
      <span class="badge toggle" data-value="ÎÎ‘Î™">ÎÎ‘Î™</span>
      <span class="badge toggle active" data-value="ÎŸÎ§Î™">ÎŸÎ§Î™</span>
    </div>
  </div>

  <div id="smartPointsWrap" style="margin-top:6px;display:none">
    <label>Smart Points:</label>
    <div class="row" style="gap:6px;flex-wrap:wrap">
      <label class="badge"><input type="checkbox" data-sp="MHE" checked> ÎœÎ—Î•</label>
      <label class="badge"><input type="checkbox" data-sp="FY"> Î¦Î¥</label>
      <label class="badge"><input type="checkbox" data-sp="KTH"> ÎšÎ˜</label>
      <label class="badge"><input type="checkbox" data-sp="MA"> ÎœÎ‘</label>
    </div>
  </div>

  <div class="row" style="margin-top:6px">
    <label>Î¤ÏÏ€Î¿Ï‚ ÎŒÎ´ÎµÏ…ÏƒÎ·Ï‚:</label>
    <select id="ax_route_type"><option>ÎšÎ¬Î³ÎºÎµÎ»Î¿</option><option>Î ÎµÏÎ¹Î¼ÎµÏ„ÏÎ¹ÎºÎ®</option><option>Î•Î¾Ï‰Ï„ÎµÏÎ¹ÎºÎ®</option></select>
  </div>

  <div class="row" style="margin-top:6px">
    <label>Î’Î” ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î±ÏƒÏ„Î¹ÎºÎ¿Ï:</label>
    <select id="ax_katas_lvl"><option>Î’Î”1</option><option>Î’Î”2</option><option>Î’Î”3</option><option>Î’Î”4</option><option>Î’Î”5</option></select>
  </div>

  <div class="row" style="margin-top:6px">
    <label>ÎŒÏÎ¿Ï†Î¿Ï‚ Î¤Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ BEP:</label>
    <select id="ax_bep_floor"><option>F-02</option><option>F-01</option><option selected>F+00</option><option>F+01</option><option>F+02</option><option>F+03</option><option>F+04</option><option>F+05</option><option>F+06</option><option>F+07</option><option>F+08</option><option>F+09</option></select>
  </div>

  <div class="row" style="margin-top:6px">
    <label>Î•Ï€Î¯Ï€ÎµÎ´Î± ÎºÏ„Î¹ÏÎ¯Î¿Ï…:</label>
    <select id="ax_levels"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select>
  </div>

  <div class="row" style="margin-top:6px">
    <label>Status:</label>
    <select id="ax_status">
      <option>Î•ÎšÎšÎ¡Î•ÎœÎ•Î™ Î¥Î ÎŸÎ“Î¡Î‘Î¦Î—</option>
      <option>ÎŸÎ›ÎŸÎšÎ›Î—Î¡Î©Î£Î—</option>
      <option>Î‘ÎšÎ¥Î¡Î©Î£Î—</option>
      <option>Î“Î™Î‘ ÎœÎ—Î§Î‘ÎÎ™ÎšÎŸ</option>
      <option>Î•Î Î‘ÎÎ‘Î Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘Î¤Î™Î£ÎœÎŸÎ£</option>
    </select>
  </div>

  <div class="row" style="margin-top:8px">
    <button id="ax_sync_sheet" class="btn">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Sheet</button>
    <span id="ax_sync_result" class="badge-info">â€”</span>
  </div>
</div>

<script>
/* Fatal js */
window.addEventListener('error', e=>{
  const b=document.getElementById('fatal'), m=document.getElementById('fatalMsg');
  if(b&&m){ m.textContent=(e.error&&e.error.message)||e.message||String(e); b.style.display='block'; }
});

/* MAIN */
window.addEventListener('DOMContentLoaded', function(){
(function(){

/* ---------- CONFIG ---------- */
const WEBAPP_URL='https://script.google.com/macros/s/AKfycbx_pJ-CByq6aFZ2d9v12OglYA51FSI8gTPSRtFIPQgMxJOgJvWNcxJanllsT9wO1tZN/exec';
const IS_LOCAL_ORIGIN=(location.origin==='null')||location.protocol.startsWith('file')||location.protocol.startsWith('content');

/* ---------- ROUTER ---------- */
const pages=[...document.querySelectorAll('[data-page]')];
const tabs=[...document.querySelectorAll('.tab')];
function go(route){
  pages.forEach(p=>p.classList.toggle('hidden',p.dataset.page!==route));
  tabs.forEach(t=>t.classList.toggle('active',t.getAttribute('data-route')===route));
  if(location.hash!==route) location.hash=route;
  scrollTo({top:0,behavior:'smooth'});
}
tabs.forEach(t=>t.addEventListener('click',e=>{e.preventDefault();go(t.getAttribute('data-route'))}));
window.addEventListener('hashchange',()=>go(location.hash||'#/sr'));
go(location.hash||'#/sr');

/* ---------- STATE ---------- */
const state={role:null,job:null,module:null,items:[],checklist:[],currentIndex:0,
floors:[],fbPerFloor:{},routePerFloor:{},smartReady:false,sp:{MHE:true,FY:false,KTH:false,MA:false},filter:'all'};
/* --- TECH/ROLE, GPS, EXIF helpers (compat) --- */
const ROLE_GREEK_MAP={XM:'Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“ÎŸÎ£',KS:'ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î‘Î£Î¤Î—Î£',KL:'ÎšÎŸÎ›Î›Î—Î¤Î—Î£',AP:'Î‘Î¥Î¤ÎŸÎ¨Î™Î•Î£'};
state.greekRole=state.greekRole||''; state.techName=state.techName||''; state.geo=state.geo||null;
var techSelect=document.getElementById('techSelect');
var techCustom=document.getElementById('techCustom');
var techSave=document.getElementById('techSave');
var techInfo=document.getElementById('techInfo');
function updateTechInfo(){ var s=state.greekRole?('Î¡ÏŒÎ»Î¿Ï‚: '+state.greekRole):'â€”'; if(state.techName) s+=' â€” '+state.techName; if(techInfo) techInfo.textContent=s; }
function loadTechsForRole(roleGreek){
  if(!techSelect) return Promise.resolve();
  techSelect.innerHTML='<option value="">â€” Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï„ÎµÏ‡Î½Î¹ÎºÏŒ â€”</option><option value="__OTHER__">â€” Î†Î»Î»Î¿Ï‚ (Î³ÏÎ¬ÏˆÎµ ÏŒÎ½Î¿Î¼Î±) â€”</option>';
  techSelect.disabled=true;
  return fetch(WEBAPP_URL+'?action=techs&role='+encodeURIComponent(roleGreek||''))
    .then(function(res){ return res.json(); })
    .then(function(data){
      (data.techs||[]).forEach(function(t){ var o=document.createElement('option'); o.value=t.name; o.textContent=t.name; techSelect.appendChild(o); });
      techSelect.disabled=false;
    })
    .then(null, function(e){ techSelect.innerHTML='<option value="">Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚</option>'; });
}
if(techSelect){ techSelect.addEventListener('change', function(){ var v=techSelect.value; if(v==='__OTHER__'){ techCustom.style.display='block'; techSave.style.display='inline-block'; state.techName=''; } else { techCustom.style.display='none'; techSave.style.display='none'; state.techName=v||''; try{ if(v) localStorage.setItem('defTechName', v);} catch(e){} } updateTechInfo(); }); }
if(techSave){ techSave.addEventListener('click', function(){ var name=(techCustom.value||'').trim(); if(!name){ alert('Î“ÏÎ¬ÏˆÎµ ÏŒÎ½Î¿Î¼Î±'); return; } fetch(WEBAPP_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'addTech',name:name,role:state.greekRole||''})}).then(function(){ }).then(null, function(e){ }).then(function(){ state.techName=name; try{ localStorage.setItem('defTechName', name);} catch(e){} updateTechInfo(); techCustom.style.display='none'; techSave.style.display='none'; loadTechsForRole(state.greekRole).then(function(){ if(techSelect) techSelect.value=name; }); }); }); }
// defaults on load
(function(){ try{ var savedRole=localStorage.getItem('defRoleCode'); var savedTech=localStorage.getItem('defTechName'); if(savedRole){ state.greekRole=ROLE_GREEK_MAP[savedRole]||''; loadTechsForRole(state.greekRole).then(function(){ if(savedTech){ state.techName=savedTech; if(techSelect) techSelect.value=savedTech; updateTechInfo(); } }); } } catch(e){} })();
// GPS once
function getGeoOnce(){ if(state.geo) return Promise.resolve(state.geo); return new Promise(function(resolve){ if(!('geolocation' in navigator)) return resolve(null); var opts={enableHighAccuracy:true,timeout:6000,maximumAge:0}; navigator.geolocation.getCurrentPosition(function(pos){ state.geo={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy}; resolve(state.geo); }, function(){ resolve(null); }, opts); }); }
// EXIF inject
function injectExifOnJpegBase64(jpegDataUrl, geo, techName){ try{ if(!jpegDataUrl||jpegDataUrl.indexOf('data:image/jpeg')!==0||typeof piexif==='undefined') return jpegDataUrl; var exifObj={'0th':{},'Exif':{},'GPS':{},'1st':{},'thumbnail':null}; if(techName){ exifObj['0th'][piexif.ImageIFD.Artist]=techName; var ucs2=[]; for(var i=0;i<techName.length;i++){ var ch=techName.charCodeAt(i); ucs2.push(ch & 0xFF, ch >> 8); } ucs2.push(0,0); exifObj['0th'][piexif.ImageIFD.XPAuthor]=ucs2; exifObj['Exif'][piexif.ExifIFD.UserComment]='ASCII\0\0\0TECH='+techName; } if(geo && typeof geo.lat==='number' && typeof geo.lng==='number'){ function toRat(val){ var v=Math.abs(val),deg=Math.floor(v),minFloat=(v-deg)*60,min=Math.floor(minFloat),sec=Math.round((minFloat-min)*6000); return [[deg,1],[min,1],[sec,100]]; } exifObj['GPS'][piexif.GPSIFD.GPSLatitudeRef]=(geo.lat>=0)?'N':'S'; exifObj['GPS'][piexif.GPSIFD.GPSLatitude]=toRat(geo.lat); exifObj['GPS'][piexif.GPSIFD.GPSLongitudeRef]=(geo.lng>=0)?'E':'W'; exifObj['GPS'][piexif.GPSIFD.GPSLongitude]=toRat(geo.lng); } var exifBytes=piexif.dump(exifObj); return piexif.insert(exifBytes, jpegDataUrl); } catch(e){ return jpegDataUrl; } }


/* ---------- ELEMENTS ---------- */
const roleInfo=document.getElementById('roleInfo');
document.querySelectorAll('[data-role]').forEach(b=>b.onclick=()=>setRole(b.dataset.role));
const srSearch=document.getElementById('srSearch'), srMenu=document.getElementById('srMenu'), btnSrSearch=document.getElementById('btnSrSearch');
const inAddress=document.getElementById('inAddress'), inSR=document.getElementById('inSR'), btnSRApply=document.getElementById('btnSRApply'), srInfo=document.getElementById('srInfo');
const floorsGrid=document.getElementById('floorsGrid'), floorDetails=document.getElementById('floorDetails');
const srYes=document.getElementById('srYes'), srNo=document.getElementById('srNo'), srModules=document.getElementById('srModules'), smartInfo=document.getElementById('smartInfo');
const modulesRow=document.getElementById('modulesRow'), moduleInfo=document.getElementById('moduleInfo'), checklistEl=document.getElementById('checklist');
const galleryEl=document.getElementById('gallery'), galleryEmpty=document.getElementById('galleryEmpty');
const btnUploadAll=document.getElementById('btnUploadAll'), btnClear=document.getElementById('btnClear'), uploadInfo=document.getElementById('uploadInfo');
const modal=document.getElementById('modal'), modalPanel=document.getElementById('modalPanel');
const modalStepLabel=document.getElementById('modalStepLabel'), modalStepId=document.getElementById('modalStepId'), modalStepInfo=document.getElementById('modalStepInfo');
const btnClose=document.getElementById('btnClose'), btnNext=document.getElementById('btnNext'), btnAgain=document.getElementById('btnAgain');
const fileCam=document.getElementById('fileCam'), fileGal=document.getElementById('fileGal'), fileVid=document.getElementById('fileVid');
const itemCount=document.getElementById('itemCount'), uploadCount=document.getElementById('uploadCount');
const uploadStatus=document.getElementById('uploadStatus'), statusText=document.getElementById('statusText'), statusPercent=document.getElementById('statusPercent'), statusProgress=document.getElementById('statusProgress');

/* ---------- HELPERS ---------- */
function upperNoTonos(s){try{return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/Ï‚/g,'Ïƒ').toUpperCase()} catch(e){return (s||'').toUpperCase()}}
[srSearch,inAddress,inSR].forEach(inp=>inp.addEventListener('input',()=>{const p=inp.selectionStart;inp.value=upperNoTonos(inp.value);try{inp.setSelectionRange(p,p)} catch(e){}}));

/* ---------- SEARCH ---------- */
let tSearch=null;
srSearch.addEventListener('input',()=>{clearTimeout(tSearch);tSearch=setTimeout(runSrSearch,400);});
btnSrSearch.addEventListener('click',runSrSearch);
document.addEventListener('click',e=>{if(!srMenu.contains(e.target)&&e.target!==srSearch){srMenu.classList.remove('show')}});

async function runSrSearch(){
  const q=srSearch.value.trim(); srMenu.innerHTML=''; srMenu.classList.remove('show'); if(!q) return;
  try{
    const res=await fetch(WEBAPP_URL+'?action=search&query='+encodeURIComponent(q)+'&t='+Date.now());
    const json=await res.json(); if(!json.ok) throw new Error(json.error||'search failed');
    const qn=upperNoTonos(q); let rows=json.results.filter(r=>upperNoTonos(r.name).includes(qn));
    if(!rows.length){srMenu.innerHTML='<div class="option muted">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½</div>';srMenu.classList.add('show');return;}
    rows.slice(0,60).forEach(r=>{
      const el=document.createElement('div'); el.className='option'; el.textContent=r.name;
      el.onclick=()=>{const parts=r.name.split(' ');const srGuess=parts[parts.length-1]||r.name;
        state.job={sr:srGuess,building:'BXXXX',address:r.name.replace(srGuess,'').trim()||'-',srFolderName:r.name};
        srInfo.textContent='Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ: '+r.name; srMenu.classList.remove('show'); srSearch.value=r.name;};
      srMenu.appendChild(el);
    }); srMenu.classList.add('show');
  } catch(err){
    srMenu.innerHTML='<div class="option muted">Î£Ï†Î¬Î»Î¼Î± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚: '+((err&&err.message)||'Î¬Î³Î½Ï‰ÏƒÏ„Î¿')+'</div>'; srMenu.classList.add('show');
  }
}
btnSRApply.onclick=()=>{const addr=inAddress.value.trim(), sr=inSR.value.trim(); if(!sr){alert('Î“ÏÎ¬ÏˆÎµ SR');return;}
  const name=(addr?addr+' ':'')+sr; state.job={sr:sr,building:'BXXXX',address:addr||'-',srFolderName:name}; srInfo.textContent='Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ: '+name;};

/* ---------- ROLES / MODULES / STEPS ---------- */
const DEST={PHOTOS:'PHOTOS',SMARTREADINESS:'PHOTOS/SMARTREADINESS',BEP:'PHOTOS/BEP',BMO:'PHOTOS/BMO',FLOORBOX:'PHOTOS/FLOORBOX',ODEFSI:'PHOTOS/ÎŸÎ”Î•Î¥Î£Î—',BCP:'PHOTOS/BCP',CHM:'PHOTOS/Î§Î©ÎœÎ‘Î¤ÎŸÎ¥Î¡Î“Î™ÎšÎ‘',KBN:'PHOTOS/ÎšÎ‘ÎœÎ Î™ÎÎ‘',SXEDIA:'Î£Î§Î•Î”Î™Î‘',FAULT:'PHOTOS/Î’Î›Î‘Î’Î—'};
const MODULE_LABEL={BEPBMO:"BEP + BMO",FB:"FB",SMARTPOINTS:"Smart Points",GEN:"Î“ÎµÎ½Î¹ÎºÎ® ÎŒÎ´ÎµÏ…ÏƒÎ·",BCP:"BCP",KL_BEPBMO:"ÎšÎ¿Î»Î»Î·Ï„Î®Ï‚ â€” BEP/BMO",KL_FB:"ÎšÎ¿Î»Î»Î·Ï„Î®Ï‚ â€” FB",KL_BCP:"ÎšÎ¿Î»Î»Î·Ï„Î®Ï‚ â€” BCP",KBN:"ÎšÎ¿Î»Î»Î·Ï„Î®Ï‚ â€” CAB",CHM:"Î§Ï‰Î¼Î±Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ¬",AP_SXEDIA:"Î‘Ï…Ï„Î¿ÏˆÎ¯Î± â€” Î£Î§Î•Î”Î™Î‘/Î’Î¯Î½Ï„ÎµÎ¿",AUTOPSY:"Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î‘Ï…Ï„Î¿ÏˆÎ¯Î±Ï‚"};
const ROLE_MODULES={XM:["CHM","GEN"],KS:["BEPBMO","FB","SMARTPOINTS","GEN","BCP"],KL:["KL_BEPBMO","KL_FB","KL_BCP","KBN"],AP:["AUTOPSY","AP_SXEDIA","GEN"]};
const STEPS={BEPBMO:[{id:"BEPBMO_BEFORE",label:"BEP-BMO Î Î¡Î™Î",label_for_name:"BEP-BMO.before{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"BEPBMO_AFTER",label:"BEP-BMO AFTER",label_for_name:"BEP-BMO.after{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"BEP_GEN",label:"BEP Î³ÎµÎ½Î¹ÎºÎ®",label_for_name:"BEP.geniki{SEQ}",primary_dest:"BEP"},
{id:"BMO_GEN",label:"BMO Î³ÎµÎ½Î¹ÎºÎ®",label_for_name:"BMO.geniki{SEQ}",primary_dest:"BMO"}],
FB:[{id:"FB_GEN",label:"FB Î³ÎµÎ½Î¹ÎºÎ® [F]",label_for_name:"FB{LEVEL2}.geniki{SEQ}",primary_dest:"FLOORBOX",requires_level:true,floor:"+00",seq:1},
{id:"FB_ROUTE",label:"ÎŒÎ´ÎµÏ…ÏƒÎ· FB [F]",label_for_name:"FB{LEVEL2}.odefsi{SEQ}",primary_dest:"SMARTREADINESS",requires_level:true,floor:"+00",seq:1}],
SMARTPOINTS:[{id:"MHE_AFTER",label:"AFTER ÎœÎ—Î•",label_for_name:"MHE.after{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"MHE_ROUTE",label:"ODEFSI ÎœÎ—Î•",label_for_name:"MHE.odefsi{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"FY_AFTER",label:"AFTER Î¦Î¥",label_for_name:"FY.after{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"FY_ROUTE",label:"ODEFSI Î¦Î¥",label_for_name:"FY.odefsi{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"KTH_AFTER",label:"AFTER ÎšÎ˜",label_for_name:"KTH.after{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"KTH_ROUTE",label:"ODEFSI ÎšÎ˜",label_for_name:"KTH.odefsi{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"MA_AFTER",label:"AFTER ÎœÎ‘",label_for_name:"MA.after{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"MA_ROUTE",label:"ODEFSI ÎœÎ‘",label_for_name:"MA.odefsi{SEQ}",primary_dest:"SMARTREADINESS"}],
GEN:[{id:"GEN_ROUTE",label:"Î“ÎµÎ½Î¹ÎºÎ® ÏŒÎ´ÎµÏ…ÏƒÎ·",label_for_name:"geniki.odefsi{SEQ}",primary_dest:"ODEFSI"}],
KL_BEPBMO:[{id:"BEP_OPEN",label:"BEP OPEN",label_for_name:"BEP.open{SEQ}",primary_dest:"BEP"},
{id:"BEP_CLOSE",label:"BEP CLOSED",label_for_name:"BEP.closed{SEQ}",primary_dest:"SMARTREADINESS"},
{id:"BMO_OPEN",label:"BMO OPEN",label_for_name:"BMO.open{SEQ}",primary_dest:"BMO"},
{id:"BMO_CLOSE",label:"BMO CLOSED",label_for_name:"BMO.closed{SEQ}",primary_dest:"SMARTREADINESS"}],
KL_FB:[{id:"FB_OPEN",label:"FB OPEN [F]",label_for_name:"FB{LEVEL2}.open{SEQ}",primary_dest:"FLOORBOX",requires_level:true,floor:"+00",seq:1},
{id:"FB_CLOSED",label:"FB CLOSED [F]",label_for_name:"FB{LEVEL2}.closed{SEQ}",primary_dest:"SMARTREADINESS",requires_level:true,floor:"+00",seq:1}],
KL_BCP:[{id:"BCP_OPEN",label:"BCP OPEN",label_for_name:"BCP.open{SEQ}",primary_dest:"BCP"},
{id:"BCP_CLOSE",label:"BCP CLOSED",label_for_name:"BCP.closed{SEQ}",primary_dest:"BCP"}],
KBN:[{id:"CAB",label:"CAB",label_for_name:"CAB{SEQ}",primary_dest:"KBN"}],
CHM:[{id:"XM_PRIN",label:"Î ÏÎ¹Î½ ÏƒÎºÎ¬Î¼Î¼Î±",label_for_name:"skamma.prin{SEQ}",primary_dest:"CHM"},
{id:"XM_OPEN",label:"Î£ÎºÎ¬Î¼Î¼Î± Î±Î½Î¿Î¹Ï‡Ï„ÏŒ",label_for_name:"skamma.open{SEQ}",primary_dest:"CHM"},
{id:"XM_SIG",label:"Î£ÎºÎ¬Î¼Î¼Î± Î¼Îµ ÏƒÎ®Î¼Î±Î½ÏƒÎ·",label_for_name:"skamma.simansi{SEQ}",primary_dest:"CHM"},
{id:"XM_APOK",label:"Î‘Ï€Î¿ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·",label_for_name:"skamma.apokatastasi{SEQ}",primary_dest:"CHM"},
{id:"XM_VLAVI",label:"Î’Î»Î¬Î²Î·",label_for_name:"vlavi{SEQ}",primary_dest:"FAULT"}],
AP_SXEDIA:[{id:"AP_SIDEWALK",label:"Î ÎµÎ¶Î¿Î´ÏÏŒÎ¼Î¹Î¿ ÎµÎºÏƒÎºÎ±Ï†Î®Ï‚ (photo)",label_for_name:"ap.sidewalk{SEQ}",primary_dest:"SXEDIA"},
{id:"AP_TOMI",label:"Î£Ï‡Î­Î´Î¹Î¿ Ï„Î¿Î¼Î®Ï‚ (pdf/photo)",label_for_name:"ap.tomi{SEQ}",primary_dest:"SXEDIA"},
{id:"AP_FSS",label:"FSS (.xls/.xlsx)",label_for_name:"ap.fss{SEQ}",primary_dest:"SXEDIA",type:"file"},
{id:"AP_VIDEO",label:"Î’Î¯Î½Ï„ÎµÎ¿ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®Ï‚",label_for_name:"ap.video{SEQ}",primary_dest:"SXEDIA",type:"video"}]};

/* Roles */
function setRole(r){
  state.role=r; roleInfo.textContent='Î¡ÏŒÎ»Î¿Ï‚: '+r; renderModules(); state.module=null; state.checklist=[]; renderChecklist();
  var structurePage=document.getElementById('page-structure');
  document.getElementById('smartCard').style.display=(r==='KS')?'block':'none';
  structurePage.style.display=(r==='KS'||r==='KL')?'block':'none';
  var btns=document.querySelectorAll('.rolebtn'); for(var i=0;i<btns.length;i++){ var b=btns[i]; b.classList.toggle('active', b.getAttribute('data-role')===r); }
  state.greekRole = (ROLE_GREEK_MAP[r]||''); try{ localStorage.setItem('defRoleCode', r);} catch(e){}
  loadTechsForRole(state.greekRole); updateTechInfo();
}

/* Checklist */
function byId(arr,id){return arr.find(x=>x&&x.id===id)}
function buildChecklistForModule(){
  const out=[], m=state.module; if(!m){state.checklist=[];return;}
  if(m==="BEPBMO"){out.push(byId(STEPS.BEPBMO,'BEPBMO_BEFORE'),byId(STEPS.BEPBMO,'BEPBMO_AFTER'),byId(STEPS.BEPBMO,'BEP_GEN'),byId(STEPS.BEPBMO,'BMO_GEN'));}
  if(m==="FB"){state.floors.forEach(f=>{const c=+state.fbPerFloor[f]||1;for(let i=1;i<=c;i++)out.push({...byId(STEPS.FB,'FB_GEN'),floor:f,seq:i});const r=+state.routePerFloor[f]||1;for(let j=1;j<=r;j++)out.push({...byId(STEPS.FB,'FB_ROUTE'),floor:f,seq:j});});}
  if(m==="SMARTPOINTS"&&state.smartReady){['MHE','FY','KTH','MA'].forEach(sig=>{if(state.sp[sig]){out.push(byId(STEPS.SMARTPOINTS,sig+'_ROUTE'));out.push(byId(STEPS.SMARTPOINTS,sig+'_AFTER'));}});}
  if(m==="GEN"){out.push(byId(STEPS.GEN,'GEN_ROUTE'));}
  if(m==="BCP"){out.push(byId(STEPS.KL_BCP,'BCP_OPEN'),byId(STEPS.KL_BCP,'BCP_CLOSE'));}
  if(m==="KL_BEPBMO"){out.push(byId(STEPS.KL_BEPBMO,'BEP_OPEN'),byId(STEPS.KL_BEPBMO,'BEP_CLOSE'),byId(STEPS.KL_BEPBMO,'BMO_OPEN'),byId(STEPS.KL_BEPBMO,'BMO_CLOSE'));}
  if(m==="KL_FB"){state.floors.forEach(f=>{const c=+state.fbPerFloor[f]||1;for(let i=1;i<=c;i++){out.push({...byId(STEPS.KL_FB,'FB_OPEN'),floor:f,seq:i},{...byId(STEPS.KL_FB,'FB_CLOSED'),floor:f,seq:i});}});}
  if(m==="KL_BCP"){out.push(byId(STEPS.KL_BCP,'BCP_OPEN'),byId(STEPS.KL_BCP,'BCP_CLOSE'));}
  if(m==="KBN"){out.push(byId(STEPS.KBN,'CAB'));}
  if(m==="CHM"){out.push(byId(STEPS.CHM,'XM_PRIN'),byId(STEPS.CHM,'XM_OPEN'),byId(STEPS.CHM,'XM_SIG'),byId(STEPS.CHM,'XM_APOK'),byId(STEPS.CHM,'XM_VLAVI'));}
  if(m==="AP_SXEDIA"){out.push(byId(STEPS.AP_SXEDIA,'AP_SIDEWALK'),byId(STEPS.AP_SXEDIA,'AP_TOMI'),byId(STEPS.AP_SXEDIA,'AP_FSS'),byId(STEPS.AP_SXEDIA,'AP_VIDEO'));}
  state.checklist=out.filter(Boolean);
}
function renderModules(){
  modulesRow.innerHTML="";
  let mods = (ROLE_MODULES[state.role]||[]).slice();
  if(state.bepOnly){ mods = mods.filter(x=>['BEPBMO','BCP','SMARTPOINTS','AUTOPSY'].includes(x)); }
  mods.forEach(m=>{
    const btn=document.createElement('button'); btn.className='btn'; 
    btn.textContent=(MODULE_LABEL[m]|| (m==='AUTOPSY'?'Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î‘Ï…Ï„Î¿ÏˆÎ¯Î±Ï‚':m));
    if(state.module===m) btn.classList.add('active');
    btn.onclick=()=>{
      state.module=m; 
      [...modulesRow.querySelectorAll('.btn')].forEach(x=>x.classList.toggle('active', x===btn));
      moduleInfo.textContent='Module: '+btn.textContent;
      state.currentIndex=0;
      buildChecklistForModule();
      renderChecklist();
      go('#/shoot');
    };
    modulesRow.appendChild(btn);
  });
}
function renderChecklist(){ 
  const checklistElement = document.getElementById('checklist');
  
  try{
    if(state && state.module==='AUTOPSY'){
      const panel=document.getElementById('autopsyPanel');
      const host=document.getElementById('modulesRow').parentNode;
      if(panel && host){ 
        panel.style.display='block'; 
        host.parentNode.insertBefore(panel, host.nextSibling); 
      }
      // ÎšÎ¡Î¥Î¨Î• Î¤ÎŸ CHECKLIST
      if (checklistElement) checklistElement.style.display = 'none';
      return;
    }else{
      const panel=document.getElementById('autopsyPanel'); 
      if(panel) panel.style.display='none';
      // Î•ÎœÎ¦Î‘ÎÎ™Î£Î• Î¤ÎŸ CHECKLIST
      if (checklistElement) checklistElement.style.display = 'block';
    }
  }catch(_){}
  
  checklistElement.innerHTML="";
  if(!state.checklist.length){checklistElement.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î²Î®Î¼Î±Ï„Î±. Î”Î¹Î¬Î»ÎµÎ¾Îµ module.</div>';return;}
  state.checklist.forEach((step,idx)=>{
    const box=document.createElement('div'); box.className='item';
    const a=document.createElement('div'); a.style.fontWeight='900'; a.textContent=step.label;
    const b=document.createElement('div'); b.className='muted'; let n='stepId: '+step.id; if(step.floor!=null)n+=' â€¢ F'+step.floor; if(step.seq!=null)n+=' â€¢ #'+step.seq; b.textContent=n;
    const row=document.createElement('div'); row.className='grid2'; row.style.marginTop='8px';
    const c=document.createElement('button'); c.className='btn blk'; c.textContent=(step.type==='video')?'Î’Î¯Î½Ï„ÎµÎ¿':(step.type==='file'?'Î‘ÏÏ‡ÎµÎ¯Î¿ (.xls)':'ÎšÎ¬Î¼ÎµÏÎ±/Î£Ï…Î»Î»Î¿Î³Î®'); c.onclick=()=>openModalAt(idx);
    const d=document.createElement('button'); d.className='btn'; d.textContent='Î¦Î¬ÎºÎµÎ»Î¿Î¹'; d.onclick=()=>alert(destinationsFor(step).join('\n'));
    row.append(c,d); box.append(a,b,row); checklistElement.appendChild(box);
  });
}

/* Floors / Smart */
const ALL_FLOORS=["-02","-01","+00","+01","+02","+03","+04","+05","+06","+07","+08","+09"];
function paintFloors(){
  try{
    floorsGrid.innerHTML = "";
    // draw floor buttons
    ALL_FLOORS.forEach(function(f){
      var b = document.createElement('button'); 
      b.className = 'btn'; 
      b.textContent = 'F'+f;
      if(state.floors.indexOf(f)>-1){ b.style.background='#111'; b.style.color='#fff'; b.style.borderColor='#111'; }
      b.onclick = function(){
        var i = state.floors.indexOf(f);
        if(i>-1){ state.floors.splice(i,1); delete state.fbPerFloor[f]; delete state.routePerFloor[f]; }
        else { state.floors.push(f); state.fbPerFloor[f]=state.fbPerFloor[f]||1; state.routePerFloor[f]=state.routePerFloor[f]||1; }
        paintFloors(); buildChecklistForModule(); renderChecklist();
      };
      floorsGrid.appendChild(b);
    });

    // per-floor details
    floorDetails.innerHTML = "";
    if(!state.floors.length){
      floorDetails.innerHTML = '<div class="muted">ÎšÎ±Î½Î­Î½Î±Ï‚ ÏŒÏÎ¿Ï†Î¿Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚.</div>';
      return;
    }
    state.floors.forEach(function(f){
      var row = document.createElement('div');
      row.className = 'row';
      row.style.alignItems = 'center';

      var badge = document.createElement('div'); badge.className='badge'; badge.textContent='F'+f;
      var l1 = document.createElement('span'); l1.className='muted'; l1.style.margin='0.8px'; l1.textContent='FB/ÏŒÏÎ¿Ï†Î¿:';
      var fb = document.createElement('input'); fb.type='number'; fb.min='1'; fb.value = state.fbPerFloor[f]||1; fb.style.width='30px';
      fb.onchange = function(){ var n=parseInt(fb.value||'1',10); if(isNaN(n)||n<1) n=1; state.fbPerFloor[f]=n; buildChecklistForModule(); renderChecklist(); };
      var l2 = document.createElement('span'); l2.className='muted'; l2.style.margin='0.8px'; l2.textContent='ÎŒÎ´ÎµÏ…ÏƒÎ·/ÏŒÏÎ¿Ï†Î¿:';
      var rt = document.createElement('input'); rt.type='number'; rt.min='1'; rt.value = state.routePerFloor[f]||1; rt.style.width='30px';
      rt.onchange = function(){ var n=parseInt(rt.value||'1',10); if(isNaN(n)||n<1) n=1; state.routePerFloor[f]=n; buildChecklistForModule(); renderChecklist(); };

      row.appendChild(badge); row.appendChild(l1); row.appendChild(fb); row.appendChild(l2); row.appendChild(rt);
      floorDetails.appendChild(row);
    });
  }catch(e){
    try{ console.error('paintFloors error', e); }catch(_){} 
  }
}
function paintSmart(){smartInfo.textContent=state.smartReady?'Smart Readiness: ÎÎ‘Î™':'Smart Readiness: ÎŸÎ§Î™';srModules.style.display=state.smartReady?'flex':'none';srYes.classList.toggle('on',state.smartReady);srNo.classList.toggle('on',!state.smartReady);}
srYes.onclick=()=>{state.smartReady=true;paintSmart();buildChecklistForModule();renderChecklist();}
srNo.onclick=()=>{state.smartReady=false;paintSmart();buildChecklistForModule();renderChecklist();}
srModules.querySelectorAll('input[type=checkbox]').forEach(chk=>chk.onchange=()=>{state.sp[chk.dataset.sp]=chk.checked;buildChecklistForModule();renderChecklist();});

/* DEST & NAMES */
function destinationsFor(step){
  const map={SMARTREADINESS:DEST.SMARTREADINESS,BEP:DEST.BEP,BMO:DEST.BMO,FLOORBOX:DEST.FLOORBOX,ODEFSI:DEST.ODEFSI,BCP:DEST.BCP,CHM:DEST.CHM,KBN:DEST.KBN,SXEDIA:DEST.SXEDIA,FAULT:DEST.FAULT};
  const primary=map[step.primary_dest]||DEST.PHOTOS, extra=[];
  const isSP=/\b(MHE|FY|KTH|MA)\b/i.test(step.label_for_name||"");
  if(step.primary_dest==="SMARTREADINESS"&&!isSP&&step.id!=="BEPBMO_BEFORE"&&step.id!=="BEPBMO_AFTER"){
    if(step.id.includes("FB")||step.label.includes("FB")) extra.push(DEST.FLOORBOX);
    if(step.id.includes("BEP")||step.label.includes("BEP")) extra.push(DEST.BEP);
    if(step.id.includes("BMO")||step.label.includes("BMO")) extra.push(DEST.BMO);
    if(step.id.includes("BCP")||step.label.includes("BCP")) extra.push(DEST.BCP);
  }
  if(step.id==="BEP_CLOSE") extra.push(DEST.BEP);
  if(step.id==="BMO_CLOSE") extra.push(DEST.BMO);
  if(step.id==="FB_CLOSED") extra.push(DEST.FLOORBOX);
  const out=[],seen={}; [primary].concat(extra).forEach(x=>{if(!seen[x]){seen[x]=1;out.push(x)}}); return out;
}
function nowStamp(){const d=new Date();const p=n=>String(n).padStart(2,"0");return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"-"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());}
function fbName(step,floor,shot){const floorTag=floor?'('+floor+')':'';let kind='geniki';if(step.id==='FB_OPEN')kind='open';else if(step.id==='FB_CLOSED')kind='closed';else if(step.id==='FB_ROUTE')kind='odefsi';const p='.p'+String(shot||1).padStart(2,'0');return `FB${floorTag}.${kind}${p}.jpg`;}
function buildName(job,roleId,step,floor,seq,shot){
  if(/^FB_/.test(step.id)) return fbName(step,floor,shot);
  const special={'BEP_OPEN':'BEP.open','BEP_CLOSE':'BEP.closed','BMO_OPEN':'BMO.open','BMO_CLOSE':'BMO.closed','BCP_OPEN':'BCP.open','BCP_CLOSE':'BCP.closed','BEPBMO_BEFORE':'BEP-BMO.before','BEPBMO_AFTER':'BEP-BMO.after','MHE_ROUTE':'MHE.odefsi','MHE_AFTER':'MHE.after','FY_ROUTE':'FY.odefsi','FY_AFTER':'FY.after','KTH_ROUTE':'KTH.odefsi','KTH_AFTER':'KTH.after','MA_ROUTE':'MA.odefsi','MA_AFTER':'MA.after','XM_PRIN':'skamma.prin','XM_OPEN':'skamma.open','XM_SIG':'skamma.simansi','XM_APOK':'skamma.apokatastasi','XM_VLAVI':'vlavi'};
  if(special[step.id]){const p='.p'+String(shot||1).padStart(2,'0');const ext=(step.type==='video')?'.mp4':(step.type==='file'?'.xls':'.jpg');return `${special[step.id]}${p}${ext}`;}
  const token=step.label_for_name.replace(/\{LEVEL2\}/g,(floor!=null?String(floor):"")).replace(/\{SEQ\}/g,String(seq||1));
  const suff=(shot>1)?".p"+String(shot).padStart(2,"0"):""; const ext=(step.type==='video')?'.mp4':(step.type==='file'?'.xls':'.jpg');
  return `${token}${suff}${ext}`;
}
function currentShotCount(stepId,floor,seq){const same=state.items.filter(it=>it.type==="photo"&&it.stepId===stepId&&String(it.floor||"")===String(floor||"")&&String(it.seq||1)===String(seq||1));return same.length+1;}

/* VALIDATION */
function validateFile(file,allowFss=false){
  const max=50*1024*1024, name=(file.name||'').toLowerCase();
  const isIolm=name.endsWith('.iolm'); const isFss=allowFss&&(/\.(xls|xlsx)$/i.test(name));
  if(file.size>max) throw new Error(`Î Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î¿ (${(file.size/1024/1024).toFixed(1)}MB > 50MB)`);
  if(!((file.type&&(file.type.startsWith('image')||file.type.startsWith('video')||file.type==='application/pdf'))||isIolm||isFss)) throw new Error('ÎœÎ· Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿Ï‚ Ï„ÏÏ€Î¿Ï‚');
  return true;
}

/* THUMBS */
function ensureThumb(item){
  if(item.thumb) return;
  if(item.type==='photo'){ item.thumb=URL.createObjectURL(item.file); }
  else if(item.type==='video'){ try{ const v=document.createElement('video'); v.muted=true; v.src=URL.createObjectURL(item.file);
    v.onloadeddata=()=>{ const c=document.createElement('canvas'); const r=Math.min(1,320/Math.max(1,v.videoWidth)); c.width=Math.max(1,Math.round(v.videoWidth*r)); c.height=Math.max(1,Math.round(v.videoHeight*r)); c.getContext('2d').drawImage(v,0,0,c.width,c.height); c.toBlob(b=>{ if(b) item.thumb=URL.createObjectURL(b); renderGallery(); },'image/jpeg',0.7); }; } catch(e){ } }
}

/* ADD ITEMS */
async function addShotFromFile(file){
  try{
    validateFile(file,false);
    const step=state.checklist[state.currentIndex]; if(!step){ closeModal(); return; }
    const floor=step.floor||null, seq=step.seq||1, shot=currentShotCount(step.id,floor,seq);
    const name=buildName(state.job,state.role,step,floor,seq,shot), dest=destinationsFor(step);
    const item={type:'photo',name,destinations:dest,stepId:step.id,floor,seq,shot,file,status:'pending'};
    state.items.push(item); ensureThumb(item); renderGallery(); uploadInfo.textContent='âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ: '+name;
  } catch(err){ uploadInfo.textContent='Î£Ï†Î¬Î»Î¼Î±: '+err.message; }
}
async function addVideoFromFile(file){
  try{
    validateFile(file,false);
    const step=state.checklist[state.currentIndex]; if(!step||step.type!=='video'){ alert('Î¤Î¿ Î²Î®Î¼Î± Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î³Î¹Î± Î²Î¯Î½Ï„ÎµÎ¿'); return; }
    const name=(state.job&&state.job.sr?state.job.sr+'_':'video_')+nowStamp()+'.mp4', dest=destinationsFor(step);
    const item={type:'video',name,destinations:dest,stepId:step.id,file,status:'pending'};
    state.items.push(item); ensureThumb(item); renderGallery(); uploadInfo.textContent='âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î²Î¯Î½Ï„ÎµÎ¿';
  } catch(err){ uploadInfo.textContent='Î£Ï†Î¬Î»Î¼Î±: '+err.message; }
}
async function addFssFile(file){
  const step=state.checklist[state.currentIndex];
  const name=/xlsx$/i.test(file.name||'')?('FSS_'+nowStamp()+'.xlsx'):('FSS_'+nowStamp()+'.xls');
  const dest=destinationsFor(step); const item={type:'file',name,destinations:dest,stepId:step.id,file,status:'pending'};
  state.items.push(item); renderGallery(); uploadInfo.textContent='âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ FSS';
}

/* MODAL open/close */
function openModalAt(i){
  state.currentIndex=i; const step=state.checklist[i];
  modalStepLabel.textContent=step?step.label:'-';
  modalStepId.textContent=step?('stepId: '+step.id):'-';
  modalStepInfo.textContent=step?(step.type==='video'?'Î’Î¯Î½Ï„ÎµÎ¿ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®Ï‚ (<=50MB)':(step.type==='file'?'Î‘ÏÏ‡ÎµÎ¯Î¿ FSS (.xls/.xlsx)':'Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Ï„ÎµÎºÎ¼Î·ÏÎ¯Ï‰ÏƒÎ·Ï‚')):'-';
  if(step && step.id==='AP_FSS'){ fileGal.setAttribute('accept','application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); }
  else { fileGal.setAttribute('accept','image/*,video/*,application/pdf,.iolm'); }
  document.body.style.overflow='hidden';
  modal.style.display='flex';
}
function closeModal(){ modal.style.display='none'; document.body.style.overflow=''; }
modal.onclick=closeModal; modalPanel.onclick=e=>e.stopPropagation();
btnClose.onclick=closeModal;
btnAgain.onclick=()=>fileCam.click();
btnNext.onclick=()=>{ if(state.currentIndex<state.checklist.length-1){ state.currentIndex++; openModalAt(state.currentIndex);} else closeModal(); };

/* >>> FIX: file inputs handlers <<< */
fileCam.onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(f){ addShotFromFile(f); } e.target.value=''; };
fileVid.onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(f){ addVideoFromFile(f); } e.target.value=''; };
fileGal.onchange=e=>{
  const files=[...(e.target.files||[])]; if(!files.length) return;
  const step=state.checklist[state.currentIndex];
  for(const f of files){
    const low=(f.name||'').toLowerCase();
    if(step && step.id==='AP_FSS' && /\.(xls|xlsx)$/i.test(low)){ addFssFile(f); continue; }
    if((f.type||'').startsWith('video')){ if(step && step.type==='video') addVideoFromFile(f); else addVideoFromFile(f); continue; }
    addShotFromFile(f);
  }
  e.target.value='';
};

/* GALLERY + Filters */
document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.filter=b.dataset.filter; renderGallery();}));
function renderGallery(){
  const list=state.items.filter(it=>{
    switch(state.filter){
      case 'photo':return it.type==='photo';
      case 'video':return it.type==='video';
      case 'file':return it.type==='file';
      case 'pending':return !it.status||it.status==='pending';
      case 'uploaded':return it.status==='uploaded';
      case 'error':return it.status==='error';
      default:return true;
    }
  });
  galleryEl.innerHTML=''; itemCount.textContent=`${list.length}/${state.items.length}`; uploadCount.textContent=state.items.length;
  if(!list.length){galleryEmpty.style.display='block';return;} galleryEmpty.style.display='none';
  list.forEach(item=>{
    const box=document.createElement('div'); box.className=`item ${item.type} ${item.status||'pending'}`;
    const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between';
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=item.type==='video'?'ğŸ¥ Î’Î¯Î½Ï„ÎµÎ¿':(item.type==='photo'?'ğŸ“· Î¦Ï‰Ï„Î¿':'ğŸ“„ Î‘ÏÏ‡ÎµÎ¯Î¿');
    const st=document.createElement('span'); st.className='badge'; st.textContent=item.status||'pending'; head.append(badge,st);
    const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='10px'; row.style.margin='8px 0';
    const img=document.createElement('img'); img.className='thumb'; if(item.thumb) img.src=item.thumb; else ensureThumb(item);
    const name=document.createElement('div'); name.className='mono'; name.style.flex='1'; name.textContent=item.name;
    const rep=document.createElement('button'); rep.className='btn'; rep.textContent='ğŸ”'; rep.onclick=()=>{ const i=document.createElement('input'); i.type='file'; i.accept=item.type==='photo'?'image/*':(item.type==='video'?'video/*':'application/pdf,.iolm,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); i.onchange=e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; try{ validateFile(f,item.type==='file'); item.file=f; item.status='pending'; if(item.thumb) try{URL.revokeObjectURL(item.thumb)} catch(e){ } item.thumb=null; ensureThumb(item); renderGallery(); } catch(err){ alert(err.message); } }; i.click(); };
    row.append(img,name,rep);
    const meta=document.createElement('div'); meta.className='muted'; meta.textContent=[`Î²Î®Î¼Î±: ${item.stepId||'-'}`,`Î¼Î­Î³ÎµÎ¸Î¿Ï‚: ${(item.file.size/1024/1024).toFixed(1)}MB`].join(' â€¢ ');
    const dest=document.createElement('div'); dest.className='muted'; dest.style.fontSize='11px'; dest.textContent='ğŸ“ '+(item.destinations||[]).join(' , ');
    const del=document.createElement('button'); del.className='btn'; del.textContent='ğŸ—‘ï¸'; del.style.marginTop='8px'; del.onclick=()=>{ const idx=state.items.findIndex(x=>x===item); if(idx>-1){ if(item.thumb) try{URL.revokeObjectURL(item.thumb)} catch(e){ } state.items.splice(idx,1); renderGallery(); } };
    box.append(head,row,meta,dest,del); galleryEl.appendChild(box);
  });
}

/* UPLOAD */
async function robustReadBase64(file){ const ab=await file.arrayBuffer(); const bytes=new Uint8Array(ab); let bin=''; for(let i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin); }
async function compressPhotoToJpegB64(file){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    img.onload=()=>{ const max=2200; const sc=Math.min(1,max/Math.max(img.width,img.height)); const w=Math.round(img.width*sc),h=Math.round(img.height*sc);
      const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
      const d=c.toDataURL('image/jpeg',0.82); resolve(d.split(',')[1]||''); };
    img.onerror=()=>reject(new Error('image decode'));
    img.src=URL.createObjectURL(file);
  });
}
function isHeic(f){return /image\/(heic|heif)/i.test(f.type||'')||/\.heic$/i.test(f.name||'')}
async function heicToJpegB64(file){ if(!window.heic2any) throw new Error('heic2any missing'); const blob=await window.heic2any({blob:file,toType:'image/jpeg',quality:0.9}); return await robustReadBase64(blob); }

async function uploadToDrive(srName,items){
  await getGeoOnce();

  const cand=items.filter(x=>x.status!=='uploaded'&&x.status!=='uploading'); if(!cand.length){alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± Î±Î½Î­Î²Î±ÏƒÎ¼Î±');return;}
  let done=0, failed=0, failedNames=[]; uploadStatus.style.display='block';
  for(let i=0;i<cand.length;i++){
    const it=cand[i]; let b64='', mime=it.file.type||'application/octet-stream';
    try{
      it.status='uploading'; renderGallery();
      statusText.textContent=`Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± ${i+1}/${cand.length}â€¦`; statusPercent.textContent=Math.round((i/cand.length)*100)+'%'; statusProgress.style.width=Math.round((i/cand.length)*100)+'%';
      if(it.type==='photo'){
        if(isHeic(it.file)){ const h=await heicToJpegB64(it.file); const tmp=new Blob([Uint8Array.from(atob(h),c=>c.charCodeAt(0))],{type:'image/jpeg'}); b64=await compressPhotoToJpegB64(tmp); mime='image/jpeg';}
        else if((it.file.type||'').startsWith('image')){ b64=await compressPhotoToJpegB64(it.file); mime='image/jpeg';}
        else { b64=await robustReadBase64(it.file); }
      }else{ b64=await robustReadBase64(it.file); }
      const payload={srName,techName:(state.techName||''),role:(state.greekRole||''),geo:(state.geo||null),files:[{filename:it.name,mimeType:mime,contentBase64:b64,destinations:it.destinations||['PHOTOS']}]};
      const opts={method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(payload)}; if(IS_LOCAL_ORIGIN) opts.mode='no-cors';
      const res=await fetch(WEBAPP_URL,opts);
      if(IS_LOCAL_ORIGIN&&res.type==='opaque'){ it.status='uploaded'; renderGallery(); done++; continue; }
      const text=await res.text(); let json; try{json=JSON.parse(text)} catch(e){ throw new Error('ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·'); }
      if(!json.ok) throw new Error(json.error||'ok:false');
      it.status='uploaded'; renderGallery(); done++;
    } catch(e){ it.status='error'; failed++; failedNames.push(it.name); renderGallery(); }
  }
  statusText.textContent='ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ'; statusPercent.textContent='100%'; statusProgress.style.width='100%';
  setTimeout(()=>uploadStatus.style.display='none',1200);
  const msg=`Î‘Î½Î­Î²Î·ÎºÎ±Î½: ${done}`+(failed?` â€” Î‘Ï€Î­Ï„Ï…Ï‡Î±Î½: ${failed}`:''); uploadInfo.textContent=msg; if(failed) alert(msg+'\n- '+failedNames.join('\n- '));
}
btnUploadAll.onclick=()=>{ if(!state.job||!state.job.srFolderName){alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ SR ÎºÎ±Î¹ Ï€Î¬Ï„Î± ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚');go('#/sr');return;} if(!state.items.length){alert('Î— ÏƒÏ…Î»Î»Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î±');return;} uploadToDrive(state.job.srFolderName,state.items); };
btnClear.onclick=()=>{ if(confirm('ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î»Î¯ÏƒÏ„Î±Ï‚;')){ state.items.forEach(it=>{ if(it.thumb) try{URL.revokeObjectURL(it.thumb)} catch(e){ } }); state.items=[]; renderGallery(); uploadInfo.textContent='â€”'; } };


/* === DURABLE UPLOADER: 5-parallel with retries, wake lock, guard (non-persistent) === */
(function(){
  const N = 5;              // parallel workers
  const MAX_RETRY = 5;      // per item
  let running = false;
  let paused = false;
  let wake = null;

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function online(){ try { return (typeof navigator.onLine==='boolean' ? navigator.onLine : true) || IS_LOCAL_ORIGIN; } catch(e){ return true; } }

  async function holdWake(){
    try{ if('wakeLock' in navigator){ wake = await navigator.wakeLock.request('screen'); } } catch(e){}
  }
  async function releaseWake(){
    try{ await wake?.release(); } catch(e){}
    wake = null;
  }

  function candidates(){
    return state.items.filter(x => x && x.status !== 'uploaded');
  }

  // Reuse existing helpers from this file
  async function prepareB64(it){
    try{
      let b64 = '', mime = it.file?.type || 'application/octet-stream';
      if(it.type === 'photo'){
        if(isHeic(it.file)){
          const h = await heicToJpegB64(it.file);
          const tmp = new Blob([Uint8Array.from(atob(h), c=>c.charCodeAt(0))], {type:'image/jpeg'});
          b64 = await compressPhotoToJpegB64(tmp); mime='image/jpeg';
        }else if((it.file?.type||'').startsWith('image')){
          b64 = await compressPhotoToJpegB64(it.file); mime='image/jpeg';
        }else{
          b64 = await robustReadBase64(it.file);
        }
      }else{
        b64 = await robustReadBase64(it.file);
      }
      return {b64, mime};
    } catch(e){
      throw e;
    }
  }

  async function sendOne(it, srName){
    const prep = await prepareB64(it);
    const payload = { srName, techName:(state.techName||''), role:(state.greekRole||''), geo:(state.geo||null), files:[{ filename: it.name, mimeType: prep.mime, contentBase64: prep.b64, destinations: it.destinations||['PHOTOS'] }] };
    const opts = { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(payload) };
    if (IS_LOCAL_ORIGIN) opts.mode='no-cors';
    const res = await fetch(WEBAPP_URL, opts);
    if(IS_LOCAL_ORIGIN && res.type==='opaque'){ return {ok:true}; }
    const text = await res.text(); let json;
    try{ json = JSON.parse(text); } catch(e){ throw new Error('ÎœÎ· Î­Î³ÎºÏ…ÏÎ· Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·'); }
    if(!json.ok) throw new Error(json.error||'ok:false');
    return {ok:true};
  }

  async function worker(srName){
    while(true){
      if(paused){ await sleep(500); continue; }
      if(!online()){ await sleep(1200); continue; }
      const it = state.items.find(x => x && x.status !== 'uploaded' && x.status !== 'uploading' && (x.tries||0) < MAX_RETRY);
      if(!it) break;
      it.status='uploading'; renderGallery();
      try{
        statusText.textContent = `Î‘Î½Î­Î²Î±ÏƒÎ¼Î±â€¦`;
        await sendOne(it, srName);
        it.status='uploaded'; it.error=null; renderGallery();
      } catch(e){
        const t = (it.tries||0) + 1;
        it.tries = t; it.status = 'error'; it.error = (e && e.message) || 'upload failed';
        renderGallery();
        const backoff = Math.min(15000, 1000*Math.pow(2, t));
        await sleep(backoff);
      }
      updateProgress();
    }
  }

  function updateProgress(){
    const all = state.items.filter(Boolean).length || 1;
    const done = state.items.filter(x=>x && x.status==='uploaded').length;
    const ratio = Math.round((done/all)*100);
    statusText.textContent = `Î‘Î½Î­Î²Î·ÎºÎ±Î½ ${done}/${all}`;
    statusPercent.textContent = ratio + '%';
    statusProgress.style.width = ratio + '%';
    uploadCount.textContent = state.items.length;
  }

  async function startUpload(){
    await getGeoOnce();

    if(!state.job || !state.job.srFolderName){ alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ SR ÎºÎ±Î¹ Ï€Î¬Ï„Î± ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚'); go('#/sr'); return; }
    if(!state.items.length){ alert('Î— ÏƒÏ…Î»Î»Î¿Î³Î® ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î±'); return; }
    uploadStatus.style.display = 'block';
    updateProgress();
    if(running) return;
    running = true;
    paused = false; await holdWake();
    const srName = state.job.srFolderName;
    const pendingCount = (state.items||[]).filter(x=>x && x.status!=='uploaded').length;
const W = Math.max(1, Math.min(N, pendingCount));
const ws = Array.from({length: W}, ()=> worker(srName));
    await Promise.all(ws);
    await releaseWake();
    running = false;
    setTimeout(()=> uploadStatus.style.display='none', 1200);
  }

  // Hook existing button
  if (btnUploadAll) {
    btnUploadAll.onclick = (e)=>{ e.preventDefault(); startUpload(); return false; };
  }

  // Auto resume on online
  window.addEventListener('online', ()=>{ if(candidates().some(x=>x.status!=='uploaded')) startUpload(); });

  // Warn if leaving with pending
  window.addEventListener('beforeunload', (e)=>{
    const pend = candidates().some(x=> x.status!=='uploaded');
    if(pend){ e.preventDefault(); e.returnValue=''; }
  });

  // Initial progress paint
  updateProgress();

})();


/* ---------- SYNC (list uploaded) ---------- */
var pageSync = document.getElementById('page-sync');
var btnSyncRefresh = document.getElementById('btnSyncRefresh');
var syncInfo = document.getElementById('syncInfo');
var syncList = document.getElementById('syncList');

function parseStepFromName(name){
  var base = String(name||'').toLowerCase()
    .replace(/\.(jpg|jpeg|png|mp4|pdf|xls|xlsx)$/,'')
    .replace(/\s+/g,'');
  var m = base.match(/^(.*?)(?:\.p\d{2})?$/);
  return (m && m[1]) || base;
}

function refreshSync(){
  if(!state.job || !state.job.srFolderName){ 
    alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ SR ÎºÎ±Î¹ Ï€Î¬Ï„Î± ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚'); 
    go('#/sr'); 
    return; 
  }
  var syncInfo = document.getElementById('syncInfo');
  var syncList = document.getElementById('syncList');
  syncInfo.textContent='Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦'; 
  syncList.innerHTML='';

  fetch(WEBAPP_URL+'?action=listUploaded&sr='+encodeURIComponent(state.job.srFolderName)+'&t='+(Date.now()))
    .then(function(res){ return res.json(); })
    .then(function(json){
      if(!json || json.ok===false){ throw new Error((json && json.error) || 'listUploaded failed'); }
      var items = json.items || json.files || [];
      buildUploadedIndex(items);

      if(!items.length){ syncInfo.textContent='Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î±.'; return; }

      // Î¿Î¼Î±Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½Î¬ token
      var map = {};
      items.forEach(function(it){
        var tok = String(it.token||getStepToken(it.name||''));
        if(!map[tok]) map[tok] = [];
        map[tok].push(it);
      });
      var tokens = Object.keys(map).sort();
      syncInfo.textContent = 'Î£ÏÎ½Î¿Î»Î¿ Î±ÏÏ‡ÎµÎ¯Ï‰Î½: '+items.length+' â€¢ Î’Î®Î¼Î±Ï„Î±: '+tokens.length;

      tokens.forEach(function(tok){
        var arr = map[tok].sort(function(a,b){
          return String(a.name).localeCompare(String(b.name));
        });
        var box = document.createElement('div');
        box.className = 'item';
        var head = document.createElement('div');
        head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
        var t = document.createElement('div'); t.style.fontWeight='900'; t.textContent = tok;
        var c = document.createElement('div'); c.className='badge'; c.textContent = arr.length+' Î±ÏÏ‡ÎµÎ¯Î±';
        head.appendChild(t); head.appendChild(c);

        var ul = document.createElement('div'); 
        ul.className='muted'; 
        ul.style.fontSize='11px'; 
        ul.style.marginTop='6px';
        ul.innerHTML = arr.slice(0,8).map(function(f){
			var when = f.time ? new Date(f.time).toLocaleString() : '';
			var meta = [];
			if (f.tech) meta.push('Î¤ÎµÏ‡Î½Î¹ÎºÏŒÏ‚: '+f.tech);
			if (f.role) meta.push('Î¡ÏŒÎ»Î¿Ï‚: '+f.role);
			if (when)   meta.push(when);
  
			// Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— PREVIEW LINK
			const previewLink = f.id ? 
				` <a href="#" class="preview-link" data-file-id="${f.id}" style="color:#3b82f6;text-decoration:none;font-size:10px;margin-left:4px">[ğŸ‘ï¸ Preview]</a>` : 
    '';
    
				return '<div>â€¢ '+f.name + (meta.length? ' â€” '+meta.join(' â€¢ ') : '') + previewLink + '</div>';
}).join('') + (arr.length>8?' <div>â€¦</div>':'');
        box.appendChild(head); box.appendChild(ul);
        syncList.appendChild(box);
      });
    }, function(e){
      syncInfo.textContent='Î£Ï†Î¬Î»Î¼Î±: '+(e && e.message || 'â€”');
    });
}
if (btnSyncRefresh) { btnSyncRefresh.onclick = refreshSync; }

// ===== Uploaded Index (Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ Î±Ï€ÏŒ listUploaded) =====
var uploadedIndex = {
  byToken: new Map(),
  byName: new Set()
};

function getStepToken(name){
  var base = String(name||'').toLowerCase()
    .replace(/\.(jpg|jpeg|png|mp4|pdf|xls|xlsx)$/i,'')
    .replace(/\s+/g,'')
    .replace(/\.p\d{2}$/i,'');
  return base;
}

function buildUploadedIndex(items){
  uploadedIndex.byToken = new Map();
  uploadedIndex.byName = new Set();
  (items || []).forEach(function(it){
    uploadedIndex.byName.add(String(it.name||'').toLowerCase());
    var t = String(it.token||getStepToken(it.name||''));
    var arr = uploadedIndex.byToken.get(t) || [];
    arr.push(it);
    uploadedIndex.byToken.set(t, arr);
  });
}

function refreshUploadedIndex(){
  if(!state.job || !state.job.srFolderName){ return Promise.resolve(); }
  return fetch(WEBAPP_URL+'?action=listUploaded&sr='+encodeURIComponent(state.job.srFolderName)+'&t='+(Date.now()))
    .then(function(res){ return res.json(); })
    .then(function(json){
      if(json && json.ok){ buildUploadedIndex(json.items||json.files||[]); }
    }, function(){ /* ignore */ });
}

// ===== Duplicate detection helpers =====
function nextPageNameForToken(baseName, existingList){
  var max = 0;
  (existingList || []).forEach(function(f){
    var m = String(f.name||'').match(/\.p(\d{2})\./i);
    if(m){ var v = parseInt(m[1],10); if(!isNaN(v) && v>max) max=v; }
  });
  var next = ('0' + (max+1)).slice(-2);
  if (/\.(jpg|jpeg|png|mp4|pdf|xls|xlsx)$/i.test(baseName)) {
    if (/\.p\d{2}\./i.test(baseName)) return baseName.replace(/\.p\d{2}\./i, '.p'+next+'.');
    // Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ pNN, Î²Î¬Î»Îµ Ï€ÏÎ¹Î½ Ï„Î·Î½ ÎºÎ±Ï„Î¬Î»Î·Î¾Î·
    return baseName.replace(/\.(jpg|jpeg|png|mp4|pdf|xls|xlsx)$/i, '.p'+next+'.$&'.slice(1));
  }
  return baseName;
}

function ensureNotDuplicateStepNameOrBump(name){
  var token = getStepToken(name);
  var existArr = uploadedIndex.byToken.get(token) || [];
  if (existArr.length === 0) return { proceed:true, name:name, bumped:false };

  var msg = 'Î¥Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· Î²Î®Î¼Î± "'+token+'" ('+existArr.length+' Î±ÏÏ‡ÎµÎ¯Î±).\n'
          + 'Î˜Î­Î»ÎµÎ¹Ï‚ Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹Ï‚ Ï‰Ï‚ Î½Î­Î± ÏƒÎµÎ»Î¯Î´Î± (Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ pNN) ?\n\n'
          + 'OK = ÎÎ­Î± ÏƒÎµÎ»Î¯Î´Î± (pNN),  Cancel = Î‘ÎºÏÏÏ‰ÏƒÎ·.';
  var ok = window.confirm(msg);
  if (!ok) return { proceed:false, name:name, bumped:false };

  var bumped = nextPageNameForToken(name, existArr);
  return { proceed:true, name:bumped, bumped:true };
}

/* ---------- AUTOPSY PANEL FUNCTIONALITY ---------- */
function initAutopsyPanel() {
  const smartToggle = document.getElementById('smartToggle');
  const smartPointsWrap = document.getElementById('smartPointsWrap');
  const axHoma = document.getElementById('ax_homa');
  const axHomaLvlWrap = document.getElementById('ax_homa_lvl_wrap');
  
  // Smart Readiness toggle
  if (smartToggle) {
    smartToggle.addEventListener('click', function(e) {
      if (e.target.classList.contains('badge')) {
        // Remove active class from all
        smartToggle.querySelectorAll('.badge').forEach(b => b.classList.remove('active'));
        // Add active to clicked
        e.target.classList.add('active');
        
        // Show/hide smart points
        const isYes = e.target.dataset.value === 'ÎÎ‘Î™';
        smartPointsWrap.style.display = isYes ? 'block' : 'none';
      }
    });
  }
  
  // Î§Ï‰Î¼Î±Ï„Î¿Ï…ÏÎ³Î¹ÎºÏŒ toggle
  if (axHoma) {
    axHoma.addEventListener('change', function() {
      axHomaLvlWrap.style.display = this.value === 'ÎÎ‘Î™' ? 'inline-block' : 'none';
    });
  }
  
  // Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ Sheet
  const axSyncSheet = document.getElementById('ax_sync_sheet');
  const axSyncResult = document.getElementById('ax_sync_result');
  
  if (axSyncSheet) {
    axSyncSheet.addEventListener('click', function() {
      if (!state.job || !state.job.srFolderName) {
        axSyncResult.textContent = 'Î”Î¹Î¬Î»ÎµÎ¾Îµ SR Ï€ÏÏÏ„Î±';
        return;
      }
      
      const smartToggleActive = document.querySelector('#smartToggle .badge.active');
      const smartPoints = [];
      document.querySelectorAll('#smartPointsWrap input[type="checkbox"]:checked').forEach(chk => {
        smartPoints.push(chk.dataset.sp);
      });
      
      const payload = {
        action: 'updateAutopsia',
        sr: state.job.srFolderName,
        dig: document.getElementById('ax_homa').value,
        dig_lvl: document.getElementById('ax_homa_lvl').value,
        smart_readiness: smartToggleActive ? smartToggleActive.dataset.value : 'ÎŸÎ§Î™',
        smart_points: smartPoints,
        route_type: document.getElementById('ax_route_type').value,
        const_lvl: document.getElementById('ax_katas_lvl').value,
        bep_floor: document.getElementById('ax_bep_floor').value,
        levels: document.getElementById('ax_levels').value,
        status: document.getElementById('ax_status').value
      };
      
      axSyncResult.textContent = 'Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®...';
      
      fetch(WEBAPP_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(j => {
        axSyncResult.textContent = j.ok ? 'âœ… Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚' : 'âŒ Î£Ï†Î¬Î»Î¼Î±';
      })
      .catch(err => {
        console.error(err);
        axSyncResult.textContent = 'âŒ Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚';
      });
    });
  }
}

function boot(){
  paintFloors();
  paintSmart();
  renderModules();
  renderChecklist();
  renderGallery();
  initAutopsyPanel();
}
boot();

})();
});
</script>

<style>


#de-pending-panel{position:fixed;right:14px;bottom:70px;z-index:9998;width:min(92vw,420px);max-height:60vh;overflow:auto;background:#fff;border:1px solid var(--line,#e5e7eb);border-radius:16px;box-shadow:0 12px 28px rgba(2,6,23,.18);padding:10px;display:none}
#de-pending-panel h3{margin:6px 0 8px;font-size:14px;font-weight:900}
#de-pending-list{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
#de-pending-list .name{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#de-pending-list .stat{font-size:12px;opacity:.7;text-align:right}
#de-pending-panel .actions{display:flex;gap:8px;margin-top:8px}
.btn-lite{padding:8px 10px;border-radius:12px;border:1px solid var(--line,#e5e7eb);background:#fff;font-weight:700}
.btn-primary{padding:8px 10px;border-radius:12px;background:var(--pill,#0f172a);color:var(--pillText,#fff);border:1px solid var(--pill,#0f172a);font-weight:900}
</style>
<div id="de-pending-panel">
  <h3>Î•ÎºÎºÏÎµÎ¼Î® Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± Î±Î½Î­Î²Î±ÏƒÎ¼Î±</h3>
  <div id="de-pending-list"></div>
  <div class="actions">
    <button id="de-retry-all" class="btn-primary">ğŸ” Î•Ï€Î±Î½Î±Ï€ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î±</button>
    <button id="de-clear-uploaded" class="btn-lite">ğŸ§¹ ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î±Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Î±</button>
    <button id="de-close" class="btn-lite">âœ– ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  </div>
</div>
<script>
(function(){
  // Î‘Ï€Î»Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± ÎµÎºÎºÏÎµÎ¼ÏÎ½
  const pendingPanel = document.getElementById('de-pending-panel');
  const pendingList = document.getElementById('de-pending-list');
  const retryBtn = document.getElementById('de-retry-all');
  const clearBtn = document.getElementById('de-clear-uploaded');
  const closeBtn = document.getElementById('de-close');

  if (!pendingPanel) return;

  function refreshPendingList() {
    if (!pendingList) return;
    
    const pendingItems = (window.state?.items || []).filter(item => 
      item && item.status !== 'uploaded'
    );
    
    pendingList.innerHTML = '';
    
    if (pendingItems.length === 0) {
      pendingList.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼Î® Î±ÏÏ‡ÎµÎ¯Î±</div>';
      return;
    }
    
    pendingItems.forEach(item => {
      const row = document.createElement('div');
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr auto';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      row.style.padding = '4px 0';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'name';
      nameDiv.textContent = item.name || 'Unnamed file';
      nameDiv.style.fontSize = '12px';
      nameDiv.style.whiteSpace = 'nowrap';
      nameDiv.style.overflow = 'hidden';
      nameDiv.style.textOverflow = 'ellipsis';
      
      const statusDiv = document.createElement('div');
      statusDiv.className = 'stat';
      statusDiv.textContent = item.status === 'error' ? 'â›” Error' : 'ğŸŸ¡ Pending';
      statusDiv.style.fontSize = '12px';
      statusDiv.style.opacity = '0.7';
      statusDiv.style.textAlign = 'right';
      
      row.appendChild(nameDiv);
      row.appendChild(statusDiv);
      pendingList.appendChild(row);
    });
  }

  // Event listeners
  if (retryBtn) {
    retryBtn.addEventListener('click', function() {
      if (window.state && window.state.items) {
        // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ error/pending items
        window.state.items.forEach(item => {
          if (item.status === 'error' || item.status === 'pending') {
            item.status = 'pending';
            item.tries = 0;
          }
        });
        refreshPendingList();
        
        // Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· upload
        if (typeof startUpload === 'function') {
          startUpload();
        } else if (btnUploadAll) {
          btnUploadAll.click();
        }
      }
    });
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', function() {
      if (window.state && window.state.items && confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î± Î±Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î± Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±;')) {
        // Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· Î¼ÏŒÎ½Î¿ Ï„Ï‰Î½ Î¼Î· Î±Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Ï‰Î½
        window.state.items = window.state.items.filter(item => 
          item && item.status !== 'uploaded'
        );
        refreshPendingList();
        if (typeof renderGallery === 'function') renderGallery();
      }
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      pendingPanel.style.display = 'none';
    });
  }

  // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î»Î¯ÏƒÏ„Î±Ï‚ ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ state
  const originalRenderGallery = window.renderGallery;
  if (originalRenderGallery) {
    window.renderGallery = function() {
      originalRenderGallery();
      refreshPendingList();
    };
  }

  // Î‘ÏÏ‡Î¹ÎºÎ® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·
  refreshPendingList();
})();
</script>


<style>
#de-compress-toggle{position:fixed;right:14px;bottom:130px;z-index:9999;display:flex;align-items:center;gap:8px;
  background:#fff;border:1px solid var(--line,#e5e7eb);border-radius:12px;padding:8px 10px;box-shadow:0 10px 18px rgba(2,6,23,.08);font-weight:700}
#de-compress-progress{position:fixed;left:14px;bottom:14px;z-index:9999;display:none;background:#fff;
  border:1px solid var(--line,#e5e7eb);border-radius:12px;padding:8px 10px;box-shadow:0 10px 18px rgba(2,6,23,.08);min-width:240px}
#de-compress-progress .bar{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px}
#de-compress-progress .bar i{display:block;height:100%;width:0%;;background:var(--pill,#0f172a)}
</style>
<div id="de-compress-progress">
  <div id="de-compress-msg" style="font-size:12px;font-weight:700">Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· Î²Î¯Î½Ï„ÎµÎ¿â€¦</div>
  <div class="bar"><i id="de-compress-bar"></i></div>
</div>


<script>
// v6.22 â€” Client-side video compression with ffmpeg.wasm (720p/30fps ~3Mbps)
(function(){
  const MB = 1024*1024;
  const LIMIT_DIRECT = 150*MB;  // <= 150MB -> upload as is
  const APPSCRIPT_LIMIT = 50*MB; // informational: Apps Script often fails >50MB
  const TRY_COMPRESS_FROM = 150*MB;  // >150MB -> try compress
  const TOO_BIG_RESUMABLE = 800*MB;  // >800MB -> suggest resumable

  const $toggle = document.getElementById('de-compress-check');
  const $panel  = document.getElementById('de-compress-progress');
  const $msg    = document.getElementById('de-compress-msg');
  const $bar    = document.getElementById('de-compress-bar');

  function showProgress(text, pct){
    if(!$panel) return;
    $panel.style.display='block';
    if($msg) $msg.textContent = text || 'Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ·â€¦';
    if($bar) $bar.style.width = (pct||0)+'%';
  }
  function hideProgress(){
    if($panel) $panel.style.display='none';
    if($bar) $bar.style.width = '0%';
  }

  async function compressVideoIfNeeded(blob){
    try{
      const size = blob.size || 0;
      const doCompress = $toggle ? $toggle.checked : true;

      if(!doCompress || size <= TRY_COMPRESS_FROM){
        return { blob, note: 'no_compress' };
      }

      // For extremely large files, still try but warn later if it fails
      await window.__ffmpegLoader?.();

      if(!window.FFmpeg){ throw new Error('FFmpeg not available'); }
      // Create ffmpeg instance
      const { createFFmpeg } = FFmpeg;
      const ffmpeg = createFFmpeg({ log: false, corePath: undefined });

      showProgress('Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ffmpegâ€¦', 5);
      if(!ffmpeg.isLoaded()){
        await ffmpeg.load();
      }

      // Read input blob
      const inputName = 'input.mp4';
      const outputName = 'output.mp4';
      const buf = await blob.arrayBuffer();
      ffmpeg.FS('writeFile', inputName, new Uint8Array(buf));

      // Hook progress
      let last = 0;
      ffmpeg.setProgress(({ ratio })=>{
        const pct = Math.max(5, Math.round(ratio*100));
        if(pct - last >= 1){
          last = pct;
          showProgress('Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· Î²Î¯Î½Ï„ÎµÎ¿â€¦ '+pct+'%', pct);
        }
      });

      // Encode (720p, 30fps, ~3M video, 96k audio)
      // -vf scale=-2:720 keeps aspect (width divisible by 2)
      await ffmpeg.run(
        '-i', inputName,
        '-vf', 'scale=-2:720', '-r', '30',
        '-c:v', 'libx264', '-preset', 'veryfast', '-b:v', '3M',
        '-movflags', 'faststart',
        '-c:a', 'aac', '-b:a', '96k',
        outputName
      );

      const data = ffmpeg.FS('readFile', outputName);
      const outBlob = new Blob([data.buffer], { type: 'video/mp4' });
      hideProgress();

      // If output didn't reduce sufficiently, keep the smaller one
      if (outBlob.size < blob.size) {
        return { blob: outBlob, note: 'compressed' };
      } else {
        return { blob, note: 'compress_not_smaller' };
      }
    }catch(e){
      hideProgress();
      return { blob, error: e.message || String(e) };
    }
  }

  // Patch into global uploadOne from v6.21 (wrap)
  if (typeof uploadOne === 'function'){
    const originalUploadOne = uploadOne;
    window.uploadOne = async function(item){
      const isVideo = (item.blob.type||'').startsWith('video/');
      try{
        if(isVideo){
          const size = item.blob.size||0;
          if(size > TOO_BIG_RESUMABLE){
            // Try compress anyway
            const res = await compressVideoIfNeeded(item.blob);
            if(res.error){
              throw new Error('ÎœÎµÎ³Î¬Î»Î¿ Î²Î¯Î½Ï„ÎµÎ¿, Î±Ï€Î­Ï„Ï…Ï‡Îµ Î· ÏƒÏ…Î¼Ï€Î¯ÎµÏƒÎ·: '+res.error);
            }
            item.blob = res.blob;
          }else if(size > TRY_COMPRESS_FROM){
            const res = await compressVideoIfNeeded(item.blob);
            if(!res.error && res.blob && res.blob.size < item.blob.size){
              item.blob = res.blob;
            }
            // if compression fails or not smaller, proceed as-is (will likely fail on Apps Script if >50MB)
          }
        }
        return await originalUploadOne(item);
      }catch(err){
        // Keep item pending; surface user-friendly error
        const msg = (''+err.message||err).toLowerCase();
        if(isVideo && (item.blob.size||0) > (50*1024*1024)){
          // Suggest resumable or export
          alert('â—Î¤Î¿ Î²Î¯Î½Ï„ÎµÎ¿ ÎµÎ¯Î½Î±Î¹ Î¼ÎµÎ³Î¬Î»Î¿.\nâ€¢ Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· (ÎµÎ½ÎµÏÎ³ÏŒ toggle) Î®\nâ€¢ Î•Î¾Î±Î³Ï‰Î³Î® Î±Ï€ÏŒ Ï„Î¿ Î¼ÎµÎ½Î¿Ï "ğŸ“¥ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚" Î³Î¹Î± Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î· Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¬.\nÎ£Ï†Î¬Î»Î¼Î±: '+(err.message||err));
        } else {
          throw err;
        }
      } finally {
        hideProgress();
      }
    };
  }

})();
</script>


<style>
#de-settings-modal{position:fixed;inset:0;z-index:10000;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center}
#de-settings-card{background:#fff;color:#0f172a;width:92%;max-width:520px;border-radius:18px;box-shadow:0 20px 48px rgba(2,6,23,.2);padding:14px 14px 16px}
#de-settings-card h3{margin:6px 0 10px;font-size:16px}
#de-settings-card .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#de-settings-card label{font-size:12px;font-weight:700}
#de-settings-card select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
#de-settings-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
#de-settings-actions button{border-radius:12px;padding:10px 14px;border:1px solid #e5e7eb;background:#fff;font-weight:800}
#de-settings-actions .save{background:#0f172a;color:#fff;border-color:#0f172a}
#de-compress-progress{display:none;margin-top:8px;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
#de-compress-progress .bar{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px}
#de-compress-progress .bar i{display:block;height:100%;width:0%;;background:#0f172a}
/* bottom bar + modal tools */
.de-bottombar{position:fixed;left:0;right:0;bottom:0;z-index:60;background:#fff;
  border-top:1px solid #e5e7eb;display:grid;grid-template-columns:repeat(5,1fr);gap:0}
.de-bottombar a, .de-bottombar button{appearance:none;-webkit-appearance:none;
  background:#fff;border:0;padding:10px 6px;font-weight:800;color:#0f172a;text-align:center}
.de-bottombar .item{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;font-size:12px}
.de-bottombar .item.active{background:#0f172a;color:#fff}
#toolsModal{position:fixed;inset:0;z-index:10000;display:none;align-items:flex-end;justify-content:center;background:rgba(15,23,42,.45)}
#toolsCard{width:100%;max-width:960px;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;
  box-shadow:0 -20px 48px rgba(2,6,23,.2);padding:14px;border:1px solid #e5e7eb;border-bottom:none}
#toolsCard h3{margin:0 0 12px 0;font-size:16px}
#toolsList{display:flex;flex-direction:column;gap:10px}
#toolsList button{padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-weight:900;text-align:left}
#toolsClose{display:block;margin:10px auto 0 auto;border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:10px 14px;font-weight:800}
body{padding-bottom:64px}
@media (min-width:720px){ body{padding-bottom:72px} }
</style>
<div id="de-settings-modal">
  <div id="de-settings-card">
    <h3>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï€Î¿Î¹ÏŒÏ„Î·Ï„Î±Ï‚</h3>
    <div class="row">
      <div>
        <label>ğŸ“· ÎœÎ­Î³Î¹ÏƒÏ„Î· Ï€Î»ÎµÏ…ÏÎ¬ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚ (px)</label>
        <select id="de-photo-edge">
          <option value="800">800</option>
          <option value="1080">1080</option>
          <option value="1200">1200</option>
          <option value="1600" selected>1600</option>
        </select>
      </div>
      <div>
        <label>ğŸ“¦ Î£Ï„ÏŒÏ‡Î¿Ï‚ Î¼ÎµÎ³Î­Î¸Î¿Ï…Ï‚ (KB)</label>
        <select id="de-photo-target">
          <option value="300">300</option>
          <option value="350">350</option>
          <option value="400" selected>400</option>
          <option value="450">450</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>ğŸ¥ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î²Î¯Î½Ï„ÎµÎ¿</label>
        <select id="de-video-res">
          <option value="720" selected>720p</option>
          <option value="1080">1080p</option>
        </select>
      </div>
      <div>
        <label>ğŸï¸ Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· Î²Î¯Î½Ï„ÎµÎ¿ Ï€ÏÎ¹Î½ Ï„Î¿ upload</label>
        <select id="de-video-compress">
          <option value="on" selected>Î•Î½ÎµÏÎ³Î®</option>
          <option value="off">Î‘Î½ÎµÎ½ÎµÏÎ³Î®</option>
        </select>
      </div>
    </div>
    <div id="de-compress-progress">
      <div id="de-compress-msg" style="font-size:12px;font-weight:700">Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· Î²Î¯Î½Ï„ÎµÎ¿â€¦</div>
      <div class="bar"><i id="de-compress-bar"></i></div>
    </div>
    <div id="de-settings-actions">
      <button class="save" id="de-settings-save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
      <button id="de-settings-cancel">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
</div>
<nav class="de-bottombar" id="deBottomBar">
  <button class="item" id="navHome" type="button">ğŸ <span>Î‘ÏÏ‡Î¹ÎºÎ®</span></button>
  <button class="item" id="navStruct" type="button">ğŸ¢<span>Î”Î¿Î¼Î®</span></button>
  <button class="item" id="navGallery" type="button">ğŸŒ„<span>Î£Ï…Î»Î»Î¿Î³Î®</span></button>
  <button class="item" id="navSync" type="button">ğŸ”„<span>Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚</span></button>
  <button class="item" id="navTools" type="button">ğŸ§°<span>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</span></button>
</nav>
<div id="toolsModal" role="dialog" aria-modal="true" aria-label="Î•ÏÎ³Î±Î»ÎµÎ¯Î±">
  <div id="toolsCard">
    <h3>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</h3>
    <div id="toolsList">
      <button id="toolSettings">âš™ï¸ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
      <button id="toolPending">ğŸ•“ Î•ÎºÎºÏÎµÎ¼Î®</button>
      <button id="toolDownloadAll">â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚</button>
    </div>
    <button id="toolsClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  </div>
</div>


<script>
(function(){
  const qs = s=>document.querySelector(s);
  const $modal = qs('#de-settings-modal');
  const $edge = qs('#de-photo-edge');
  const $target = qs('#de-photo-target');
  const $vres = qs('#de-video-res');
  const $vcomp = qs('#de-video-compress');
  const $save = qs('#de-settings-save');
  const $cancel = qs('#de-settings-cancel');

  const SKEY = 'de_settings_v1';
  const def = { edge:1600, target:400, vres:720, vcomp:'on' };
  function load(){ try { return Object.assign({}, def, JSON.parse(localStorage.getItem(SKEY)||'{}')); } catch(e){ return def; } }
  function save(v){ localStorage.setItem(SKEY, JSON.stringify(v)); }
  function applyUI(v){ if($edge) $edge.value=String(v.edge); if($target) $target.value=String(v.target); if($vres) $vres.value=String(v.vres); if($vcomp) $vcomp.value=v.vcomp; }

  const st = load(); applyUI(st);
  $cancel && $cancel.addEventListener('click', ()=>{ $modal.style.display='none'; });
  $save && $save.addEventListener('click', ()=>{
    const v = { edge:parseInt($edge.value,10), target:parseInt($target.value,10), vres:parseInt($vres.value,10), vcomp:$vcomp.value };
    save(v);
    $modal.style.display='none';
    try{ (window.showToast||alert)('âœ”ï¸ Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ Î¿Î¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚'); }catch(e){}
  });

  // Bottom-bar Tools modal
  const $tools = document.getElementById('navTools');
  const $tModal = document.getElementById('toolsModal');
  const $close = document.getElementById('toolsClose');
  function openTools(){ $tModal.style.display='flex'; }
  function closeTools(){ $tModal.style.display='none'; }
  $tools && $tools.addEventListener('click', openTools);
  $close && $close.addEventListener('click', closeTools);
  $tModal && $tModal.addEventListener('click', (e)=>{ if(e.target === $tModal) closeTools(); });

  document.getElementById('toolSettings')?.addEventListener('click', ()=>{
    closeTools();
    const m = document.getElementById('de-settings-modal');
    if(m){ applyUI(load()); m.style.display='flex'; } else { alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.'); }
  });
  document.getElementById('toolPending')?.addEventListener('click', ()=>{
    closeTools();
    const sel = '#de-pending-panel, #pendingPanel, [data-pending-list], .pending-list, .uploadQueue, .queue';
    const el = document.querySelector(sel);
    if(el){ el.scrollIntoView({behavior:'smooth', block:'center'}); } else { alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î»Î¯ÏƒÏ„Î± ÎµÎºÎºÏÎµÎ¼ÏÎ½.'); }
  });
  document.getElementById('toolDownloadAll')?.addEventListener('click', async()=>{
    closeTools();
    const cands = [window.exportAllZip, window.downloadAllLocal, window.exportAll];
    for(const fn of cands){ if(typeof fn==='function'){ try{ await fn(); return; }catch(e){} } }
    alert('Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± "ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚" Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· ÏƒÏ„Î·Î½ Ï€Î±ÏÎ¿ÏÏƒÎ± Î­ÎºÎ´Î¿ÏƒÎ·.');
  });

  // Photo resize before upload, if uploadOne exists
  async function resizePhotoBlob(blob){
    const s = load();
    const maxEdge = s.edge||1600;
    const targetKB = s.target||400;
    const createBmp = (window.createImageBitmap ? window.createImageBitmap : (file)=>new Promise((resolve,reject)=>{
      const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject;
      img.src = URL.createObjectURL(file);
    }));
    const img = await createBmp(blob).catch(()=>null);
    if(!img) return blob;
    const width = img.width, height = img.height;
    const scale = Math.min(1, maxEdge/Math.max(width,height));
    const outW = Math.max(1, Math.round(width*scale));
    const outH = Math.max(1, Math.round(height*scale));
    const canvas = document.createElement('canvas');
    canvas.width = outW; canvas.height = outH;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, outW, outH);

    let low=0.5, high=0.95, best=null;
    for(let i=0;i<8;i++){
      const q=(low+high)/2;
      const b=await new Promise(r=>canvas.toBlob(r,'image/jpeg',q));
      const kb=Math.ceil((b.size||0)/1024);
      best=b;
      if(kb > Math.max(500, targetKB)) high=q; else low=q;
    }
    return best || blob;
  }

  if (typeof uploadOne === 'function'){
    const _u1 = uploadOne;
    window.uploadOne = async function(item){
      try{
        const type = (item.blob?.type||'');
        if(type.startsWith('image/')){
          item.blob = await resizePhotoBlob(item.blob);
        }else if(type.startsWith('video/')){
          const s2 = load();
          window.__DE_VIDEO_TARGET_RES__ = s2.vres||720;
          window.__DE_VIDEO_SHOULD_COMPRESS__ = s2.vcomp !== 'off';
        }
      }catch(e){ console.warn('resize/compress prep error', e); }
      return await _u1(item);
    };
  }

  // Minimal compressor hooks (used by ffmpeg wasm patch in v6.22)
  (function patchCompressorUI(){
    if(!document.getElementById('de-compress-progress')){
      const area = document.body;
      const wrap = document.createElement('div');
      wrap.innerHTML = '<div id="de-compress-progress" style="display:none;margin:8px;border:1px solid #e5e7eb;border-radius:12px;padding:8px">'+
        '<div id="de-compress-msg" style="font-size:12px;font-weight:700">Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ· Î²Î¯Î½Ï„ÎµÎ¿â€¦</div>'+
        '<div class="bar" style="height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px"><i id="de-compress-bar" style="display:block;height:100%;width:0%;background:#0f172a"></i></div>'+
      '</div>';
      area.appendChild(wrap.firstChild);
    }
    const panel  = document.getElementById('de-compress-progress');
    const msg    = document.getElementById('de-compress-msg');
    const bar    = document.getElementById('de-compress-bar');
    window.__DE_COMPRESS_UI__ = {
      showProgress(text, pct){ panel.style.display='block'; if(msg) msg.textContent = text||'Î£Ï…Î¼Ï€Î¯ÎµÏƒÎ·â€¦'; if(bar) bar.style.width=(pct||0)+'%'; },
      hideProgress(){ panel.style.display='none'; if(bar) bar.style.width='0%'; }
    };
  })();

  window.__DE_VIDEO_SETTINGS__ = {
    shouldCompress(){ const s=load(); return (s.vcomp!=='off'); },
    targetRes(){ const s=load(); return s.vres||720; }
  };
})();
</script>


<script>
// Wire bottom bar nav to existing tabs/sections (defensive)
(function(){
  function $(s,root){return (root||document).querySelector(s)}
  function $all(s,root){return Array.from((root||document).querySelectorAll(s))}
  function findTabByText(txt){
    const cands = $all('.tabs .tab, .tab, nav .tablink, button.tab, a.tab');
    const t = (txt||'').toLowerCase();
    return cands.find(el => (el.textContent||'').toLowerCase().includes(t)) || null;
  }
  function activateByIdList(ids){
    for(const id of ids){
      const el = id && $(id);
      if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); return true; }
    }
    return false;
  }
  function showSectionFallback(keys){
    // Common containers used in our app
    const map = {
      home: ['#home','#homeSection','#start','#main'],
      struct: ['#structure','#structurePanel','#structureWrap','#bepStructure','#modulesStructure'],
      gallery: ['#gallery','#galleryPanel','#galleryWrap','#collect','#upload','#collection'],
      sync: ['#page-sync','[data-page="#/sync"]','#sync','#pageSync']
    };
    for(const k of keys){
      if(activateByIdList(map[k]||[])) return true;
    }
    return false;
  }
  function clickOrFallback(label, keys){
    // 1) try clicking an existing tab/link with matching text
    const t = findTabByText(label);
    if(t){ t.click(); return true; }
    // 2) try events on data-tab
    const dt = $(`[data-tab*="${label}"]`);
    if(dt){ dt.click(); return true; }
    // 3) show known section ids
    return showSectionFallback(keys);
  }
  const homeBtn = $('#navHome');
  const structBtn = $('#navStruct');
  const galleryBtn = $('#navGallery');
  const toolsBtn = $('#navTools');
  function setActive(btn){
    document.querySelectorAll('.de-bottombar .item').forEach(b=>b.classList.remove('active'));
    btn && btn.classList.add('active');
  }
  homeBtn && homeBtn.addEventListener('click', ()=>{
    const ok = clickOrFallback('Î‘ÏÏ‡Î¹ÎºÎ®',['home']);
    setActive(homeBtn);
    if(!ok) console.warn('BottomNav: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ Î³Î¹Î± Î‘ÏÏ‡Î¹ÎºÎ®.');
  });
  structBtn && structBtn.addEventListener('click', ()=>{
    const ok = clickOrFallback('Î”Î¿Î¼Î®',['struct']);
    setActive(structBtn);
    if(!ok) console.warn('BottomNav: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ Î³Î¹Î± Î”Î¿Î¼Î®.');
  });
  galleryBtn && galleryBtn.addEventListener('click', ()=>{
    const ok = clickOrFallback('Î£Ï…Î»Î»Î¿Î³Î®',['gallery']);
    setActive(galleryBtn);
    if(!ok) console.warn('BottomNav: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„ÏŒÏ‡Î¿Ï‚ Î³Î¹Î± Î£Ï…Î»Î»Î¿Î³Î®.');
  });
  toolsBtn && toolsBtn.addEventListener('click', ()=> setActive(toolsBtn));
})();
</script>


<!-- Tools Panel & Sheet -->
<style>
#panel-tools{display:none}
#panel-tools .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
#panel-tools .grid button{padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-weight:900}
@media (max-width:460px){#panel-tools .grid{grid-template-columns:1fr}}
#toolsSheet{position:fixed;left:0;right:0;bottom:0;display:none;z-index:10050}
#toolsSheet .sheet{margin:0 auto;max-width:960px;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -20px 48px rgba(2,6,23,.2);padding:14px;border:1px solid #e5e7eb;border-bottom:none}
#toolsBackdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;z-index:10040}
</style>
<section class="card" id="panel-tools">
  <div class="title">ğŸ§° <div>Î•ÏÎ³Î±Î»ÎµÎ¯Î±</div></div>
  <div class="grid" style="margin-top:10px">
    <button id="tool-open-settings">âš™ï¸ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
    <button id="tool-toggle-pending">ğŸŸ¡ Î•ÎºÎºÏÎµÎ¼Î®</button>
    <button id="tool-export-zip">â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚</button>
  </div>
</section>
<div id="toolsBackdrop"></div>
<div id="toolsSheet" role="dialog" aria-modal="true" aria-label="Î•ÏÎ³Î±Î»ÎµÎ¯Î±">
  <div class="sheet">
    <h3 style="margin:0 0 12px 0">Î•ÏÎ³Î±Î»ÎµÎ¯Î±</h3>
    <div style="display:grid;gap:10px">
      <button id="sht-settings" class="btn">âš™ï¸ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
      <button id="sht-pending" class="btn">ğŸŸ¡ Î•ÎºÎºÏÎµÎ¼Î®</button>
      <button id="sht-zip" class="btn">â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚</button>
      <button id="sht-close" class="btn">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
</div>


<script>
async function exportAllZip(){
  try{
    console.log('Starting ZIP export...');
    
    // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î± items Î±Ï€ÏŒ Ï„Î¿ state
    const items = (window.state && Array.isArray(window.state.items)) ? window.state.items : [];
    
    console.log('Items found:', items.length);
    console.log('Items:', items);
    
    if (!items.length){ 
      alert('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÏÏ‡ÎµÎ¯Î± ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î±. Î Î®Î³Î±Î¹Î½Îµ Ï€ÏÏÏ„Î± ÏƒÏ„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± "Î¦Ï‰Ï„Î¿Î³ÏÎ¬Ï†Î¹ÏƒÎ·" Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚.'); 
      return; 
    }
    
    if (!window.JSZip){ 
      // Fallback Î±Î½ Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Ï„Î¿ JSZip
      alert('JSZip Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬ Î® Î±Î½Î±Î½ÎµÏÏƒÏ„Îµ Ï„Î· ÏƒÎµÎ»Î¯Î´Î±.');
      return; 
    }
    
    const zip = new JSZip();
    let addedCount = 0;
    
    // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Î±Ï€ÏŒ Ï„Î· ÏƒÏ…Î»Î»Î¿Î³Î®
    for (const it of items){
      try{
        if (!it || !it.file) {
          console.log('Skipping item - no file:', it);
          continue;
        }
        
        // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Î±Ï€ÏŒ Ï„Î¿ state Î® Î±Ï€ÏŒ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿
        const name = it.name || it.file.name || `photo_${addedCount + 1}.jpg`;
        const blob = it.file;
        
        console.log('Adding to ZIP:', name, 'size:', blob.size);
        
        if (blob instanceof Blob){
          zip.file(name, blob);
          addedCount++;
        }
      }catch(e){ 
        console.warn('Skip item in ZIP:', e, it); 
      }
    }
    
    console.log('Total files added to ZIP:', addedCount);
    
    if (addedCount === 0) {
      alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± ÎµÎ¾Î±Î³Ï‰Î³Î®. Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Î­Ï‡ÎµÏ„Îµ Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ ÏƒÏ„Î· ÏƒÏ…Î»Î»Î¿Î³Î®.');
      return;
    }
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ZIP
    const content = await zip.generateAsync({
      type: 'blob',
      compression: 'DEFLATE',
      compressionOptions: { level: 6 }
    });
    
    const fileName = (window.state && window.state.job && window.state.job.srFolderName ? 
                     window.state.job.srFolderName.replace(/[^a-zA-Z0-9]/g, '_') : 'photos') + 
                     '_export_' + new Date().toISOString().slice(0,10) + '.zip';
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± link Î³Î¹Î± download
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = fileName;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Cleanup Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 30 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
    }, 30000);
    
    console.log('ZIP export completed:', fileName);
    
  }catch(err){
    console.error('ZIP export error:', err);
    alert('Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î¿ export ZIP: ' + (err && err.message || err));
  }
}

// Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· globally
window.exportAllZip = exportAllZip;
</script>

<script>
(function(){
  try{
    // Hash router for Tools
    const toolsPanel = document.getElementById('panel-tools');
    const toolsTab = document.getElementById('tab-tools');
    const sheet = document.getElementById('toolsSheet');
    const back  = document.getElementById('toolsBackdrop');
    function openSheet(){ if(sheet) sheet.style.display='block'; if(back) back.style.display='block'; }
    function closeSheet(){ if(sheet) sheet.style.display='none'; if(back) back.style.display='none'; }
    function setActive(el){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el && el.classList.add('active'); }
    function handleHash(){
      const h = location.hash||'';
      if (h==="#/tools"){ if(toolsPanel){ toolsPanel.style.display='block'; setActive(toolsTab); } openSheet(); }
      else { if(toolsPanel){ toolsPanel.style.display='none'; } closeSheet(); }
    }
    window.addEventListener('hashchange', handleHash);
    document.addEventListener('DOMContentLoaded', handleHash);

    // Bottom bar "Î‘ÏÏ‡Î¹ÎºÎ®" â†’ scroll to top & clear hash
    [...document.querySelectorAll('a,button')].forEach(el=>{
      const t=(el.textContent||'').trim();
      if(t==='Î‘ÏÏ‡Î¹ÎºÎ®' || el.dataset.tab==='home'){
        el.addEventListener('click', (ev)=>{ ev.preventDefault(); document.scrollingElement?.scrollTo({top:0, behavior:'smooth'}); history.replaceState(null,'','#/'); setActive(el); });
      }
    });

    // Tools actions (both in panel and sheet)
    function togglePending(){
      const p = document.getElementById('de-pending-panel');
      if (!p){ alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ panel ÎµÎºÎºÏÎµÎ¼ÏÎ½'); return; }
      p.style.display = (p.style.display==='block'?'none':'block');
      if (p.style.display==='block'){ p.scrollIntoView({behavior:'smooth', block:'center'}); }
    }
    function openSettings(){
      const m = document.getElementById('de-settings-modal');
      if(m) m.style.display='flex'; else alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ modal ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½');
    }
    document.getElementById('tool-open-settings')?.addEventListener('click', openSettings);
    document.getElementById('tool-toggle-pending')?.addEventListener('click', togglePending);
    document.getElementById('tool-export-zip')?.addEventListener('click', ()=>{ if (typeof exportAllZip==='function') exportAllZip(); else alert('Î›ÎµÎ¯Ï€ÎµÎ¹ exportAllZip'); });
    document.getElementById('sht-settings')?.addEventListener('click', openSettings);
    document.getElementById('sht-pending')?.addEventListener('click', togglePending);
    document.getElementById('sht-zip')?.addEventListener('click', function() {
		if (typeof exportAllZip === 'function') {
			exportAllZip();
		} else {
			alert('Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎµÎ¾Î±Î³Ï‰Î³Î®Ï‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·. Î‘Î½Î±Î½ÎµÏÏƒÏ„Îµ Ï„Î· ÏƒÎµÎ»Î¯Î´Î±.');
		}
	  });
    document.getElementById('sht-close')?.addEventListener('click', closeSheet);
    back?.addEventListener('click', closeSheet);
  }catch(e){ console.warn('tools init error', e); }
})();
</script>
<script>
// Debug function Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿ state
function debugState() {
  console.log('=== DEBUG STATE ===');
  console.log('State:', window.state);
  console.log('Items:', window.state?.items);
  console.log('Items count:', window.state?.items?.length);
  if (window.state?.items) {
    window.state.items.forEach((item, index) => {
      console.log(`Item ${index}:`, item.name, item.file, item.status);
    });
  }
  console.log('===================');
}

// Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· debug button (Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼ÏŒÎ½Î¿ Î³Î¹Î± testing)
const debugBtn = document.createElement('button');
debugBtn.textContent = 'ğŸ› Debug';
debugBtn.style.position = 'fixed';
debugBtn.style.top = '10px';
debugBtn.style.right = '10px';
debugBtn.style.zIndex = '99999';
debugBtn.style.padding = '5px';
debugBtn.style.fontSize = '12px';
debugBtn.onclick = debugState;
document.body.appendChild(debugBtn);
</script>

<script>
(function(){
  function safe(fn){ return function(){ try{ return (typeof fn==='function') ? fn() : null; }catch(e){} }; }
  var m = document.getElementById('de-settings-modal');
  var p = document.getElementById('de-pending-panel');
  var zip = (typeof exportAllZip==='function') ? exportAllZip : null;
  var el;
  if (el=document.getElementById('toolSettings')){ el.onclick = function(){ if(m) m.style.display='flex'; }; }
  if (el=document.getElementById('toolPending')){ el.onclick = function(){ if(p){ p.style.display = (p.style.display==='block'?'none':'block'); } }; }
  if (el=document.getElementById('toolDownloadAll')){ el.onclick = function(){ if(zip) zip(); else alert('Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ ÏŒÎ»ÎµÏ‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·.'); }; }
})();
</script>


<!-- Robust bottom-bar navigation binding (safe override) -->
<script>
(function(){
  function $ (sel, root){ return (root||document).querySelector(sel); }
  function $$ (sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function setActive(btn){
    $$(".de-bottombar .item").forEach(b=>b.classList.remove("active"));
    if(btn) btn.classList.add("active");
  }
  function showRouteFallback(route){
    // Fallback when no global go() exists: show [data-page=route]
    var target = document.querySelector('[data-page="' + route + '"]');
    if(!target) return false;
    $("[data-page]") && $$("[data-page]").forEach(p=>p.classList.add("hidden"));
    target.classList.remove("hidden");
    // highlight top tabs if present
    $$(".tab").forEach(t=>t.classList.toggle("active", t.getAttribute("data-route")===route));
    try{ if(location.hash !== route) location.hash = route; }catch(e){}
    try{ document.scrollingElement && document.scrollingElement.scrollTo({top:0, behavior:"smooth"}); }catch(e){}
    return true;
  }
  function navigate(btn, route){
    try{
      if (typeof go === "function"){ go(route); }
      else {
        // try click on existing top tab
        var t = document.querySelector('.tab[data-route="' + route + '"]');
        if (t) { try{ t.click(); }catch(e){} }
        else { showRouteFallback(route); }
      }
      try{ if(location.hash !== route) location.hash = route; }catch(e){}
    }catch(e){
      // hard fallback
      showRouteFallback(route);
    }
    setActive(btn);
  }
  function bind(){
    var homeBtn = document.getElementById("navHome");
    var structBtn = document.getElementById("navStruct");
    var galleryBtn = document.getElementById("navGallery");
    var syncBtn = document.getElementById("navSync");
    var toolsBtn = document.getElementById("navTools");
    homeBtn && homeBtn.addEventListener("click", ()=> navigate(homeBtn, "#/sr"));
    structBtn && structBtn.addEventListener("click", ()=> navigate(structBtn, "#/structure"));
    galleryBtn && galleryBtn.addEventListener("click", ()=> navigate(galleryBtn, "#/gallery"));
    syncBtn && syncBtn.addEventListener("click", ()=> navigate(syncBtn, "#/sync"));
    toolsBtn && toolsBtn.addEventListener("click", ()=> setActive(toolsBtn));
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", bind);
  else bind();
})();
</script>


<!-- DE-SYNC PATCH v1: Non-destructive sync renderer -->
<script>
(function(){
  var WEBAPP_URL = window.WEBAPP_URL || (window.WEBAPP && window.WEBAPP.URL) || (function(){
    try {
      var scripts = document.scripts || [];
      for (var i=0;i<scripts.length;i++){
        var t = scripts[i].textContent||'';
        var m = t.match(/const\s+WEBAPP_URL\s*=\s*['"]([^'"]+)['"]/);
        if(m) return m[1];
      }
    }catch(e){}
    return '';
  })();

  function text(el){ return (el && (el.textContent||'')).trim(); }
  function $(s,root){ return (root||document).querySelector(s); }

  function getCurrentSRName(){
    try{
      if (window.state && state.job && state.job.srFolderName) return state.job.srFolderName;
    }catch(e){}
    var el = $("#srInfo");
    if (el){
      var t = text(el);
      var i = t.indexOf("Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ:");
      if (i>-1) return t.slice(i+12).trim();
      return t;
    }
    var inSR = $("#inSR") || $("#srInput");
    if (inSR && inSR.value) return inSR.value.trim();
    return "";
  }

  function humanSize(bytes){
    var b = Number(bytes||0);
    if (b<1024) return b+" B";
    if (b<1024*1024) return (b/1024).toFixed(1)+" KB";
    return (b/1024/1024).toFixed(1)+" MB";
  }

  function renderSyncList(srName, selector){
    selector = selector || "#syncResults";
    var host = document.querySelector(selector);
    if(!host){ console.warn("DE-SYNC: host not found:", selector); return; }
    if(!srName){ host.innerHTML = '<div class="muted">Î”Î¹Î¬Î»ÎµÎ¾Îµ SR Ï€ÏÏÏ„Î±.</div>'; return; }
    if(!WEBAPP_URL){ host.innerHTML = '<div class="muted">WEBAPP_URL Î´ÎµÎ½ Î¿ÏÎ¯ÏƒÏ„Î·ÎºÎµ ÏƒÏ„Î¿ index.</div>'; return; }

    host.innerHTML = '<div class="muted">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>';
    fetch(WEBAPP_URL + '?action=listUploaded&sr=' + encodeURIComponent(srName) + '&t=' + Date.now())
      .then(function(r){ return r.json(); })
      .then(function(j){
        if(!j || j.ok===false){
          throw new Error((j && j.error) || "listUploaded failed");
        }
        var items = j.items || j.files || [];
        if(!items.length){
          host.innerHTML = '<div class="muted">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± Î³Î¹Î± "'+srName+'".</div>';
          return;
        }
        function tokenOf(n){
          var base = String(n||'').toLowerCase()
            .replace(/\.(jpg|jpeg|png|mp4|pdf|xls|xlsx)$/i,'')
            .replace(/\s+/g,'')
            .replace(/\.p\d{2}$/i,'');
          return base;
        }
        var byTok = items.reduce(function(acc, f){
          var t = tokenOf(f.name||"");
          (acc[t] = acc[t] || []).push(f);
          return acc;
        }, Object.create(null));

        var tokens = Object.keys(byTok).sort(function(a,b){ return a.localeCompare(b,'el'); });

        var out = [];
        out.push('<div class="muted" style="margin:6px 0">Î£ÏÎ½Î¿Î»Î¿: '+items.length+' Î±ÏÏ‡ÎµÎ¯Î± â€¢ Î’Î®Î¼Î±Ï„Î±: '+tokens.length+'</div>');
        tokens.forEach(function(tok){
          var arr = byTok[tok].slice().sort(function(a,b){ return String(a.name).localeCompare(String(b.name),'el'); });
          out.push('<div class="item" style="padding:10px;border:1px solid #e5e7eb;border-radius:10px;margin:8px 0">');
          out.push('<div style="display:flex;justify-content:space-between;align-items:center">');
          out.push('<div style="font-weight:900">'+tok+'</div>');
          out.push('<div class="badge">'+arr.length+' Î±ÏÏ‡ÎµÎ¯Î±</div>');
          out.push('</div>');
          out.push('<div class="muted" style="font-size:11px;margin-top:6px">');
          out.push(arr.map(function(f){ return 'â€¢ '+f.name+' â€” '+humanSize(f.size||0); }).join('<br>'));
          out.push('</div>');
          out.push('</div>');
        });

        host.innerHTML = out.join('');
      })
      .catch(function(err){
        host.innerHTML = '<div class="muted">Î£Ï†Î¬Î»Î¼Î± ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼Î¿Ï: '+(err && err.message || err)+'</div>';
      });
  }

  window.renderSyncList = window.renderSyncList || renderSyncList;

  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btnSyncRefresh') || document.querySelector('[data-sync-refresh]');
    if(btn){
      btn.addEventListener('click', function(){
        var sr = getCurrentSRName();
        renderSyncList(sr, '#syncResults');
      });
    }
    window.addEventListener('hashchange', function(){
      var h = location.hash||'';
      if (h === '#/sync' || h.indexOf('/sync')>-1){
        var sr = getCurrentSRName();
        renderSyncList(sr, '#syncResults');
      }
    });
    var h0 = location.hash||'';
    if (h0 === '#/sync' || h0.indexOf('/sync')>-1){
      var sr0 = getCurrentSRName();
      renderSyncList(sr0, '#syncResults');
    }
  });
})();
</script>
<script>
// Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· preview ÏƒÏ„Î¿Î½ ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒ
function addPreviewToSync() {
  const syncList = document.getElementById('syncList');
  if (!syncList) return;
  
  // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ event delegation Î³Î¹Î± Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î­Î½Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±
  syncList.addEventListener('click', function(e) {
    // Î¨Î¬Ï‡Î½Î¿Ï…Î¼Îµ Î³Î¹Î± preview links
    if (e.target.classList.contains('preview-link') || 
        e.target.closest('.preview-link')) {
      e.preventDefault();
      const fileId = e.target.dataset.fileId || e.target.closest('.preview-link').dataset.fileId;
      if (fileId) {
        window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
      }
    }
  });
}

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î·Ï‚ refreshSync Î³Î¹Î± preview
const originalRefreshSync = window.refreshSync;
if (originalRefreshSync) {
  window.refreshSync = function() {
    originalRefreshSync();
    // ÎšÎ¬Î»ÎµÏƒÎµ Ï„Î·Î½ preview function Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ Î¼Î¹ÎºÏÎ® ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ·
    setTimeout(addPreviewToSync, 100);
  };
}

// Î‘ÏÏ‡Î¹ÎºÎ® ÎºÎ»Î®ÏƒÎ·
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(addPreviewToSync, 500);
});

// Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±Î¹ ÏƒÏ„Î¿Î½ renderSyncList
const originalRenderSyncList = window.renderSyncList;
if (originalRenderSyncList) {
  window.renderSyncList = function(srName, selector) {
    const result = originalRenderSyncList(srName, selector);
    setTimeout(addPreviewToSync, 100);
    return result;
  };
}
</script>
</body>
</html>
